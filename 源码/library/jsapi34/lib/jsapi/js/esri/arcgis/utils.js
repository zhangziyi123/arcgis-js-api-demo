/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
require({cache:{"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel"],function(_1,_2,_3,_4){var _5=_1(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(_6){if(_6&&_2.isObject(_6)){this.objectId=_6.objectId;this.success=_6.success;if(!_6.success){var _7=_6.error;this.error=new Error();this.error.code=_7.code;this.error.message=_7.description;}}}});if(_3("extend-esri")){_2.setObject("layers.FeatureEditResult",_5,_4);}return _5;});},"esri/layers/MapImageLayer":function(){define(["dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojo/dom-style","esri/kernel","esri/config","esri/sniff","esri/domUtils","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/layers/layer"],function(_8,_9,_a,_b,_c,_d,_e,_f,has,_10,_11,_12,_13){var _14=_8([_13],{declaredClass:"esri.layers.MapImageLayer","-chains-":{constructor:"manual"},constructor:function(_15){this.inherited(arguments,[null,_15]);this._mapImages=[];var _16=_a.hitch;this._panStart=_16(this,this._panStart);this._pan=_16(this,this._pan);this._extentChange=_16(this,this._extentChange);this._zoom=_16(this,this._zoom);this._zoomStart=_16(this,this._zoomStart);this._scale=_16(this,this._scale);this._resize=_16(this,this._resize);_9.connect(this,"onSuspend",this,this._onSuspend);_9.connect(this,"onResume",this,this._onResume);this.loaded=true;this.onLoad(this);},opacity:1,_transform:_e._getDOMAccessor("transform"),addImage:function(_17){var _18=this._mapImages.push(_17);_18=_18-1;_17._idx=_18;_17._layer=this;if(this._div){this._createImage(_17,_18);}},removeImage:function(_19){if(_19){var idx=_19._idx,_1a=this._mapImages;if(_1a[idx]===_19){delete _1a[idx];var _1b=_19._node;if(_1b){this._clearEvents(_1b);_1b.e_idx=_1b.e_bl=_1b.e_tr=_1b.e_l=_1b.e_t=_1b.e_w=_1b.e_h=null;if(_1b.parentNode){_1b.parentNode.removeChild(_1b);_c.destroy(_1b);}}_19._node=_19._idx=_19._layer=null;}}},removeAllImages:function(){var _1c=this._mapImages,i,len=_1c.length;for(i=0;i<len;i++){var _1d=_1c[i];if(_1d){this.removeImage(_1d);}}this._mapImages=[];},getImages:function(){var _1e=this._mapImages,_1f=[],i,len=_1e.length;for(i=0;i<len;i++){if(_1e[i]){_1f.push(_1e[i]);}}return _1f;},setOpacity:function(_20){if(this.opacity!=_20){this._opacityChanged(this.opacity=_20);this.onOpacityChange();}},onOpacityChange:function(){},_opacityChanged:function(_21){var div=this._div,i,len,_22;if(div){if(!has("ie")||has("ie")>8){_d.set(div,"opacity",_21);}else{_22=div.childNodes;len=_22.length;for(i=0;i<len;i++){_d.set(_22[i],"opacity",_21);}}}},_createImage:function(_23,idx){var _24=_c.create("img");_d.set(_24,{position:"absolute"});if(has("ie")<=8){_d.set(_24,"opacity",this.opacity);}if(_23.rotation){var _25="rotate("+(360-_23.rotation)+"deg)";if(has("ie")<9){}else{_d.set(_24,this._transform,_25);_d.set(_24,"transform",_25);}}_23._node=_24;_24.e_idx=idx;_24.e_layer=this;_24.e_load=_9.connect(_24,"onload",_14.prototype._imageLoaded);_24.e_error=_9.connect(_24,"onerror",_14.prototype._imageError);_24.e_abort=_9.connect(_24,"onabort",_14.prototype._imageError);_24.src=_23.href;},_imageLoaded:function(evt,img){var _26=img||evt.target||evt.currentTarget,_27=_26.e_layer,_28=_27._mapImages[_26.e_idx],map=_27._map;if(map&&(map.__zooming||map.__panning||!_27._sr)){_27._standby.push(_26);return;}_27._clearEvents(_26);if(!_28||_28._node!==_26){return;}if(map){_27._attach(_28);}},_imageError:function(evt){var _29=evt.target||evt.currentTarget,_2a=_29.e_layer,_2b=_2a._mapImages[_29.e_idx];_2a._clearEvents(_29);if(_2b){_2b._node=null;}},_clearEvents:function(_2c){var _2d=_9.disconnect;_2d(_2c.e_load);_2d(_2c.e_error);_2d(_2c.e_abort);_2c.e_load=_2c.e_error=_2c.e_abort=_2c.e_layer=null;},_attach:function(_2e){var _2f=_2e.extent,_30=_2f.spatialReference,_31=this._sr,div=this._div,_32=_2e._node,_33=new _11({x:_2f.xmin,y:_2f.ymin,spatialReference:_30}),_34=new _11({x:_2f.xmax,y:_2f.ymax,spatialReference:_30});if(!_31.equals(_30)){if(_31.isWebMercator()&&_30.wkid===4326){_33=_12.geographicToWebMercator(_33);_34=_12.geographicToWebMercator(_34);}else{if(_30.isWebMercator()&&_31.wkid===4326){_33=_12.webMercatorToGeographic(_33);_34=_12.webMercatorToGeographic(_34);}}}_32.e_bl=_33;_32.e_tr=_34;if(_2e.visible){this._setPos(_32,div._left,div._top);(this._active||div).appendChild(_32);}},_setPos:function(_35,_36,_37){var _38=_35.e_bl,_39=_35.e_tr,map=this._map;_38=map.toScreen(_38);_39=map.toScreen(_39);var _3a=_38.x-_36,top=_39.y-_37,_3b=Math.abs(_39.x-_38.x),_3c=Math.abs(_38.y-_39.y),css={width:_3b+"px",height:_3c+"px"},_3d=this._mapImages[_35.e_idx];if(map.navigationMode==="css-transforms"){css[_e._css.names.transform]=_e._css.translate(_3a,top)+(_3d.rotation?(" "+_e._css.rotate(360-_3d.rotation)):"");}else{css.left=_3a+"px";css.top=top+"px";}_d.set(_35,css);_35.e_l=_3a;_35.e_t=top;_35.e_w=_3b;_35.e_h=_3c;},managedSuspension:true,_setMap:function(map,_3e){this.inherited(arguments);var div=this._div=_c.create("div",null,_3e),_3f=_e._css.names,css={position:"absolute"},vd=map.__visibleDelta;if(!has("ie")||has("ie")>8){css.opacity=this.opacity;}if(map.navigationMode==="css-transforms"){css[_3f.transform]=_e._css.translate(vd.x,vd.y);_d.set(div,css);div._left=vd.x;div._top=vd.y;css={position:"absolute",width:map.width+"px",height:map.height+"px",overflow:"visible"};this._active=_c.create("div",null,div);_d.set(this._active,css);this._passive=_c.create("div",null,div);_d.set(this._passive,css);}else{div._left=0;div._top=0;_d.set(div,css);}this._standby=[];var _40=this._mapImages,i,len=_40.length;for(i=0;i<len;i++){var _41=_40[i],_42=_41._node;if(!_42){this._createImage(_41,_41._idx);}}_10.hide(div);return div;},_unsetMap:function(map,_43){this._disconnect();var div=this._div;if(div){var _44=this._mapImages,i,len=_44.length;for(i=0;i<len;i++){var _45=_44[i];if(_45){var _46=_45._node;if(_46){this._clearEvents(_46);_46.e_idx=_46.e_bl=_46.e_tr=_46.e_l=_46.e_t=_46.e_w=_46.e_h=null;}_45._node=null;}}_43.removeChild(div);_c.destroy(div);}this._map=this._div=this._sr=this._active=this._passive=this._standby=null;this.inherited(arguments);},_onSuspend:function(){this._disconnect();_10.hide(this._div);},_onResume:function(evt){if(evt.firstOccurrence){this._sr=this._map.spatialReference;this._processStandbyList();}var map=this._map,div=this._div,vd=map.__visibleDelta;if(map.navigationMode==="css-transforms"){div._left=vd.x;div._top=vd.y;_d.set(div,_e._css.names.transform,_e._css.translate(div._left,div._top));}this._redraw(map.navigationMode==="css-transforms");this._connect(map);_10.show(div);},_connect:function(map){if(!this._connections){var _47=_9.connect,_48=(map.navigationMode==="css-transforms");this._connections=[_47(map,"onPanStart",this._panStart),_47(map,"onPan",this._pan),_47(map,"onExtentChange",this._extentChange),_48&&_47(map,"onZoomStart",this._zoomStart),_48?_47(map,"onScale",this._scale):_47(map,"onZoom",this._zoom),_48&&_47(map,"onResize",this._resize)];}},_disconnect:function(){if(this._connections){_b.forEach(this._connections,_9.disconnect);this._connections=null;}},_panStart:function(){this._panL=this._div._left;this._panT=this._div._top;},_pan:function(_49,_4a){var div=this._div;div._left=this._panL+_4a.x;div._top=this._panT+_4a.y;if(this._map.navigationMode==="css-transforms"){_d.set(div,_e._css.names.transform,_e._css.translate(div._left,div._top));}else{_d.set(div,{left:div._left+"px",top:div._top+"px"});}},_extentChange:function(_4b,_4c,_4d){if(_4d){this._redraw(this._map.navigationMode==="css-transforms");}else{if(_4c){this._pan(_4b,_4c);}}this._processStandbyList();},_processStandbyList:function(){var i,_4e=this._standby;if(_4e&&_4e.length){for(i=_4e.length-1;i>=0;i--){this._imageLoaded(null,_4e[i]);_4e.splice(i,1);}}},_redraw:function(_4f){if(_4f){var _50=this._passive,_51=_e._css.names;_d.set(_50,_51.transition,"none");this._moveImages(_50,this._active);_d.set(_50,_51.transform,"none");}var div=this._active||this._div,_52=this._div._left,_53=this._div._top,i,len=div.childNodes.length,_54;for(i=0;i<len;i++){_54=div.childNodes[i];this._setPos(_54,_52,_53);}},_zoom:function(_55,_56,_57){var div=this._div,_58=div._left,_59=div._top,i,len=div.childNodes.length,_5a;for(i=0;i<len;i++){_5a=div.childNodes[i];var _5b=_5a.e_w*_56,_5c=_5a.e_h*_56,_5d=(_57.x-_58-_5a.e_l)*(_5b-_5a.e_w)/_5a.e_w,_5e=(_57.y-_59-_5a.e_t)*(_5c-_5a.e_h)/_5a.e_h;_5d=isNaN(_5d)?0:_5d;_5e=isNaN(_5e)?0:_5e;_d.set(_5a,{left:(_5a.e_l-_5d)+"px",top:(_5a.e_t-_5e)+"px",width:_5b+"px",height:_5c+"px"});}},_zoomStart:function(){this._moveImages(this._active,this._passive);},_moveImages:function(_5f,_60){var _61=_5f.childNodes,i,len=_61.length;if(len>0){for(i=len-1;i>=0;i--){_60.appendChild(_61[i]);}}},_scale:function(mtx,_62){var css={},_63=_e._css.names,_64=this._passive;_d.set(_64,_63.transition,_62?"none":(_63.transformName+" "+_f.defaults.map.zoomDuration+"ms ease"));css[_63.transform]=_e._css.matrix(mtx);_d.set(_64,_63.transform,_e._css.matrix(mtx));},_resize:function(_65,_66,_67){_d.set(this._active,{width:_66+"px",height:_67+"px"});_d.set(this._passive,{width:_66+"px",height:_67+"px"});}});if(has("extend-esri")){_a.setObject("layers.MapImageLayer",_14,_e);}return _14;});},"esri/layers/WebTiledLayer":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/url","dojo/has","dojo/string","esri/kernel","esri/urlUtils","esri/SpatialReference","esri/geometry/Extent","esri/layers/TiledMapServiceLayer","esri/layers/TileInfo"],function(_68,_69,_6a,Url,has,_6b,_6c,_6d,_6e,_6f,_70,_71){var _72=_68(_70,{declaredClass:"esri.layers.WebTiledLayer",constructor:function(_73,_74){if(!_74){_74={};}this.urlTemplate=_73;var _75=new _6f(-20037508.342787,-20037508.34278,20037508.34278,20037508.342787,new _6e({wkid:102100}));var _76=new _6f(-20037508.342787,-20037508.34278,20037508.34278,20037508.342787,new _6e({wkid:102100}));this.initialExtent=_74.initialExtent||_75;this.fullExtent=_74.fullExtent||_76;if(_74.tileInfo){this.tileInfo=_74.tileInfo;}else{var _77=[{"level":0,"resolution":156543.033928,"scale":591657527.591555},{"level":1,"resolution":78271.5169639999,"scale":295828763.795777},{"level":2,"resolution":39135.7584820001,"scale":147914381.897889},{"level":3,"resolution":19567.8792409999,"scale":73957190.948944},{"level":4,"resolution":9783.93962049996,"scale":36978595.474472},{"level":5,"resolution":4891.96981024998,"scale":18489297.737236},{"level":6,"resolution":2445.98490512499,"scale":9244648.868618},{"level":7,"resolution":1222.99245256249,"scale":4622324.434309},{"level":8,"resolution":611.49622628138,"scale":2311162.217155},{"level":9,"resolution":305.748113140558,"scale":1155581.108577},{"level":10,"resolution":152.874056570411,"scale":577790.554289},{"level":11,"resolution":76.4370282850732,"scale":288895.277144},{"level":12,"resolution":38.2185141425366,"scale":144447.638572},{"level":13,"resolution":19.1092570712683,"scale":72223.819286},{"level":14,"resolution":9.55462853563415,"scale":36111.909643},{"level":15,"resolution":4.77731426794937,"scale":18055.954822},{"level":16,"resolution":2.38865713397468,"scale":9027.977411},{"level":17,"resolution":1.19432856685505,"scale":4513.988705},{"level":18,"resolution":0.597164283559817,"scale":2256.994353},{"level":19,"resolution":0.298582141647617,"scale":1128.497176}];var _78=new _71({"rows":256,"cols":256,"origin":{"x":-20037508.342787,"y":20037508.342787},"spatialReference":{"wkid":102100},"lods":_77});this.tileInfo=_78;}this.spatialReference=new _6e(this.tileInfo.spatialReference.toJson());this.copyright=_74.copyright||"";var url=new Url(_73);var _79=url.scheme+"://"+url.authority+"/";this.urlPath=_73.substring(_79.length);this.tileServers=_74.tileServers||[];if(url.authority.indexOf("{subDomain}")===-1){this.tileServers.push(_79);}if(_74.subDomains&&_74.subDomains.length>0&&url.authority.split(".").length>1){this.subDomains=_74.subDomains;var _7a;_6a.forEach(_74.subDomains,function(_7b,idx){if(url.authority.indexOf("${subDomain}")>-1){_7a=url.scheme+"://"+_6b.substitute(url.authority,{subDomain:_7b})+"/";}else{if(url.authority.indexOf("{subDomain}")>-1){_7a=url.scheme+"://"+url.authority.replace(/\{subDomain\}/gi,_7b)+"/";}}this.tileServers.push(_7a);},this);}this.tileServers=_6a.map(this.tileServers,function(_7c){if(_7c.charAt(_7c.length-1)!=="/"){_7c+="/";}return _7c;});this._levelToLevelValue=[];_6a.forEach(this.tileInfo.lods,function(_7d){this._levelToLevelValue[_7d.level]=_7d.levelValue?_7d.levelValue:_7d.level;},this);this.loaded=true;this.onLoad(this);},getTileUrl:function(_7e,row,col){_7e=this._levelToLevelValue[_7e];var _7f=this.tileServers[row%this.tileServers.length];var _80=_7f+_6b.substitute(this.urlPath,{level:_7e,col:col,row:row});_80=_80.replace(/\{level\}/gi,_7e);_80=_80.replace(/\{row\}/gi,row);_80=_80.replace(/\{col\}/gi,col);return _6d.addProxy(_80);}});if(has("extend-esri")){_69.setObject("layers.WebTiledLayer",_72,_6c);}return _72;});},"esri/layers/ServiceGeneratedFeatureCollection":function(){define(["dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojo/dom-style","dojo/has","esri/kernel","esri/SpatialReference","esri/geometry/Extent","esri/geometry/webMercatorUtils","esri/renderers/SimpleRenderer","esri/layers/layer","esri/layers/FeatureLayer","esri/dijit/PopupTemplate"],function(_81,_82,_83,_84,_85,_86,has,_87,_88,_89,_8a,_8b,_8c,_8d,_8e){var _8f=_81([_8c],{declaredClass:"esri.layers._ServiceGeneratedFeatureCollection",constructor:function(url,_90){this.pointSymbol=_90&&_90.pointSymbol;this.polylineSymbol=_90&&_90.polylineSymbol;this.polygonSymbol=_90&&_90.polygonSymbol;this._outSR=(_90&&(_90.outSpatialReference||_90.outSR))||new _88({wkid:4326});this._options=_90;},parse:function(){console.error("parse function has not been implemented");},getFeatureLayers:function(){var _91=[];if(this._fLayers){_91=_91.concat(this._fLayers);}return _91;},onRefresh:function(){},refresh:function(){if(!this.loaded||!this._map||this._io){return;}this._createLayer();},_createLayer:function(_92){var _93=this;this._fireUpdateStart();var _94=this.parse(_92);_94.addCallback(function(_95){_93._io=null;_93._initLayer(_95);});_94.addErrback(function(err){_93._io=null;err=_83.mixin(new Error(),err);err.message="Unable to load resource: "+_93.url+" "+(err.message||"");_93._fireUpdateEnd(err);_93.onError(err);});},_initLayer:function(_96){if(this.loaded){this._removeInternalLayers();}this.name=_96.name;this.description=_96.description;this.snippet=_96.snippet;if(_96.visibility!==undefined){this.defaultVisibility=this.visible=!!_96.visibility;}else{this.defaultVisibility=this.visible=true;}this.featureInfos=_96.featureInfos;this.fullExtent=this.initialExtent=new _89(_96.lookAtExtent);this.copyright=_96.author||_96.copyright;var _97;var _98=_83.getObject("featureCollection.layers",false,_96);if(_98&&_98.length>0){this._fLayers=[];_84.forEach(_98,function(_99,i){var _9a=_83.getObject("featureSet.features",false,_99),_9b;if(_9a&&_9a.length>0){_97=_83.mixin({outFields:["*"],infoTemplate:_99.popupInfo?new _8e(_99.popupInfo):null,editable:false},this._options);if(_97.id){_97.id=_97.id+"_"+i;}_99.layerDefinition.capabilities="Query,Data";_9b=new _8d(_99,_97);if(_9b.geometryType){this["_"+_9b.geometryType]=_9b;}this._fLayers.push(_9b);}},this);if(this._fLayers.length===0){delete this._fLayers;}}this.items=[];if(this._esriGeometryPoint){this.items=this.items.concat(this._esriGeometryPoint.graphics);if(this.pointSymbol){var _9c=new _8b(this.pointSymbol);this._esriGeometryPoint.setRenderer(_9c);}}if(this._esriGeometryPolyline){this.items=this.items.concat(this._esriGeometryPolyline.graphics);if(this.polylineSymbol){var _9d=new _8b(this.polylineSymbol);this._esriGeometryPolyline.setRenderer(_9d);}}if(this._esriGeometryPolygon){this.items=this.items.concat(this._esriGeometryPolygon.graphics);if(this.polygonSymbol){var _9e=new _8b(this.polygonSymbol);this._esriGeometryPolygon.setRenderer(_9e);}}this._fireUpdateEnd();if(this.loaded){this._addInternalLayers();this.onRefresh();}},_addInternalLayers:function(){var map=this._map;this._fireUpdateStart();var _9f=map.spatialReference,_a0=this._outSR,_a1;if(_9f.wkid){_a1=(_9f._isWebMercator()&&_a0._isWebMercator())||(_9f.wkid===_a0.wkid);}else{if(_9f.wkt){_a1=(_9f.wkt===_a0.wkt);}else{console.log("_setMap - map has invalid spatial reference");return;}}if(!_a1){if(_9f._isWebMercator()&&_a0.wkid===4326){this._converter=_8a.geographicToWebMercator;}else{if(_a0._isWebMercator()&&_9f.wkid===4326){this._converter=_8a.webMercatorToGeographic;}else{console.log("_setMap - unsupported workflow. Spatial reference of the map and layer do not match, and the conversion cannot be done on the client.");return;}}}var _a2=this._fLayers;if(_a2&&_a2.length>0){_84.forEach(_a2,function(_a3){if(this._converter){var _a4=_a3.graphics,i,_a5,len=_a4?_a4.length:0;for(i=0;i<len;i++){_a5=_a4[i].geometry;if(_a5){_a4[i].setGeometry(this._converter(_a5));}}}map.addLayer(_a3);},this);}this.setVisibility(this.visible);},_removeInternalLayers:function(){var map=this._map;if(map){_84.forEach(this.getFeatureLayers(),map.removeLayer,map);}},onVisibilityChange:function(_a6){this._fireUpdateStart();_84.forEach(this.getFeatureLayers(),function(_a7){_a7.setVisibility(_a6);});this._fireUpdateEnd();},_setMap:function(map,_a8){this.inherited(arguments);this._map=map;var div=this._div=_85.create("div",null,_a8);_86.set(div,"position","absolute");this._addInternalLayers();this.evaluateSuspension();return div;},_unsetMap:function(map,_a9){if(this._io){this._io.cancel();}_82.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var div=this._div;if(div){_a9.removeChild(div);_85.destroy(div);}this._div=null;this.inherited(arguments);}});if(has("extend-esri")){_83.setObject("layers._ServiceGeneratedFeatureCollection",_8f,_87);}return _8f;});},"esri/layers/KMLGroundOverlay":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","esri/lang","esri/layers/MapImage"],function(_aa,_ab,has,_ac,_ad,_ae){var _af=_aa([_ae],{declaredClass:"esri.layers.KMLGroundOverlay",constructor:function(_b0){if(_ad.isDefined(this.visibility)){this.visible=!!this.visibility;}}});if(has("extend-esri")){_ab.setObject("layers.KMLGroundOverlay",_af,_ac);}return _af;});},"dojo/data/util/simpleFetch":function(){define(["../../_base/lang","../../_base/kernel","./sorter"],function(_b1,_b2,_b3){var _b4={};_b1.setObject("dojo.data.util.simpleFetch",_b4);_b4.errorHandler=function(_b5,_b6){if(_b6.onError){var _b7=_b6.scope||_b2.global;_b6.onError.call(_b7,_b5,_b6);}};_b4.fetchHandler=function(_b8,_b9){var _ba=_b9.abort||null,_bb=false,_bc=_b9.start?_b9.start:0,_bd=(_b9.count&&(_b9.count!==Infinity))?(_bc+_b9.count):_b8.length;_b9.abort=function(){_bb=true;if(_ba){_ba.call(_b9);}};var _be=_b9.scope||_b2.global;if(!_b9.store){_b9.store=this;}if(_b9.onBegin){_b9.onBegin.call(_be,_b8.length,_b9);}if(_b9.sort){_b8.sort(_b3.createSortFunction(_b9.sort,this));}if(_b9.onItem){for(var i=_bc;(i<_b8.length)&&(i<_bd);++i){var _bf=_b8[i];if(!_bb){_b9.onItem.call(_be,_bf,_b9);}}}if(_b9.onComplete&&!_bb){var _c0=null;if(!_b9.onItem){_c0=_b8.slice(_bc,_bd);}_b9.onComplete.call(_be,_c0,_b9);}};_b4.fetch=function(_c1){_c1=_c1||{};if(!_c1.store){_c1.store=this;}this._fetchItems(_c1,_b1.hitch(this,"fetchHandler"),_b1.hitch(this,"errorHandler"));return _c1;};return _b4;});},"esri/layers/KMLLayer":function(){define(["dojo/_base/kernel","dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/sniff","dojo/io-query","dojo/dom-construct","dojo/dom-style","esri/kernel","esri/config","esri/lang","esri/request","esri/SpatialReference","esri/geometry/webMercatorUtils","esri/dijit/PopupTemplate","esri/layers/layer","esri/layers/KMLFolder","esri/layers/KMLGroundOverlay","esri/layers/MapImageLayer","esri/layers/FeatureLayer"],function(_c2,_c3,_c4,_c5,_c6,_c7,has,ioq,_c8,_c9,_ca,_cb,_cc,_cd,_ce,_cf,_d0,_d1,_d2,_d3,_d4,_d5){var _d6=_c3([_d1],{declaredClass:"esri.layers.KMLLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/kml",constructor:function(url,_d7){if(!url){console.log("KMLLayer:constructor - please provide url for the KML file");}this._outSR=(_d7&&_d7.outSR)||new _ce({wkid:4326});this._options=_d7;if(_cb.defaults.kmlService){this.serviceUrl=_cb.defaults.kmlService;}var _d8=(this.linkInfo=_d7&&_d7.linkInfo);if(_d8){this.visible=!!_d8.visibility;this._waitingForMap=!!_d8.viewFormat;}if(!_d8||(_d8&&_d8.visibility&&!this._waitingForMap)){this._parseKml();}this.refresh=_c5.hitch(this,this.refresh);},getFeature:function(_d9){if(!_d9){return;}var _da=_d9.type,id=_d9.id,_db,i,len;switch(_da){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryPolygon":var _dc=this["_"+_da];if(_dc){_db=_c5.getObject("_mode._featureMap."+id,false,_dc);}break;case "GroundOverlay":var _dd=this._groundLyr;if(_dd){var _de=_dd.getImages();len=_de.length;for(i=0;i<len;i++){if(_de[i].id===id){_db=_de[i];break;}}}break;case "ScreenOverlay":break;case "NetworkLink":_c6.some(this._links,function(_df){if(_df.linkInfo&&_df.linkInfo.id===id){_db=_df;return true;}else{return false;}});break;case "Folder":var _e0=this.folders;len=_e0?_e0.length:0;for(i=0;i<len;i++){if(_e0[i].id===id){_db=_e0[i];break;}}break;default:console.log("KMLLayer:getFeature - unknown feature type");break;}return _db;},getLayers:function(){var _e1=[];if(this._groundLyr){_e1.push(this._groundLyr);}if(this._fLayers){_e1=_e1.concat(this._fLayers);}if(this._links){_c6.forEach(this._links,function(_e2){if(_e2.declaredClass){_e1.push(_e2);}});}return _e1;},setFolderVisibility:function(_e3,_e4){if(!_e3){return;}this._fireUpdateStart();_e3.visible=_e4;if(_e4){_e4=this._areLocalAncestorsVisible(_e3);}this._setState(_e3,_e4);this._fireUpdateEnd();},onRefresh:function(){},_parseKml:function(map){var _e5=this;this._fireUpdateStart();this._io=_cd({url:this.serviceUrl,content:{url:this._url.path+this._getQueryParameters(map),model:"simple",folders:"",refresh:this.loaded?true:undefined,outSR:_c7.toJson(this._outSR.toJson())},callbackParamName:"callback",load:function(_e6){_e5._io=null;_e5._initLayer(_e6);},error:function(err){_e5._io=null;err=_c5.mixin(new Error(),err);err.message="Unable to load KML: "+_e5.url+" "+(err.message||"");_e5._fireUpdateEnd(err);_e5.onError(err);}});},_initLayer:function(_e7){if(this.loaded){this._removeInternalLayers();}this.name=_e7.name;this.description=_e7.description;this.snippet=_e7.snippet;this.visibility=_e7.visibility;this.featureInfos=_e7.featureInfos;var i,len;var _e8=(this.folders=_e7.folders),_e9=[],_ea;if(_e8){len=_e8.length;for(i=0;i<len;i++){_ea=(_e8[i]=new _d2(_e8[i]));if(_ea.parentFolderId===-1){_e9.push(_ea);}}}var _eb=(this._links=_e7.networkLinks),_ec;len=_eb?_eb.length:0;for(i=0;i<len;i++){if(_eb[i].viewRefreshMode&&_eb[i].viewRefreshMode.toLowerCase().indexOf("onregion")!==-1){continue;}_ec=_c5.mixin({},this._options);_ec.linkInfo=_eb[i];if(_ec.id){_ec.id=_ec.id+"_"+i;}_eb[i]=new _d6(_eb[i].href,_ec);_eb[i]._parentLayer=this;_eb[i]._parentFolderId=this._getLinkParentId(_eb[i].linkInfo.id);}var _ed=_e7.groundOverlays;if(_ed&&_ed.length>0){_ec=_c5.mixin({},this._options);if(_ec.id){_ec.id=_ec.id+"_"+"mapImage";}var _ee=(this._groundLyr=new _d4(_ec));len=_ed.length;for(i=0;i<len;i++){_ee.addImage(new _d3(_ed[i]));}}var _ef=_c5.getObject("featureCollection.layers",false,_e7);if(_ef&&_ef.length>0){this._fLayers=[];_c6.forEach(_ef,function(_f0,i){var _f1=_c5.getObject("featureSet.features",false,_f0),_f2;if(_f1&&_f1.length>0){_ec=_c5.mixin({outFields:["*"],infoTemplate:_f0.popupInfo?new _d0(_f0.popupInfo):null,editable:false},this._options);if(_ec.id){_ec.id=_ec.id+"_"+i;}_f0.layerDefinition.capabilities="Query,Data";_f2=new _d5(_f0,_ec);if(_f2.geometryType){this["_"+_f2.geometryType]=_f2;}this._fLayers.push(_f2);}},this);if(this._fLayers.length===0){delete this._fLayers;}}len=_e9.length;for(i=0;i<len;i++){_ea=_e9[i];this._setState(_ea,_ea.visible);}this._fireUpdateEnd();if(this.loaded){this._addInternalLayers();this.onRefresh();}else{this.loaded=true;this.onLoad(this);}},_addInternalLayers:function(){var map=this._map;this._fireUpdateStart();if(this._links){_c6.forEach(this._links,function(_f3){if(_f3.declaredClass){map.addLayer(_f3);if(_f3._waitingForMap){_f3._waitingForMap=null;if(_f3.visible){_f3._parseKml(map);}else{_f3._wMap=map;}}}});}var _f4=map.spatialReference,_f5=this._outSR,_f6;if(!_f4.equals(_f5)){if(_f4.isWebMercator()&&_f5.wkid===4326){_f6=_cf.geographicToWebMercator;}else{if(_f5.isWebMercator()&&_f4.wkid===4326){_f6=_cf.webMercatorToGeographic;}else{console.log("KMLLayer:_setMap - unsupported workflow. Spatial reference of the map and kml layer do not match, and the conversion cannot be done on the client.");return;}}}if(this._groundLyr){if(_f6){_c6.forEach(this._groundLyr.getImages(),function(_f7){_f7.extent=_f6(_f7.extent);});}map.addLayer(this._groundLyr);}var _f8=this._fLayers;if(_f8&&_f8.length>0){_c6.forEach(_f8,function(_f9){if(_f6){var _fa=_f9.graphics,i,_fb,len=_fa?_fa.length:0;for(i=0;i<len;i++){_fb=_fa[i].geometry;if(_fb){_fa[i].setGeometry(_f6(_fb));}}}map.addLayer(_f9);});}this.onVisibilityChange(this.visible);},_removeInternalLayers:function(){var map=this._map;if(this._links){_c6.forEach(this._links,function(_fc){if(_fc.declaredClass&&_fc._io){_fc._io.cancel();}});}if(map){_c6.forEach(this.getLayers(),map.removeLayer,map);}},_setState:function(_fd,_fe){var _ff=_fd.featureInfos,info,_100,i,len=_ff?_ff.length:0,_101=_fe?"show":"hide";for(i=0;i<len;i++){info=_ff[i];_100=this.getFeature(info);if(!_100){continue;}if(info.type==="Folder"){this._setState(_100,_fe&&_100.visible);}else{if(info.type==="NetworkLink"){this._setInternalVisibility(_100,_fe);}else{_100[_101]();}}}},_areLocalAncestorsVisible:function(_102){var _103=_102.parentFolderId,_104=_102.visible;while(_104&&_103!==-1){var _105=this.getFeature({type:"Folder",id:_103});_104=_104&&_105.visible;_103=_105.parentFolderId;}return _104;},_setInternalVisibility:function(_106,_107){var _108=_106._parentLayer,_109=_106._parentFolderId;_107=_107&&_106.visible;while(_107&&_108){_107=_107&&_108.visible;if(_109>-1){_107=_107&&_108._areLocalAncestorsVisible(_108.getFeature({type:"Folder",id:_109}));}_109=_108._parentFolderId;_108=_108._parentLayer;}this._setIntState(_106,_107);},_setIntState:function(link,_10a){if(!link){return;}_c6.forEach(link.getLayers(),function(_10b){if(_10b.linkInfo){link._setIntState(_10b,_10a&&_10b.visible&&link._areLocalAncestorsVisible(link.getFeature({type:"Folder",id:_10b._parentFolderId})));}else{_10b.setVisibility(_10a);}});},_getLinkParentId:function(id){var _10c=-1;if(this.folders){_c6.some(this.folders,function(_10d){if(_10d.networkLinkIds&&_c6.indexOf(_10d.networkLinkIds,id)!==-1){_10c=_10d.id;return true;}return false;});}return _10c;},_checkAutoRefresh:function(){var _10e=this.linkInfo;if(_10e){if(this.visible){if(this.loaded&&this._map){var _10f=_10e.refreshMode,_110=_10e.refreshInterval,_111=_10e.viewRefreshMode,_112=_10e.viewRefreshTime;if(_10f&&_10f.toLowerCase().indexOf("oninterval")!==-1&&_110>0){this._stopAutoRefresh();this._timeoutHandle=setTimeout(this.refresh,_110*1000);}if(_111&&_111.toLowerCase().indexOf("onstop")!==-1&&_112>0){if(!this._extChgHandle){this._extChgHandle=_c4.connect(this._map,"onExtentChange",this,this._extentChanged);}}}}else{this._stopAutoRefresh();_c4.disconnect(this._extChgHandle);delete this._extChgHandle;}}},_stopAutoRefresh:function(){clearTimeout(this._timeoutHandle);this._timeoutHandle=null;},_getQueryParameters:function(map){map=map||this._map;var _113={},_114=this.linkInfo,_115=map&&map.extent,_116;if(this._url.query){_c5.mixin(_113,this._url.query);_116=!!this._url.query.token;}if(_ca.id&&!_116){var _117=_ca.id.findCredential(this._url.path);if(_117){_113.token=_117.token;}}if(_114){var _118=_114.viewFormat,_119=_114.httpQuery,_11a=_114.viewBoundScale;if(_115&&_118){var _11b=_115,_11c=_115,sr=_115.spatialReference;if(sr){if(sr.isWebMercator()){_11b=_cf.webMercatorToGeographic(_115);}else{if(sr.wkid===4326){_11c=_cf.geographicToWebMercator(_115);}}}var _11d=_11b.getCenter(),_11e=Math.max(_11c.getWidth(),_11c.getHeight());if(_11a){_11b=_11b.expand(_11a);}_118=_118.replace(/\[bboxWest\]/ig,_11b.xmin).replace(/\[bboxEast\]/ig,_11b.xmax).replace(/\[bboxSouth\]/ig,_11b.ymin).replace(/\[bboxNorth\]/ig,_11b.ymax).replace(/\[lookatLon\]/ig,_11d.x).replace(/\[lookatLat\]/ig,_11d.y).replace(/\[lookatRange\]/ig,_11e).replace(/\[lookatTilt\]/ig,0).replace(/\[lookatHeading\]/ig,0).replace(/\[lookatTerrainLon\]/ig,_11d.x).replace(/\[lookatTerrainLat\]/ig,_11d.y).replace(/\[lookatTerrainAlt\]/ig,0).replace(/\[cameraLon\]/ig,_11d.x).replace(/\[cameraLat\]/ig,_11d.y).replace(/\[cameraAlt\]/ig,_11e).replace(/\[horizFov\]/ig,60).replace(/\[vertFov\]/ig,60).replace(/\[horizPixels\]/ig,map.width).replace(/\[vertPixels\]/ig,map.height).replace(/\[terrainEnabled\]/ig,0);_c5.mixin(_113,ioq.queryToObject(_118));}if(_119){_119=_119.replace(/\[clientVersion\]/ig,_ca.version).replace(/\[kmlVersion\]/ig,2.2).replace(/\[clientName\]/ig,"ArcGIS API for JavaScript").replace(/\[language\]/ig,_c2.locale);_c5.mixin(_113,ioq.queryToObject(_119));}}var _11f=[],_120;for(_120 in _113){if(_cc.isDefined(_113[_120])){_11f.push(_120+"="+_113[_120]);}}_11f=_11f.join("&");return _11f?("?"+_11f):"";},_setMap:function(map,_121){this._map=map;var div=this._div=_c8.create("div",null,_121);_c9.set(div,"position","absolute");this._addInternalLayers();return div;},_unsetMap:function(map,_122){if(this._io){this._io.cancel();}this._stopAutoRefresh();_c4.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var div=this._div;if(div){_122.removeChild(div);_c8.destroy(div);}this._map=this._wMap=this._div=null;},onVisibilityChange:function(_123){if(!this.loaded){if(this.linkInfo&&_123){if(!this._waitingForMap){this._parseKml(this._wMap);}}return;}this._fireUpdateStart();this._setInternalVisibility(this,_123);this._checkAutoRefresh();this._fireUpdateEnd();},refresh:function(){if(!this.loaded||!this._map||this._io){return;}this._parseKml();},_extentChanged:function(){this._stopAutoRefresh();this._timeoutHandle=setTimeout(this.refresh,this.linkInfo.viewRefreshTime*1000);}});if(has("extend-esri")){_c5.setObject("layers.KMLLayer",_d6,_ca);}return _d6;});},"dojo/data/util/sorter":function(){define(["../../_base/lang"],function(lang){var _124={};lang.setObject("dojo.data.util.sorter",_124);_124.basicComparator=function(a,b){var r=-1;if(a===null){a=undefined;}if(b===null){b=undefined;}if(a==b){r=0;}else{if(a>b||a==null){r=1;}}return r;};_124.createSortFunction=function(_125,_126){var _127=[];function _128(attr,dir,comp,s){return function(_129,_12a){var a=s.getValue(_129,attr);var b=s.getValue(_12a,attr);return dir*comp(a,b);};};var _12b;var map=_126.comparatorMap;var bc=_124.basicComparator;for(var i=0;i<_125.length;i++){_12b=_125[i];var attr=_12b.attribute;if(attr){var dir=(_12b.descending)?-1:1;var comp=bc;if(map){if(typeof attr!=="string"&&("toString" in attr)){attr=attr.toString();}comp=map[attr]||bc;}_127.push(_128(attr,dir,comp,_126));}}return function(rowA,rowB){var i=0;while(i<_127.length){var ret=_127[i++](rowA,rowB);if(ret!==0){return ret;}}return 0;};};return _124;});},"esri/layers/OnDemandMode":function(){define(["dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/has","esri/kernel","esri/geometry/Point","esri/tasks/query","esri/layers/RenderMode","esri/layers/GridLayout"],function(_12c,_12d,lang,_12e,has,_12f,_130,_131,_132,_133){var _134=_12c([_132],{declaredClass:"esri.layers._OnDemandMode",constructor:function(_135){this.featureLayer=_135;this._featureMap={};this._queryErrorHandler=lang.hitch(this,this._queryErrorHandler);},initialize:function(map){this.inherited(arguments);var _136=this.featureLayer,_137=_136._srInfo;this._gridLayer=new _133(new _130(_137?_137.valid[0]:map.extent.xmin,map.extent.ymax,map.spatialReference),{width:_136._tileWidth,height:_136._tileHeight},{width:map.width,height:map.height},_137);this._cellMap={};this._gridLayer.setResolution(map.extent);},startup:function(){this._ioQueue=[];if(!this.featureLayer.suspended){this._zoomHandler();this._enableConnectors();}},propertyChangeHandler:function(type){if(this._init){if(type<2){this._zoomHandler();}else{console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id = "+this.featureLayer.id+", Layer URL = "+this.featureLayer.url);}}},destroy:function(){this._disableConnectors();this.inherited(arguments);},drawFeature:function(_138){var _139=this._gridLayer,geom=_138.geometry,_13a=[];if(!geom){return;}_13a=_139.getCellsInExtent((geom.type==="point")?{xmin:geom.x,ymin:geom.y,xmax:geom.x,ymax:geom.y}:geom.getExtent(),false).cells;var _13b=this._cellMap,i,cell,oid=_138.attributes[this.featureLayer.objectIdField],_13c,row,col;for(i=0;i<_13a.length;i++){cell=_13a[i];_13c=cell.latticeID;row=cell.row;col=cell.col;if(_13c){cell=(_13b[_13c]=(_13b[_13c]||cell));}else{_13b[row]=_13b[row]||{};cell=(_13b[row][col]=(_13b[row][col]||cell));}cell.features=cell.features||[];cell.features.push(_138);this._addFeatureIIf(oid,_138);this._incRefCount(oid);}},suspend:function(){if(!this._init){return;}this._disableConnectors();},resume:function(){if(!this._init){return;}this._enableConnectors();this._zoomHandler();},refresh:function(){this._zoomHandler();},_enableConnectors:function(){var map=this.map;this._zoomConnect=_12d.connect(map,"onZoomEnd",this,this._zoomHandler);this._panConnect=_12d.connect(map,"onPanEnd",this,this._panHandler);this._resizeConnect=_12d.connect(map,"onResize",this,this._panHandler);},_disableConnectors:function(){_12d.disconnect(this._zoomConnect);_12d.disconnect(this._panConnect);_12d.disconnect(this._resizeConnect);},_zoomHandler:function(){this._processIOQueue(true);var _13d=this.featureLayer,map=this.map;if(_13d.suspended){return;}_13d._fireUpdateStart();this._clearIIf();var _13e=_13d._trackManager;if(_13e){_13e.clearTracks();}this._cellMap={};this._gridLayer.setResolution(map.extent);this._sendRequest();},_panHandler:function(){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&arguments[0]);},_getRequestId:function(_13f,cell){var id="_"+_13f.name+_13f.layerId+_13f._ulid+"_"+cell.resolution+"_"+(cell.latticeID||(cell.row+"_"+cell.col));return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_sendRequest:function(_140){this._exceeds=false;var _141=this.featureLayer,map=this.map,_142=_140||map.extent,_143=this._gridLayer.getCellsInExtent(_142,_141.latticeTiling),_144=_143.cells;if(!_141.isEditable()){var _145=this._cellMap;_144=_12e.filter(_144,function(cell){if(cell.lattice){if(_145[cell.latticeID]){return false;}}else{if(_145[cell.row]&&_145[cell.row][cell.col]){return false;}}return true;});}var _146=_141._getOutFields(),_147=_141.getDefinitionExpression(),time=_141._getOffsettedTE(_141._mapTimeExtent),_148=_141._usePatch,_149=this._ioQueue,i,self=this,func=this._drawFeatures,cell,_14a,_14b;this._pending=this._pending||0;for(i=0;i<_144.length;i++){cell=_144[i];_14a=new _131();_14a.geometry=cell.extent||cell.lattice;_14a.outFields=_146;_14a.where=_147;if(_141.latticeTiling&&cell.extent){_14a.spatialRelationship=_131.SPATIAL_REL_CONTAINS;}_14a.returnGeometry=true;_14a.timeExtent=time;_14a.maxAllowableOffset=_141._maxOffset;if(_141._ts){_14a._ts=(new Date()).getTime();}_14b=null;if(_148){_14b=this._getRequestId(_141,cell);if(this._isPending(_14b)){continue;}}this._pending++;_149.push(_141._task.execute(_14a,function(){var _14c=cell;return function(_14d){func.apply(self,[_14d,_14c]);};}.call(this),this._queryErrorHandler,_14b));}this._removeOldCells(_142);this._endCheck();},_drawFeatures:function(_14e,cell){this._exceeds=this._exceeds||_14e.exceededTransferLimit;this._finalizeIO();var _14f=this.featureLayer,map=this.map,_150=map.extent,_151=cell.extent,row=cell.row,col=cell.col,_152=_14f.objectIdField,_153=_14e.features,_154=this._gridLayer,_155=this._cellMap,i,len,_156=cell.latticeID,_157=_156?_155[_156]:(_155[row]&&_155[row][col]);if((cell.resolution!=_154._resolution)||(_156?(_156!==_154.getLatticeID(_150)):(!_154.intersects(_151,_150)))){if(_157){this._removeCell(row,col,_156);}}else{if(_157){this._updateCell(_157,_153);}else{cell.features=_153;if(_156){_155[_156]=cell;}else{_155[row]=_155[row]||{};_155[row][col]=cell;}len=_153.length;for(i=0;i<len;i++){var _158=_153[i];var oid=_158.attributes[_152];this._addFeatureIIf(oid,_158);this._incRefCount(oid);}}}this._endCheck();},_queryErrorHandler:function(err){this._finalizeIO();this.featureLayer._errorHandler(err);this._endCheck(true);},_finalizeIO:function(){this._purgeRequests();this._pending--;},_endCheck:function(_159){if(this._pending===0){this._processIOQueue();var _15a=this.featureLayer,_15b=_15a._trackManager;if(_15b){_15b.clearTracks();_15b.addFeatures(_15a.graphics);if(_15a._ager){_12e.forEach(_15a.graphics,function(_15c){if(_15c._shape){_15a._repaint(_15c);}});}_15b.moveLatestToFront();_15b.drawTracks();}this.featureLayer._fireUpdateEnd(_159&&new Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:true}:null);if(this._exceeds){_15a.onQueryLimitExceeded();}}},_processIOQueue:function(_15d){this._ioQueue=_12e.filter(this._ioQueue,function(dfd){var keep=dfd.fired>-1?false:true;return keep;});if(_15d){_12e.forEach(this._ioQueue,this._cancelPendingRequest);}},_removeOldCells:function(_15e){var _15f=this._cellMap,_160=this._gridLayer,_161,_162;for(_161 in _15f){if(_15f[_161]){var row=_15f[_161],_163=row.latticeID,_164=0,_165=0;if(_163){_164++;if(_163!==_160.getLatticeID(_15e)){this._removeCell(null,null,_163);_165++;}}else{for(_162 in row){if(row[_162]){_164++;var _166=row[_162].extent;if(!_160.intersects(_166,_15e)){this._removeCell(_161,_162);_165++;}}}}if(_165===_164){delete _15f[_161];}}}},_updateCell:function(cell,_167){var _168=this.featureLayer,_169=_168.objectIdField,_16a=_168._selectedFeatures,i,len=_167.length;cell.features=cell.features||[];for(i=0;i<len;i++){var _16b=_167[i];var oid=_16b.attributes[_169];var _16c=this._addFeatureIIf(oid,_16b);if(_16c===_16b){this._incRefCount(oid);cell.features.push(_16c);}else{if(!(oid in _16a)){_16c.setGeometry(_16b.geometry);_16c.setAttributes(_16b.attributes);}}}},_removeCell:function(row,col,_16d){var _16e=this._cellMap,_16f=this.featureLayer,_170=_16f.objectIdField;var cell=_16d?_16e[_16d]:(_16e[row]&&_16e[row][col]);if(cell){if(_16d){delete _16e[_16d];}else{delete _16e[row][col];}var _171=cell.features,i;for(i=0;i<_171.length;i++){var _172=_171[i];var oid=_172.attributes[_170];this._decRefCount(oid);if(oid in _16f._selectedFeatures){continue;}this._removeFeatureIIf(oid);}}}});if(has("extend-esri")){lang.setObject("layers._OnDemandMode",_134,_12f);}return _134;});},"esri/layers/FeatureLayer":function(){define(["dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/Deferred","dojo/date/locale","dojo/sniff","dojo/io-query","dojo/dom-construct","dojo/i18n","esri/kernel","esri/lang","esri/request","esri/deferredUtils","esri/SpatialReference","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/jsonUtils","esri/renderers/SimpleRenderer","esri/renderers/UniqueValueRenderer","esri/renderers/jsonUtils","esri/tasks/QueryTask","esri/tasks/query","esri/tasks/FeatureSet","esri/geometry/Extent","esri/geometry/jsonUtils","esri/geometry/normalizeUtils","esri/layers/GraphicsLayer","esri/layers/Field","esri/layers/TimeInfo","esri/layers/FeatureType","esri/layers/FeatureTemplate","esri/layers/FeatureEditResult","esri/layers/SnapshotMode","esri/layers/OnDemandMode","esri/layers/SelectionMode","esri/layers/TrackManager","dojo/i18n!esri/nls/jsapi","dojo/has!extend-esri?esri/layers/agscommon"],function(_173,_174,lang,_175,_176,_177,_178,has,ioq,_179,i18n,_17a,_17b,_17c,_17d,_17e,_17f,_180,_181,_182,_183,_184,_185,_186,_187,_188,_189,_18a,_18b,_18c,_18d,_18e,_18f,_190,_191,_192,_193,_194,_195){var _196=_173(_18c,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",constructor:function(url,_197){this.i18n=i18n.getLocalization("esri","jsapi");this._outFields=_197&&_197.outFields;this._loadCallback=_197&&_197.loadCallback;var _198=_197&&_197._usePatch;this._usePatch=(_198===null||_198===undefined)?true:_198;this._trackIdField=_197&&_197.trackIdField;this.objectIdField=_197&&_197.objectIdField;this._maxOffset=_197&&_197.maxAllowableOffset;this._optEditable=_197&&_197.editable;this._optAutoGen=_197&&_197.autoGeneralize;this.editSummaryCallback=_197&&_197.editSummaryCallback;this.userId=_197&&_197.userId;this.userIsAdmin=_197&&_197.userIsAdmin;this.useMapTime=(_197&&_197.hasOwnProperty("useMapTime"))?(!!_197.useMapTime):true;this.source=_197&&_197.source;this.gdbVersion=_197&&_197.gdbVersion;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var ctor=this.constructor,mode=this.mode=(_17b.isDefined(_197&&_197.mode)?_197.mode:ctor.MODE_ONDEMAND);switch(mode){case ctor.MODE_SNAPSHOT:this._mode=new _192(this);this._isSnapshot=true;break;case ctor.MODE_ONDEMAND:this._tileWidth=(_197&&_197.tileWidth)||512;this._tileHeight=(_197&&_197.tileHeight)||512;this._mode=new _193(this);var _199=_197&&_197.latticeTiling;this.latticeTiling=_199;break;case ctor.MODE_SELECTION:this._mode=new _194(this);this._isSelOnly=true;break;}this._initLayer=lang.hitch(this,this._initLayer);this._selectHandler=lang.hitch(this,this._selectHandler);this._editable=false;if(lang.isObject(url)&&url.layerDefinition){var json=url;this._collection=true;this.mode=ctor.MODE_SNAPSHOT;this._initLayer(json);return this;}this._task=new _186(this.url,{source:this.source,gdbVersion:this.gdbVersion});var _19a=this._url.path;this._fserver=false;if(_19a.search(/\/FeatureServer\//i)!==-1){this._fserver=true;}var _19b=_197&&_197.resourceInfo;if(_19b){this._initLayer(_19b);}else{if(this.source){var _19c={source:this.source.toJson()};this._url.query=lang.mixin(this._url.query,{layer:_176.toJson(_19c)});}if(this.gdbVersion){this._url.query=lang.mixin(this._url.query,{gdbVersion:this.gdbVersion});}_17c({url:_19a,content:lang.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});}},_initLayer:function(_19d,io){if(_19d||io){this._json=_19d;this._findCredential();var ssl=(this.credential&&this.credential.ssl)||(_19d&&_19d._ssl);if(ssl){this._useSSL();this._task._useSSL();}if(this._collection){this._mode=new _192(this);this._isSnapshot=true;this._featureSet=_19d.featureSet;this._nextId=_19d.nextObjectId;_19d=_19d.layerDefinition;}if(_19d.hasOwnProperty("capabilities")){var _19e=(this.capabilities=_19d.capabilities);if(_19e&&_19e.toLowerCase().indexOf("editing")!==-1){this._editable=true;}else{this._editable=false;}}else{if(!this._collection){this._editable=this._fserver;}}if(_17b.isDefined(this._optEditable)){this._editable=this._optEditable;delete this._optEditable;}this._json=_176.toJson(this._json);if(this.isEditable()){delete this._maxOffset;}else{if(this.mode!==this.constructor.MODE_SNAPSHOT&&((_19d.geometryType==="esriGeometryPolyline")||(_19d.geometryType==="esriGeometryPolygon"))){this._autoGeneralize=_17b.isDefined(this._optAutoGen)?this._optAutoGen:(this.mode===this.constructor.MODE_ONDEMAND);delete this._optAutoGen;}}var _19f=_19d.effectiveMinScale||_19d.minScale,_1a0=_19d.effectiveMaxScale||_19d.maxScale;if(!this._hasMin&&_19f){this.setMinScale(_19f);}if(!this._hasMax&&_1a0){this.setMaxScale(_1a0);}this.layerId=_19d.id;this.name=_19d.name;this.description=_19d.description;this.copyright=_19d.copyrightText;this.type=_19d.type;this.geometryType=_19d.geometryType;this.displayField=_19d.displayField;this.defaultDefinitionExpression=_19d.definitionExpression;this.fullExtent=new _189(_19d.extent);this.initialExtent=new _189(this.fullExtent.toJson());if(this.fullExtent.spatialReference){this.spatialReference=new _17e(this.fullExtent.spatialReference.toJson());}this.defaultVisibility=_19d.defaultVisibility;if((this.geometryType==="esriGeometryPoint")||(this.geometryType==="esriGeometryMultipoint")){this.latticeTiling=false;}this.indexedFields=_19d.indexedFields;this.maxRecordCount=_19d.maxRecordCount;this.canModifyLayer=_19d.canModifyLayer;this.supportsStatistics=_19d.supportsStatistics;this.supportsAdvancedQueries=_19d.supportsAdvancedQueries;this.hasLabels=_19d.hasLabels;this.canScaleSymbols=_19d.canScaleSymbols;this.supportsRollbackOnFailure=_19d.supportsRollbackOnFailure;this.syncCanReturnChanges=_19d.syncCanReturnChanges;this.isDataVersioned=_19d.isDataVersioned;this.editFieldsInfo=_19d.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=_19d.ownershipBasedAccessControlForFeatures;if(this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures){this.creatorField=this.editFieldsInfo.creatorField;}this.relationships=_19d.relationships;this.allowGeometryUpdates=_17b.isDefined(_19d.allowGeometryUpdates)?_19d.allowGeometryUpdates:true;this._isTable=(this.type==="Table");var _1a1=(this.fields=[]),_1a2=_19d.fields,i;for(i=0;i<_1a2.length;i++){_1a1.push(new _18d(_1a2[i]));}if(!this.objectIdField){this.objectIdField=_19d.objectIdField;if(!this.objectIdField){_1a2=_19d.fields;for(i=0;i<_1a2.length;i++){var _1a3=_1a2[i];if(_1a3.type==="esriFieldTypeOID"){this.objectIdField=_1a3.name;break;}}}if(!this.objectIdField){console.debug("esri.layers.FeatureLayer: "+_17b.substitute({url:this.url},"objectIdField is not set [url: ${url}]"));}}if(!_17b.isDefined(this._nextId)){var _1a4=this.objectIdField,_1a5=-1;if(this._collection&&_1a4){var fset=this._featureSet,_1a6=fset&&fset.features,il=_1a6?_1a6.length:0,oid,attr;for(i=0;i<il;i++){attr=_1a6[i].attributes;oid=attr&&attr[_1a4];if(oid>_1a5){_1a5=oid;}}}this._nextId=(_1a5+1);}this.globalIdField=_19d.globalIdField;var _1a7=(this.typeIdField=_19d.typeIdField),_1a8;if(_1a7){_1a8=!this._getField(_1a7)&&this._getField(_1a7,true);if(_1a8){this.typeIdField=_1a8.name;}}this.visibilityField=_19d.visibilityField;var _1a9=_19d.defaultSymbol;if(_1a9){this.defaultSymbol=_182.fromJson(_1a9);}var _1aa=this.types=[],_1ab=_19d.types,_1ac,_1ad,_1ae,_1af=this.editFieldsInfo,_1b0=_1af&&_1af.creatorField,_1b1=_1af&&_1af.editorField,fix=(_1b0||_1b1),_1b2=[];if(_1ab){for(i=0;i<_1ab.length;i++){_1ac=new _18f(_1ab[i]);_1ad=_1ac.templates;if(fix&&_1ad&&_1ad.length){_1b2=_1b2.concat(_1ad);}_1aa.push(_1ac);}}var _1b3=_19d.templates,_1b4,_1b5=this.templates=[];if(_1b3){for(i=0;i<_1b3.length;i++){_1b4=new _190(_1b3[i]);if(fix){_1b2.push(_1b4);}_1b5.push(_1b4);}}for(i=0;i<_1b2.length;i++){_1ae=lang.getObject("prototype.attributes",false,_1b2[i]);if(_1ae){if(_1b0){delete _1ae[_1b0];}if(_1b1){delete _1ae[_1b1];}}}var _1b6=_19d.timeInfo;if(_1b6){this.timeInfo=new _18e(_1b6);this._startTimeField=_1b6.startTimeField;this._endTimeField=_1b6.endTimeField;if(this._startTimeField&&this._endTimeField){this._twoTimeFields=true;}if(this._trackIdField){_1b6.trackIdField=this._trackIdField;}else{this._trackIdField=_1b6.trackIdField;}}this.hasAttachments=(!this._collection&&_19d.hasAttachments)?true:false;this.htmlPopupType=_19d.htmlPopupType;var _1b7=_19d.drawingInfo,_1b8;if(!this.renderer){if(_1b7&&_1b7.renderer){_1b8=_1b7.renderer;this.setRenderer(_185.fromJson(_1b8));if(_1b8.type==="classBreaks"){this.renderer.setMaxInclusive(true);}if(!this._collection){var _1b9=_1b8.type,_1ba=[];_1b8=this.renderer;switch(_1b9){case "simple":_1ba.push(_1b8.symbol);break;case "uniqueValue":case "classBreaks":_1ba.push(_1b8.defaultSymbol);_1ba=_1ba.concat(_175.map(_1b8.infos,function(info){return info.symbol;}));break;}_1ba=_175.filter(_1ba,_17b.isDefined);var _1bb=this._url.path+"/images/",_1bc=this._getToken();_175.forEach(_1ba,function(sym){var url=sym.url;if(url){if((url.search(/https?\:/)===-1)&&(url.indexOf("data:")===-1)){sym.url=_1bb+url;}if(_1bc&&sym.url.search(/https?\:/)!==-1){sym.url+=("?token="+_1bc);}}});}}else{if(_1a9){_1ab=this.types;if(_1ab.length>0){_1b8=new _184(this.defaultSymbol,this.typeIdField);_175.forEach(_1ab,function(type){_1b8.addValue(type.id,type.symbol);});}else{_1b8=new _183(this.defaultSymbol);}this.setRenderer(_1b8);}else{if(!this._isTable){var _1bd;switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":_1bd=new _17f();break;case "esriGeometryPolyline":_1bd=new _180();break;case "esriGeometryPolygon":_1bd=new _181();break;}this.setRenderer(_1bd?new _183(_1bd):null);}}}}var _1be=(_1b7&&_1b7.transparency)||0;if(!_17b.isDefined(this.opacity)&&_1be>0){this.opacity=1-(_1be/100);}this.version=_19d.currentVersion;if(!this.version){var ver;if("capabilities" in _19d||"drawingInfo" in _19d||"hasAttachments" in _19d||"htmlPopupType" in _19d||"relationships" in _19d||"timeInfo" in _19d||"typeIdField" in _19d||"types" in _19d){ver=10;}else{ver=9.3;}this.version=ver;}if((has("ie")||has("safari"))&&this.isEditable()&&this.version<10.02){this._ts=true;}this.loaded=true;this._fixRendererFields();this._checkFields();this._updateCaps();var _1bf=function(){this.onLoad(this);var _1c0=this._loadCallback;if(_1c0){delete this._loadCallback;_1c0(this);}};if(this._collection){this._fireUpdateStart();var _1c1=this._featureSet;delete this._featureSet;this._mode._drawFeatures(new _188(_1c1));this._fcAdded=true;_1bf.call(this);}else{this._forceIdentity(_1bf);}}},setRenderer:function(ren){this.inherited("setRenderer",arguments);var _1c2=this.renderer;if(_1c2){this._ager=(_1c2.declaredClass.indexOf("TemporalRenderer")!==-1&&_1c2.observationAger&&_1c2.observationRenderer);var _1c3=_175.filter([_1c2,_1c2.observationRenderer,_1c2.latestObservationRenderer,_1c2.trackRenderer],_17b.isDefined);var _1c4=[];_175.forEach(_1c3,function(rnd){if(!lang.isFunction(rnd.attributeField)){_1c4.push(rnd.attributeField);}_1c4.push(rnd.attributeField2);_1c4.push(rnd.attributeField3);},this);this._rendererFields=_175.filter(_1c4,_17b.isDefined);}else{this._ager=false;this._rendererFields=[];}if(this.loaded&&this._rendererFields.length>0){this._fixRendererFields();this._checkFields(this._rendererFields);}if(this.loaded&&this._collection){this._typesDirty=true;}},_setMap:function(map){var div=this.inherited(arguments),mode=this._mode;if(mode){mode.initialize(map);}return div;},_unsetMap:function(map){var mode=this._mode;if(mode){mode.suspend();}if(this._trackManager){this._trackManager.destroy();this._trackManager=null;}_174.disconnect(this._zoomConnect);this._zoomConnect=null;this._toggleTime(false);this.inherited("_unsetMap",arguments);},refresh:function(){var mode=this._mode;if(mode){mode.refresh();}},setEditable:function(_1c5){if(!this._collection){console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service");return this;}if(!this.loaded){this._optEditable=_1c5;return this;}var _1c6=this._editable;this._editable=_1c5;this._updateCaps();if(_1c6!==_1c5){this.onCapabilitiesChange();}return this;},getEditCapabilities:function(_1c7){var _1c8={"canCreate":false,"canUpdate":false,"canDelete":false};if(!this.loaded||!this.isEditable()){return _1c8;}var _1c9=_1c7&&_1c7.feature,_1ca=_1c7&&_1c7.userId,caps=_175.map((this.capabilities?this.capabilities.toLowerCase().split(","):[]),lang.trim),_1cb=_175.indexOf(caps,"editing")>-1,_1cc=_1cb&&(_175.indexOf(caps,"create")>-1),_1cd=_1cb&&(_175.indexOf(caps,"update")>-1),_1ce=_1cb&&(_175.indexOf(caps,"delete")>-1),_1cf=this.ownershipBasedAccessControlForFeatures,_1d0=this.editFieldsInfo,_1d1=_1d0&&_1d0.creatorField,_1d2=_1d0&&_1d0.realm,_1d3=_1c9&&_1c9.attributes,_1d4=(_1d3&&_1d1)?_1d3[_1d1]:undefined,_1d5,_1d6=!!this.userIsAdmin,_1d7=!_1cf||_1d6||!!(_1cf.allowOthersToUpdate||_1cf.allowUpdateToOthers),_1d8=!_1cf||_1d6||!!(_1cf.allowOthersToDelete||_1cf.allowDeleteToOthers);if(_1d6||(_1cb&&!(_1cc||_1cd||_1ce))){_1cc=_1cd=_1ce=true;}_1d5={"canCreate":_1cc,"canUpdate":_1cd,"canDelete":_1ce};if(_1d4===null){_1d5.canUpdate=_1cd&&_1d7;_1d5.canDelete=_1ce&&_1d8;}else{if(_1d4===""){return _1d5;}else{if(_1d4){_1ca=_1ca||this.getUserId();if(_1ca&&_1d2){_1ca=_1ca+"@"+_1d2;}if(_1ca.toLowerCase()===_1d4.toLowerCase()){return _1d5;}else{_1d5.canUpdate=_1cd&&_1d7;_1d5.canDelete=_1ce&&_1d8;}}}}return _1d5;},getUserId:function(){var _1d9;if(this.loaded){_1d9=(this.credential&&this.credential.userId)||this.userId||"";}return _1d9;},setUserIsAdmin:function(_1da){this.userIsAdmin=_1da;},setEditSummaryCallback:function(_1db){this.editSummaryCallback=_1db;},getEditSummary:function(_1dc,_1dd,_1de){_1de=_17b.isDefined(_1de)?_1de:(new Date()).getTime();var _1df="",info=this.getEditInfo(_1dc,_1dd,_1de),_1e0=(_1dd&&_1dd.callback)||this.editSummaryCallback;if(_1e0){info=_1e0(_1dc,info)||"";}if(lang.isString(info)){_1df=info;}else{if(info){var _1e1=info.action,_1e2=info.userId,_1e3=info.timeValue,_1e4=0;if(_1e1){_1e4++;}if(_1e2){_1e4++;}if(_17b.isDefined(_1e3)){_1e4++;}if(_1e4>1){_1df=(_1e1==="edit"?"edit":"create")+(_1e2?"User":"")+(_17b.isDefined(_1e3)?info.displayPattern:"");}}_1df=_1df&&_17b.substitute(info,this.i18n.layers.FeatureLayer[_1df]);}return _1df;},getEditInfo:function(_1e5,_1e6,_1e7){if(!this.loaded){return;}_1e7=_17b.isDefined(_1e7)?_1e7:(new Date()).getTime();var _1e8=(_1e6&&_1e6.action)||"last",_1e9=this.editFieldsInfo,_1ea=_1e9&&_1e9.creatorField,_1eb=_1e9&&_1e9.creationDateField,_1ec=_1e9&&_1e9.editorField,_1ed=_1e9&&_1e9.editDateField,_1ee=_1e9&&_1e9.realm,_1ef=_1e5&&_1e5.attributes,_1f0=(_1ef&&_1ea)?_1ef[_1ea]:undefined,_1f1=(_1ef&&_1eb)?_1ef[_1eb]:null,_1f2=(_1ef&&_1ec)?_1ef[_1ec]:undefined,_1f3=(_1ef&&_1ed)?_1ef[_1ed]:null,_1f4=this._getEditData(_1f0,_1f1,_1e7),_1f5=this._getEditData(_1f2,_1f3,_1e7),_1f6;switch(_1e8){case "creation":_1f6=_1f4;break;case "edit":_1f6=_1f5;break;case "last":_1f6=_1f5||_1f4;break;}if(_1f6){_1f6.action=(_1f6===_1f5)?"edit":"creation";}return _1f6;},_getEditData:function(_1f7,_1f8,_1f9){var data,_1fa,_1fb,_1fc=60000,_1fd=3600000,_1fe=2*_1fd,_1ff=24*_1fd,_200=7*_1ff;if(_17b.isDefined(_1f8)){_1fa=_1f9-_1f8;if(_1fa<0){_1fb="Full";}else{if(_1fa<_1fc){_1fb="Seconds";}else{if(_1fa<(2*_1fc)){_1fb="Minute";}else{if(_1fa<_1fd){_1fb="Minutes";}else{if(_1fa<_1fe){_1fb="Hour";}else{if(_1fa<_1ff){_1fb="Hours";}else{if(_1fa<_200){_1fb="WeekDay";}else{_1fb="Full";}}}}}}}}if((_1f7!==undefined)||_1fb){data=data||{};data.userId=_1f7;if(_1fb){var _201=_178.format,_202=new Date(_1f8);data.minutes=Math.floor(_1fa/_1fc);data.hours=Math.floor(_1fa/_1fd);data.weekDay=_201(_202,{datePattern:"EEEE",selector:"date"});data.formattedDate=_201(_202,{selector:"date"});data.formattedTime=_201(_202,{selector:"time"});data.displayPattern=_1fb;data.timeValue=_1f8;}}return data;},isEditable:function(){return !!(this._editable||this.userIsAdmin);},setMaxAllowableOffset:function(_203){if(!this.isEditable()){this._maxOffset=_203;}return this;},getMaxAllowableOffset:function(){return this._maxOffset;},setAutoGeneralize:function(_204){if(!this.loaded){this._optAutoGen=_204;}else{if(!this.isEditable()&&(this.mode!==this.constructor.MODE_SNAPSHOT)&&((this.geometryType==="esriGeometryPolyline")||(this.geometryType==="esriGeometryPolygon"))){this._autoGeneralize=_204;if(_204){var map=this._map;if(map&&map.loaded){this._maxOffset=Math.floor(map.extent.getWidth()/map.width);}}else{delete this._maxOffset;}}}return this;},setGDBVersion:function(_205){if(!this._collection&&(_205!==this.gdbVersion)&&(_205||this.gdbVersion)){this.gdbVersion=_205;this._task.gdbVersion=_205;this._url.query=lang.mixin(this._url.query,{gdbVersion:_205});if(this.loaded){this.clearSelection();if(this._map){this.refresh();}}this.onGDBVersionChange();}return this;},setDefinitionExpression:function(expr){this._defnExpr=expr;var mode=this._mode;if(mode){mode.propertyChangeHandler(1);}return this;},getDefinitionExpression:function(){return this._defnExpr;},setTimeDefinition:function(_206){if(this._isSnapshot){this._timeDefn=_206;var mode=this._mode;if(mode){mode.propertyChangeHandler(2);}}else{console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id = "+this.id+", Layer URL = "+this.url);}return this;},getTimeDefinition:function(){return this._timeDefn;},setTimeOffset:function(_207,_208){this._timeOffset=_207;this._timeOffsetUnits=_208;var mode=this._mode;if(mode){mode.propertyChangeHandler(0);}return this;},setUseMapTime:function(use){this.useMapTime=use;this._toggleTime(!this.suspended);var mode=this._mode;if(mode){mode.propertyChangeHandler(0);}},selectFeatures:function(_209,_20a,_20b,_20c){_20a=_20a||this.constructor.SELECTION_NEW;var _20d=this._getShallowClone(_209),map=this._map,_20e,dfd=_17d._fixDfd(new _177(_17d._dfdCanceller));_20d.outFields=this._getOutFields();_20d.returnGeometry=true;if(map){_20d.outSpatialReference=new _17e(map.spatialReference.toJson());}if(!this._applyQueryFilters(_20d)){_20e={features:[]};this._selectHandler(_20e,_20a,_20b,_20c,dfd);return dfd;}var _20f=this._canDoClientSideQuery(_20d);if(_20f){_20e={features:this._doQuery(_20d,_20f)};this._selectHandler(_20e,_20a,_20b,_20c,dfd);return dfd;}else{if(this._collection){var err=new Error("FeatureLayer::selectFeatures - "+this.invalidParams);this._resolve([err],null,_20c,dfd,true);return dfd;}var self=this;if(this._ts){_20d._ts=(new Date()).getTime();}var temp=dfd._pendingDfd=this._task.execute(_20d);temp.addCallbacks(function(_210){self._selectHandler(_210,_20a,_20b,_20c,dfd);},function(err){self._resolve([err],null,_20c,dfd,true);});return dfd;}},getSelectedFeatures:function(){var _211=this._selectedFeatures,_212=[],item;for(item in _211){if(_211.hasOwnProperty(item)){_212.push(_211[item]);}}return _212;},clearSelection:function(_213){var _214=this._selectedFeatures,mode=this._mode,item;for(item in _214){if(_214.hasOwnProperty(item)){this._unSelectFeatureIIf(item,mode);mode._removeFeatureIIf(item);}}this._selectedFeatures={};if(this._isSelOnly){mode._applyTimeFilter(true);}if(!_213){this.onSelectionClear();}return this;},setSelectionSymbol:function(_215){this._selectionSymbol=_215;if(_215){var _216=this._selectedFeatures,item;for(item in _216){if(_216.hasOwnProperty(item)){_216[item].setSymbol(_215);}}}return this;},getSelectionSymbol:function(){return this._selectionSymbol;},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(adds,_217,_218,_219,_21a,_21b){var _21c=_21b.assembly,dfd=_21b.dfd;this._applyNormalized(adds,_21c&&_21c[0]);this._applyNormalized(_217,_21c&&_21c[1]);this.onBeforeApplyEdits(adds,_217,_218);var i,_21d={},_21e=this.objectIdField,_21f={f:"json"},_220=false;if(this._collection){var _221={};_221.addResults=adds?_175.map(adds,function(){_220=true;return {objectId:this._nextId++,success:true};},this):null;_221.updateResults=_217?_175.map(_217,function(_222){_220=true;var oid=_222.attributes[_21e];_21d[oid]=_222;return {objectId:oid,success:true};},this):null;_221.deleteResults=_218?_175.map(_218,function(_223){_220=true;return {objectId:_223.attributes[_21e],success:true};},this):null;if(_220){this._editHandler(_221,adds,_21d,_219,_21a,dfd);}return;}if(adds&&adds.length>0){_21f.adds=this._convertFeaturesToJson(adds,0,1);_220=true;}if(_217&&_217.length>0){for(i=0;i<_217.length;i++){var _224=_217[i];_21d[_224.attributes[_21e]]=_224;}_21f.updates=this._convertFeaturesToJson(_217,0,0,1);_220=true;}if(_218&&_218.length>0){var ids=[];for(i=0;i<_218.length;i++){ids.push(_218[i].attributes[_21e]);}_21f.deletes=ids.join(",");_220=true;}if(_220){var self=this;return _17c({url:this._url.path+"/applyEdits",content:lang.mixin(_21f,this._url.query),callbackParamName:"callback",load:function(_225){self._editHandler(_225,adds,_21d,_219,_21a,dfd);},error:function(err){self._resolve([err],null,_21a,dfd,true);}},{usePost:true});}},queryFeatures:function(_226,_227,_228){return this._query("execute","onQueryFeaturesComplete",_226,_227,_228);},queryRelatedFeatures:function(_229,_22a,_22b){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",_229,_22a,_22b);},queryIds:function(_22c,_22d,_22e){return this._query("executeForIds","onQueryIdsComplete",_22c,_22d,_22e);},queryCount:function(_22f,_230,_231){return this._query("executeForCount","onQueryCountComplete",_22f,_230,_231);},queryAttachmentInfos:function(_232,_233,_234){var url=this._url.path+"/"+_232+"/attachments",dfd=new _177(_17d._dfdCanceller),self=this;dfd._pendingDfd=_17c({url:url,content:lang.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(_235){var _236=_235.attachmentInfos,_237;_175.forEach(_236,function(info){_237=ioq.objectToQuery({gdbVersion:self._url.query&&self._url.query.gdbVersion,layer:self._url.query&&self._url.query.layer,token:self._getToken()});info.url=url+"/"+info.id+(_237?("?"+_237):"");info.objectId=_232;});self._resolve([_236],"onQueryAttachmentInfosComplete",_233,dfd);},error:function(err){self._resolve([err],null,_234,dfd,true);}});return dfd;},addAttachment:function(_238,_239,_23a,_23b){return this._sendAttachment("add",_238,_239,_23a,_23b);},updateAttachment:function(_23c,_23d,_23e,_23f,_240){_23e.appendChild(_179.create("input",{type:"hidden",name:"attachmentId",value:_23d}));return this._sendAttachment("update",_23c,_23e,_23f,_240);},deleteAttachments:function(_241,_242,_243,_244){var url=this._url.path+"/"+_241+"/deleteAttachments",dfd=new _177(_17d._dfdCanceller),self=this,_245={f:"json",attachmentIds:_242.join(",")};dfd._pendingDfd=_17c({url:url,content:lang.mixin(_245,this._url.query),callbackParamName:"callback",load:lang.hitch(this,function(_246){var _247=_246.deleteAttachmentResults;_247=_175.map(_247,function(_248){var res=new _191(_248);res.attachmentId=res.objectId;res.objectId=_241;return res;});self._resolve([_247],"onDeleteAttachmentsComplete",_243,dfd);}),error:function(err){self._resolve([err],null,_244,dfd,true);}},{usePost:true});return dfd;},addType:function(_249){var _24a=this.types;if(_24a){var _24b=_175.some(_24a,function(type){if(type.id==_249.id){return true;}return false;});if(_24b){return false;}else{_24a.push(_249);}}else{this.types=[_249];}this._typesDirty=true;return true;},deleteType:function(_24c){if(!this._collection){return;}var _24d=this.types;if(_24d){var _24e=-1;_175.some(_24d,function(type,_24f){if(type.id==_24c){_24e=_24f;return true;}return false;});if(_24e>-1){this._typesDirty=true;return _24d.splice(_24e,1)[0];}}},toJson:function(){var _250=this._json,json=lang.isString(_250)?_176.fromJson(_250):lang.clone(_250);if(!json){return;}json=json.layerDefinition?json:{layerDefinition:json};var _251=json.layerDefinition,_252=this._collection;if(_252&&this._typesDirty){_251.types=_175.map(this.types||[],function(type){return type.toJson();});var _253=this.renderer,_254=_251.drawingInfo;if(_254&&_253&&_253.declaredClass.indexOf("TemporalRenderer")===-1){_254.renderer=_253.toJson();}}var _255=null;if(!(_252&&!this._fcAdded)){_255={geometryType:_251.geometryType,features:this._convertFeaturesToJson(this.graphics,true)};}json.featureSet=lang.mixin({},json.featureSet||{},_255);if(_252){json.nextObjectId=this._nextId;_251.capabilities=this.capabilities;}return json;},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},_forceIdentity:function(_256){var self=this,path=this._url&&this._url.path;if((this.ownershipBasedAccessControlForFeatures||this.userIsAdmin)&&!this._getToken()&&path&&_17a.id&&_17a.id._hasPortalSession()&&_17a.id._doPortalSignIn(path)){_17a.id.getCredential(path).then(function(){self._findCredential();_256.call(self);},function(){_256.call(self);});}else{_256.call(this);}},_updateCaps:function(){var _257=this._editable,_258=lang.trim(this.capabilities||""),_259=_175.map((_258?_258.split(","):[]),lang.trim),caps=_175.map((_258?_258.toLowerCase().split(","):[]),lang.trim),_25a=_175.indexOf(caps,"editing"),cap,i,_25b,_25c={"Create":_175.indexOf(caps,"create"),"Update":_175.indexOf(caps,"update"),"Delete":_175.indexOf(caps,"delete")};if(_257&&_25a===-1){_259.push("Editing");}else{if(!_257&&_25a>-1){_25b=[_25a];for(cap in _25c){if(_25c[cap]>-1){_25b.push(_25c[cap]);}}_25b.sort();for(i=_25b.length-1;i>=0;i--){_259.splice(_25b[i],1);}}}this.capabilities=_259.join(",");},_counter:{value:0},_getUniqueId:function(){return this._counter.value++;},onSuspend:function(){this.inherited(arguments);this._toggleTime(false);var mode=this._mode;if(mode){mode.suspend();}},onResume:function(evt){this.inherited(arguments);this._toggleTime(true);this._updateMaxOffset();var mode=this._mode,map=this._map,_25d=this.renderer;if(evt.firstOccurrence){this.clearSelection();if(this.timeInfo){if(this._trackIdField||(_25d&&(_25d.latestObservationRenderer||_25d.trackRenderer))){this._trackManager=new _195(this);this._trackManager.initialize(map);}}this._zoomConnect=_174.connect(map,"onZoomEnd",this,this._updateMaxOffset);}if(mode){evt.firstOccurrence?mode.startup():mode.resume();}},_updateMaxOffset:function(){var map=this._map;if(map&&map.loaded){if(this._autoGeneralize){this._maxOffset=Math.floor(map.extent.getWidth()/map.width);}}},_toggleTime:function(_25e){var map=this._map;if(_25e&&this.timeInfo&&this.useMapTime&&map){this._mapTimeExtent=map.timeExtent;if(!this._timeConnect){this._timeConnect=_174.connect(map,"onTimeExtentChange",this,this._timeChangeHandler);}}else{this._mapTimeExtent=null;_174.disconnect(this._timeConnect);this._timeConnect=null;}},_timeChangeHandler:function(_25f){this._mapTimeExtent=_25f;var mode=this._mode;if(mode){mode.propertyChangeHandler(0);}},_getOffsettedTE:function(_260){var _261=this._timeOffset,_262=this._timeOffsetUnits;return (_260&&_261&&_262)?_260.offset(-1*_261,_262):_260;},_getTimeOverlap:function(_263,_264){if(_263&&_264){return _263.intersection(_264);}else{return _263||_264;}},_getTimeFilter:function(_265){var _266=this.getTimeDefinition(),_267=null,_268;if(_266||_267){_268=this._getTimeOverlap(_266,_267);if(!_268){return [false];}}if(_265){_265=_268?this._getTimeOverlap(_265,_268):_265;if(!_265){return [false];}}else{_265=_268;}return [true,_265];},_getAttributeFilter:function(_269){var _26a=this.getDefinitionExpression();if(_269){_269=_26a?"("+_26a+") AND ("+_269+")":_269;}else{_269=_26a;}return _269;},_applyQueryFilters:function(_26b){_26b.where=this._getAttributeFilter(_26b.where);_26b.maxAllowableOffset=this._maxOffset;if(this.timeInfo){var _26c=this._getTimeFilter(_26b.timeExtent);if(!_26c[0]){return false;}else{_26b.timeExtent=_26c[1];}}return true;},_add:function(_26d){var _26e=this._selectionSymbol,attr=_26d.attributes,_26f=this.visibilityField;if(_26e&&this._isSelOnly){_26d.setSymbol(_26e);}if(_26f&&attr&&attr.hasOwnProperty(_26f)){_26d[attr[_26f]?"show":"hide"]();}return this.add.apply(this,arguments);},_remove:function(){return this.remove.apply(this,arguments);},_canDoClientSideQuery:function(_270){var _271=[],map=this._map;if(this._isTable||!map){return;}if(_270.text||(_270.where&&_270.where!==this.getDefinitionExpression())){return;}var _272=this._isSnapshot,_273=this._isSelOnly;var _274=_270.geometry;if(_274){if(!_273&&_270.spatialRelationship===_187.SPATIAL_REL_INTERSECTS&&(_274.type==="extent"&&(_272||map.extent.contains(_274)))){_271.push(1);}else{return;}}var ids=_270.objectIds;if(ids){if(_272){_271.push(2);}else{var len=ids.length,mode=this._mode,_275=0,i;for(i=0;i<len;i++){if(mode._getFeature(ids[i])){_275++;}}if(_275===len){_271.push(2);}else{return;}}}if(this.timeInfo){var _276=_270.timeExtent,_277=this._mapTimeExtent;if(_272){if(_276){_271.push(3);}}else{if(_273){if(_276){return;}}else{if(_277){if(_175.indexOf(_271,2)!==-1){if(_276){_271.push(3);}}else{return;}}else{if(_271.length>0){if(_276){_271.push(3);}}else{if(_276){return;}}}}}}return _271.length>0?_271:null;},_doQuery:function(_278,_279,_27a){var _27b=[],mode=this._mode,_27c=this.objectIdField,i,len,_27d;if(_175.indexOf(_279,2)!==-1){_27b=[];var ids=_278.objectIds;len=ids.length;for(i=0;i<len;i++){var obj=mode._getFeature(ids[i]);if(obj){_27b.push(obj);}}if(_27b.length===0){return [];}}if(_175.indexOf(_279,1)!==-1){_27d=_27b.length>0?_27b:this.graphics;len=_27d.length;var _27e=_278.geometry._normalize(null,true);_27b=[];for(i=0;i<len;i++){var _27f=_27d[i],_280=_27f.geometry;if(_280){if(this.normalization&&_27e.length){if(_27e[0].intersects(_280)||_27e[1].intersects(_280)){_27b.push(_27f);}}else{if(_27e.intersects(_280)){_27b.push(_27f);}}}}if(_27b.length===0){return [];}}if(_175.indexOf(_279,3)!==-1){if(this.timeInfo){_27d=_27b.length>0?_27b:this.graphics;var time=_278.timeExtent,_281=this._filterByTime(_27d,time.startTime,time.endTime);_27b=_281.match;}}if(_27a){return _175.map(_27b,function(obj){return obj.attributes[_27c];},this);}else{return _27b;}},_filterByTime:function(_282,_283,_284){var _285=this._startTimeField,_286=this._endTimeField,_287;if(!this._twoTimeFields){_287=_285||_286;}var _288=_17b.isDefined,yea=[],nay=[],i,len=_282.length,_289,_28a;_283=_283?_283.getTime():-Infinity;_284=_284?_284.getTime():Infinity;if(_287){for(i=0;i<len;i++){_289=_282[i];_28a=_289.attributes;var time=_28a[_287];if(time>=_283&&time<=_284){yea.push(_289);}else{nay.push(_289);}}}else{for(i=0;i<len;i++){_289=_282[i];_28a=_289.attributes;var _28b=_28a[_285],end=_28a[_286];_28b=_288(_28b)?_28b:-Infinity;end=_288(end)?end:Infinity;if((_28b>=_283&&_28b<=_284)||(end>=_283&&end<=_284)||(_283>=_28b&&_284<=end)){yea.push(_289);}else{nay.push(_289);}}}return {match:yea,noMatch:nay};},_resolve:function(args,_28c,_28d,dfd,_28e){if(_28c){this[_28c].apply(this,args);}if(_28d){_28d.apply(null,args);}if(dfd){_17d._resDfd(dfd,args,_28e);}},_getShallowClone:function(_28f){var _290=new _187(),prop;for(prop in _28f){if(_28f.hasOwnProperty(prop)){_290[prop]=_28f[prop];}}return _290;},_query:function(type,_291,_292,_293,_294){var that=this,map=this._map,dfd=new _177(_17d._dfdCanceller),_295=_292;var _296=function(_297,_298){if(!_298&&type==="execute"&&!that._isTable){var _299=_297.features,mode=that._mode,_29a=that.objectIdField,il=_299.length,i;for(i=il-1;i>=0;i--){var oid=_299[i].attributes[_29a];var _29b=mode._getFeature(oid);if(_29b){_299.splice(i,1,_29b);}}}that._resolve([_297],_291,_293,dfd);};if(type!=="executeRelationshipQuery"){_295=this._getShallowClone(_292);_295.outFields=this._getOutFields();_295.returnGeometry=(!map&&_292.hasOwnProperty("returnGeometry"))?_292.returnGeometry:true;var _29c;if(map){_295.outSpatialReference=new _17e(map.spatialReference.toJson());}if(!this._applyQueryFilters(_295)){switch(type){case "execute":_29c=new _188({features:[]});break;case "executeForIds":_29c=[];break;case "executeForCount":_29c=0;break;}_296(_29c,true);return dfd;}var _29d=this._canDoClientSideQuery(_295);if(_29d){var _29e=this._doQuery(_295,_29d,(type==="executeForIds"||type==="executeForCount"));switch(type){case "execute":_29c=new _188();_29c.features=_29e;break;case "executeForIds":_29c=_29e;break;case "executeForCount":_29c=_29e.length;break;}_296(_29c,true);return dfd;}}if(this._collection){var err=new Error("FeatureLayer::_query - "+this.invalidParams);this._resolve([err],null,_294,dfd,true);return dfd;}if(this._ts){_295._ts=(new Date()).getTime();}var temp=dfd._pendingDfd=this._task[type](_295);temp.addCallbacks(_296,function(err){that._resolve([err],null,_294,dfd,true);});return dfd;},_convertFeaturesToJson:function(_29f,_2a0,_2a1,_2a2){var json=[],_2a3=this._selectionSymbol,_2a4=this.visibilityField,i,_2a5,_2a6=this.objectIdField;if(this.loaded&&(_2a1||_2a2)){_2a5=_175.filter(this.fields,function(_2a7){return (_2a7.editable===false)&&(!_2a2||(_2a7.name!==_2a6));});}for(i=0;i<_29f.length;i++){var _2a8=_29f[i],_2a9={},_2aa=_2a8.geometry,attr=_2a8.attributes,_2ab=_2a8.symbol;if(_2aa&&(!_2a2||!this.loaded||this.allowGeometryUpdates)){_2a9.geometry=_2aa.toJson();}if(_2a4){_2a9.attributes=attr=lang.mixin({},attr);attr[_2a4]=_2a8.visible?1:0;}else{if(attr){_2a9.attributes=lang.mixin({},attr);}}if(_2a9.attributes&&_2a5&&_2a5.length){_175.forEach(_2a5,function(_2ac){delete _2a9.attributes[_2ac.name];});}if(_2ab&&(_2ab!==_2a3)){_2a9.symbol=_2ab.toJson();}json.push(_2a9);}return _2a0?json:_176.toJson(json);},_selectHandler:function(_2ad,_2ae,_2af,_2b0,dfd){var _2b1,ctor=this.constructor;switch(_2ae){case ctor.SELECTION_NEW:this.clearSelection(true);_2b1=true;break;case ctor.SELECTION_ADD:_2b1=true;break;case ctor.SELECTION_SUBTRACT:_2b1=false;break;}var i,_2b2=_2ad.features,mode=this._mode,_2b3=[],_2b4=this.objectIdField,_2b5,oid;if(_2b1){for(i=0;i<_2b2.length;i++){_2b5=_2b2[i];oid=_2b5.attributes[_2b4];var _2b6=mode._addFeatureIIf(oid,_2b5);_2b3.push(_2b6);this._selectFeatureIIf(oid,_2b6,mode);}}else{for(i=0;i<_2b2.length;i++){_2b5=_2b2[i];oid=_2b5.attributes[_2b4];this._unSelectFeatureIIf(oid,mode);var _2b7=mode._removeFeatureIIf(oid);_2b3.push(_2b7||_2b5);}}if(this._isSelOnly){mode._applyTimeFilter(true);}this._resolve([_2b3,_2ae,_2ad.exceededTransferLimit?{queryLimitExceeded:true}:null],"onSelectionComplete",_2af,dfd);if(_2ad.exceededTransferLimit){this.onQueryLimitExceeded();}},_selectFeatureIIf:function(oid,_2b8,mode){var _2b9=this._selectedFeatures,_2ba=_2b9[oid];if(!_2ba){mode._incRefCount(oid);_2b9[oid]=_2b8;if(!this._isTable){this._setSelectSymbol(_2b8);}}return _2ba||_2b8;},_unSelectFeatureIIf:function(oid,mode){var _2bb=this._selectedFeatures[oid];if(_2bb){mode._decRefCount(oid);delete this._selectedFeatures[oid];if(!this._isTable){this._setUnSelectSymbol(_2bb);}}return _2bb;},_isSelected:function(_2bc){},_setSelectSymbol:function(_2bd){var _2be=this._selectionSymbol;if(_2be&&!this._isSelOnly){_2bd.setSymbol(_2be);}},_setUnSelectSymbol:function(_2bf){var _2c0=this._selectionSymbol;if(_2c0&&!this._isSelOnly){if(_2c0===_2bf.symbol){_2bf.setSymbol(null,true);}}},_getOutFields:function(){var _2c1=_175.filter([this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields),function(_2c2,_2c3,arr){return !!_2c2&&(_175.indexOf(arr,_2c2)===_2c3);});var _2c4=lang.clone(this._outFields);if(_2c4){if(_175.indexOf(_2c4,"*")!==-1){return _2c4;}_175.forEach(_2c1,function(_2c5){if(_175.indexOf(_2c4,_2c5)===-1){_2c4.push(_2c5);}});return _2c4;}else{return _2c1;}},_checkFields:function(_2c6){var _2c7=_2c6||this._getOutFields();_175.forEach(_2c7,function(_2c8){if(_2c8==="*"){return;}if(!this._getField(_2c8)){console.debug("esri.layers.FeatureLayer: "+_17b.substitute({url:this.url,field:_2c8},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]"));}},this);if(!_2c6&&!this._isTable&&!this._fserver&&!this._collection){var _2c9=_175.some(this.fields,function(_2ca){return (_2ca&&_2ca.type==="esriFieldTypeGeometry")?true:false;});if(!_2c9){console.debug("esri.layers.FeatureLayer: "+_17b.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]"));}}},_fixRendererFields:function(){var _2cb=this.renderer;if(_2cb&&this.fields.length>0){var _2cc=_175.filter([_2cb,_2cb.observationRenderer,_2cb.latestObservationRenderer,_2cb.trackRenderer],_17b.isDefined);var _2cd=[];_175.forEach(_2cc,function(rnd){var _2ce,_2cf;_2cf=rnd.attributeField;if(_2cf&&!lang.isFunction(_2cf)){_2ce=!this._getField(_2cf)&&this._getField(_2cf,true);if(_2ce){rnd.attributeField=_2ce.name;}}_2cf=rnd.attributeField2;if(_2cf){_2ce=!this._getField(_2cf)&&this._getField(_2cf,true);if(_2ce){rnd.attributeField2=_2ce.name;}}_2cf=rnd.attributeField3;if(_2cf){_2ce=!this._getField(_2cf)&&this._getField(_2cf,true);if(_2ce){rnd.attributeField3=_2ce.name;}}if(!lang.isFunction(rnd.attributeField)){_2cd.push(rnd.attributeField);}_2cd.push(rnd.attributeField2);_2cd.push(rnd.attributeField3);},this);this._rendererFields=_175.filter(_2cd,_17b.isDefined);}},_getField:function(_2d0,_2d1){var _2d2=this.fields;if(_2d2.length===0){return null;}var _2d3;if(_2d1){_2d0=_2d0.toLowerCase();}_175.some(_2d2,function(_2d4){var _2d5=false;if(_2d1){_2d5=(_2d4&&_2d4.name.toLowerCase()===_2d0)?true:false;}else{_2d5=(_2d4&&_2d4.name===_2d0)?true:false;}if(_2d5){_2d3=_2d4;}return _2d5;});return _2d3;},_getDateOpts:function(){if(!this._dtOpts){var _2d6=_175.map(_175.filter(this.fields,function(_2d7){return !!(_2d7&&_2d7.type==="esriFieldTypeDate");}),function(_2d8){return _2d8.name;});this._dtOpts={properties:_2d6};}return this._dtOpts;},_applyNormalized:function(_2d9,_2da){if(_2d9&&_2da){_175.forEach(_2d9,function(_2db,_2dc){if(_2db&&_2da[_2dc]){_2db.setGeometry(_2da[_2dc]);}});}},_editHandler:function(_2dd,adds,_2de,_2df,_2e0,dfd){var _2e1=_2dd.addResults,_2e2=_2dd.updateResults,_2e3=_2dd.deleteResults,i,_2e4,oid,_2e5,attr,_2e6=this.objectIdField,mode=this._mode,_2e7=this._isTable;var _2e8=this.editFieldsInfo,_2e9=this._getOutFields()||[],_2ea=_2e8&&_2e8.creatorField,_2eb=_2e8&&_2e8.creationDateField,_2ec=_2e8&&_2e8.editorField,_2ed=_2e8&&_2e8.editDateField,_2ee=_2e8&&_2e8.realm;if(_175.indexOf(_2e9,"*")===-1){if(_2ea&&_175.indexOf(_2e9,_2ea)===-1){_2ea=null;}if(_2eb&&_175.indexOf(_2e9,_2eb)===-1){_2eb=null;}if(_2ec&&_175.indexOf(_2e9,_2ec)===-1){_2ec=null;}if(_2ed&&_175.indexOf(_2e9,_2ed)===-1){_2ed=null;}}var _2ef=(_2eb||_2ed)?(new Date()).getTime():null,_2f0=(_2ea||_2ec)?this.getUserId():undefined;if(_2f0&&_2ee){_2f0=_2f0+"@"+_2ee;}if(_2e1){for(i=0;i<_2e1.length;i++){_2e1[i]=new _191(_2e1[i]);if(_2e7){continue;}_2e4=_2e1[i];if(_2e4.success){oid=_2e4.objectId;_2e5=adds[i];var gl=_2e5._graphicsLayer;if(gl&&gl!==this){gl.remove(_2e5);}attr=_2e5.attributes||{};attr[_2e6]=oid;if(_2ea){attr[_2ea]=_2f0;}if(_2ec){attr[_2ec]=_2f0;}if(_2eb){attr[_2eb]=_2ef;}if(_2ed){attr[_2ed]=_2ef;}_2e5.setAttributes(attr);if(mode._init){mode.drawFeature(_2e5);}}}}if(_2e2){for(i=0;i<_2e2.length;i++){_2e2[i]=new _191(_2e2[i]);if(_2e7){continue;}_2e4=_2e2[i];if(_2e4.success){oid=_2e4.objectId;_2e5=_2de[oid];var _2f1=mode._getFeature(oid);if(_2f1){if(_2f1.geometry!==_2e5.geometry){_2f1.setGeometry(_18a.fromJson(_2e5.geometry.toJson()));}this._repaint(_2f1,oid);}_2e5=_2f1||_2e5;attr=_2e5.attributes||{};if(_2ec){attr[_2ec]=_2f0;}if(_2ed){attr[_2ed]=_2ef;}_2e5.setAttributes(attr);}}}if(_2e3){var _2f2=[];for(i=0;i<_2e3.length;i++){_2e3[i]=new _191(_2e3[i]);if(_2e7){continue;}_2e4=_2e3[i];if(_2e4.success){oid=_2e4.objectId;_2e5=mode._getFeature(oid);if(_2e5){if(this._unSelectFeatureIIf(oid,mode)){_2f2.push(_2e5);}_2e5._count=0;mode._removeFeatureIIf(oid);}}}if(_2f2.length>0){this.onSelectionComplete(_2f2,this.constructor.SELECTION_SUBTRACT);}}this._resolve([_2e1,_2e2,_2e3],"onEditsComplete",_2df,dfd);},_sendAttachment:function(type,_2f3,_2f4,_2f5,_2f6){var _2f7=(type==="add")?"addAttachment":"updateAttachment",url=this._url.path+"/"+_2f3+"/"+_2f7,self=this;var dfd=_17c({url:url,form:_2f4,content:lang.mixin(this._url.query,{f:"json",token:this._getToken()||undefined}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(_2f8){var _2f9=(type==="add")?"addAttachmentResult":"updateAttachmentResult",_2fa=(type==="add")?"onAddAttachmentComplete":"onUpdateAttachmentComplete",_2fb=new _191(_2f8[_2f9]);_2fb.attachmentId=_2fb.objectId;_2fb.objectId=_2f3;self._resolve([_2fb],_2fa,_2f5);return _2fb;}).addErrback(function(_2fc){self._resolve([_2fc],null,_2f6,null,true);});return dfd;},_repaint:function(_2fd,oid,_2fe){oid=_17b.isDefined(oid)?oid:_2fd.attributes[this.objectIdField];if(!(oid in this._selectedFeatures)||!this._selectionSymbol){_2fd.setSymbol(_2fd.symbol,_2fe);}},_getKind:function(_2ff){var _300=this._trackManager;if(_300){return _300.isLatestObservation(_2ff)?1:0;}return 0;}});lang.mixin(_196,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});_18b._createWrappers(_196);if(has("extend-esri")){lang.setObject("layers.FeatureLayer",_196,_17a);}return _196;});},"dojo/DeferredList":function(){define(["./_base/kernel","./_base/Deferred","./_base/array"],function(dojo,_301,_302){dojo.DeferredList=function(list,_303,_304,_305,_306){var _307=[];_301.call(this);var self=this;if(list.length===0&&!_303){this.resolve([0,[]]);}var _308=0;_302.forEach(list,function(item,i){item.then(function(_309){if(_303){self.resolve([i,_309]);}else{_30a(true,_309);}},function(_30b){if(_304){self.reject(_30b);}else{_30a(false,_30b);}if(_305){return null;}throw _30b;});function _30a(_30c,_30d){_307[i]=[_30c,_30d];_308++;if(_308===list.length){self.resolve(_307);}};});};dojo.DeferredList.prototype=new _301();dojo.DeferredList.prototype.gatherResults=function(_30e){var d=new dojo.DeferredList(_30e,false,true,false);d.addCallback(function(_30f){var ret=[];_302.forEach(_30f,function(_310){ret.push(_310[1]);});return ret;});return d;};return dojo.DeferredList;});},"esri/layers/KMLFolder":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","esri/lang"],function(_311,lang,has,_312,_313){var _314=_311(null,{declaredClass:"esri.layers.KMLFolder",constructor:function(json){lang.mixin(this,json);if(_313.isDefined(this.visibility)){this.visible=!!this.visibility;}}});if(has("extend-esri")){lang.setObject("layers.KMLFolder",_314,_312);}return _314;});},"esri/layers/TrackManager":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","esri/kernel","esri/graphic","esri/geometry/Polyline","esri/layers/GraphicsLayer"],function(_315,lang,_316,has,_317,_318,_319,_31a){var _31b=_315(null,{declaredClass:"esri.layers._TrackManager",constructor:function(_31c){this.layer=_31c;this.trackMap={};},initialize:function(map){this.map=map;var _31d=this.layer,_31e=_31d.renderer.trackRenderer;if(_31e&&(_31d.geometryType==="esriGeometryPoint")){var _31f=(this.container=new _31a._GraphicsLayer({id:_31d.id+"_tracks",_child:true}));_31f.loaded=true;_31f.onLoad(_31f);_31f._setMap(map,_31d._div);_31f.setRenderer(_31e);}},addFeatures:function(_320){var tkid,_321=this.trackMap,_322=this.layer,_323=_322._trackIdField;_316.forEach(_320,function(_324){var _325=_324.attributes;tkid=_325[_323];var ary=(_321[tkid]=(_321[tkid]||[]));ary.push(_324);});var _326=_322._startTimeField,_327=_322.objectIdField;var _328=function(a,b){var _329=a.attributes[_326],_32a=b.attributes[_326];if(_329===_32a){return (a.attributes[_327]<b.attributes[_327])?-1:1;}else{return (_329<_32a)?-1:1;}};for(tkid in _321){_321[tkid].sort(_328);}},drawTracks:function(){var _32b=this.container;if(!_32b){return;}var _32c=this.trackMap,sr=this.map.spatialReference,tkid,ary,path,i,_32d,_32e=this.layer._trackIdField,_32f;for(tkid in _32c){ary=_32c[tkid];path=[];for(i=ary.length-1;i>=0;i--){_32d=ary[i].geometry;if(_32d){path.push([_32d.x,_32d.y]);}}_32f={};_32f[_32e]=tkid;if(path.length>0){_32b.add(new _318(new _319({paths:[path],spatialReference:sr}),null,_32f));}}},moveLatestToFront:function(){_316.forEach(this.getLatestObservations(),function(_330){var _331=_330._shape;_331&&_331._moveToFront();this._repaint(_330,null,true);},this.layer);},getLatestObservations:function(){var _332=[];if(!this.layer.renderer.latestObservationRenderer){return _332;}var _333=this.trackMap,tkid;for(tkid in _333){var ary=_333[tkid];_332.push(ary[ary.length-1]);}return _332;},clearTracks:function(){var _334=this.getLatestObservations();this.trackMap={};var _335=this.container;if(_335){_335.clear();}_316.forEach(_334,function(_336){this._repaint(_336,null,true);},this.layer);},isLatestObservation:function(_337){var _338=this.layer._trackIdField;var _339=this.trackMap[_337.attributes[_338]];if(_339){return (_339[_339.length-1]===_337);}return false;},destroy:function(){var _33a=this.container;if(_33a){_33a.clear();_33a._unsetMap(this.map,this.layer._div);this.container=null;}this.map=null;this.layer=null;this.trackMap=null;}});if(has("extend-esri")){lang.setObject("layers._TrackManager",_31b,_317);}return _31b;});},"esri/layers/WMSLayer":function(){define(["require","dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","esri/kernel","esri/request","esri/urlUtils","esri/SpatialReference","esri/geometry/Extent","esri/layers/DynamicMapServiceLayer","esri/layers/WMSLayerInfo","dojo/query"],function(_33b,_33c,_33d,lang,_33e,has,_33f,_340,_341,_342,_343,_344,_345){var _346=_33d([_344],{declaredClass:"esri.layers.WMSLayer",_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],constructor:function(url,_347){url=this._stripParameters(url,["version","service","request","bbox","format","height","width","layers","srs","crs","styles","transparent","bgcolor","exceptions","time","elevation","sld","wfs"]);this.url=url;this._url=_341.urlToObject(url);this._getCapabilitiesURL=url;this._initLayer=lang.hitch(this,this._initLayer);this._parseCapabilities=lang.hitch(this,this._parseCapabilities);this._getCapabilitiesError=lang.hitch(this,this._getCapabilitiesError);if(_347){this.imageFormat=this._getImageFormat(_347.format);this.imageTransparency=(_347.transparent===false)?false:true;this.visibleLayers=_347.visibleLayers?_347.visibleLayers:[];if(_347.resourceInfo){this._readResourceInfo(_347.resourceInfo);}else{this._getCapabilities();}}else{this.imageFormat="image/png";this.imageTransparency=true;this.visibleLayers=[];this._getCapabilities();}this._blankImageURL=_33b.toUrl("esri/layers")+"/../images/pixel.png";},setVisibleLayers:function(_348){_348=this._checkVisibleLayersList(_348);this.visibleLayers=_348?_348:[];this.refresh(true);},setImageFormat:function(_349){this.imageFormat=this._getImageFormat(_349);this.refresh(true);},setImageTransparency:function(_34a){this.imageTransparency=_34a;this.refresh(true);},getImageUrl:function(_34b,_34c,_34d,_34e){if(!this.visibleLayers||this.visibleLayers.length===0){_34e(this._blankImageURL);return;}var wkid=_34b.spatialReference.wkid;if(_33e.some(this._WEB_MERCATOR,function(el){return el==wkid;})){var _34f=_33e.filter(this.spatialReferences,function(el){return (_33e.some(this._WEB_MERCATOR,function(el2){return el2==el;}));},this);if(_34f.length==0){_34f=_33e.filter(this.spatialReferences,function(el){return (_33e.some(this._WORLD_MERCATOR,function(el2){return el2==el;}));},this);}if(_34f.length>0){wkid=_34f[0];}else{wkid=this._WEB_MERCATOR[0];}}var list=_33e.filter(this.spatialReferences,function(el){return el!==wkid;});this.spatialReferences=list;this.spatialReferences.unshift(wkid);var xmin=_34b.xmin;var xmax=_34b.xmax;var ymin=_34b.ymin;var ymax=_34b.ymax;var _350={};_350.SERVICE="WMS";_350.REQUEST="GetMap";_350.FORMAT=this.imageFormat;_350.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE";_350.STYLES="";_350.VERSION=this.version;_350.LAYERS=this.visibleLayers?this.visibleLayers.toString():null;_350.WIDTH=_34c;_350.HEIGHT=_34d;if(this.maxWidth<_34c){_350.WIDTH=this.maxWidth;}if(this.maxHeight<_34d){_350.HEIGHT=this.maxHeight;}var _351=wkid?wkid:NaN;if(!isNaN(_351)){if(this.version=="1.3.0"){_350.CRS="EPSG:"+_351;}else{_350.SRS="EPSG:"+_351;}}if(this.version=="1.3.0"&&this._useLatLong(_351)){_350.BBOX=ymin+","+xmin+","+ymax+","+xmax;}else{_350.BBOX=xmin+","+ymin+","+xmax+","+ymax;}var _352=this.getMapURL,key;_352+=(_352.indexOf("?")==-1)?"?":"";for(key in _350){_352+=(_352.substring(_352.length-1,_352.length)=="?")?"":"&";_352+=key+"="+_350[key];}_34e(_341.addProxy(_352));},_initLayer:function(_353,io){this.spatialReference=new _342(this.extent.spatialReference);this.initialExtent=new _343(this.extent);this.fullExtent=new _343(this.extent);this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);this.loaded=true;this.onLoad(this);var _354=this._loadCallback;if(_354){delete this._loadCallback;_354(this);}},_readResourceInfo:function(_355){if(!_355.extent){console.error("esri.layers.WMSLayer: unable to find the 'extent' property in resourceInfo");return;}if(!_355.layerInfos){console.error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo");return;}this.extent=_355.extent;this.allExtents[0]=_355.extent;this.layerInfos=_355.layerInfos;this.description=_355.description?_355.description:"";this.copyright=_355.copyright?_355.copyright:"";this.title=_355.title?_355.title:"";this.getMapURL=_355.getMapURL?_355.getMapURL:this._getCapabilitiesURL;this.version=_355.version?_355.version:"1.3.0";this.maxWidth=_355.maxWidth?_355.maxWidth:5000;this.maxHeight=_355.maxHeight?_355.maxHeight:5000;this.spatialReferences=_355.spatialReferences?_355.spatialReferences:[];this.imageFormat=this._getImageFormat(_355.format);this.setScaleRange(_355.minScale,_355.maxScale);this._initLayer();},_getCapabilities:function(){var _356=this._url.query?this._url.query:{};_356.SERVICE="WMS";_356.REQUEST="GetCapabilities";var uri=this._url.path+"?",key;for(key in _356){uri+=(uri.substring(uri.length-1,uri.length)=="?")?"":"&";uri+=key+"="+_356[key];}var _357=_340({url:uri,handleAs:"xml",load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:false});},_parseCapabilities:function(xml){if(!xml){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)");return;}this.version=this._getAttributeValue("WMS_Capabilities","version",xml,null);if(!this.version){this.version=this._getAttributeValue("WMT_MS_Capabilities","version",xml,"1.3.0");}var _358=this._getTag("Service",xml);this.title=this._getTagValue("Title",_358,"");if(!this.title||this.title.length==0){this.title=this._getTagValue("Name",_358,"");}this.copyright=this._getTagValue("AccessConstraints",_358,"");this.description=this._getTagValue("Abstract",_358,"");this.maxWidth=parseInt(this._getTagValue("MaxWidth",_358,5000),10);this.maxHeight=parseInt(this._getTagValue("MaxHeight",_358,5000),10);var _359=this._getTag("Layer",xml);if(!_359){this._getCapabilitiesError({"error":{"message":"Response does not contain any layers."}});return;}var _35a=this._getLayerInfo(_359);if(_35a){this.layerInfos=_35a.subLayers;if(!this.layerInfos||this.layerInfos.length==0){this.layerInfos=[_35a];}this.extent=_35a.extent;this.allExtents=_35a.allExtents;this.spatialReferences=_35a.spatialReferences;if(this.spatialReferences.length==0&&this.layerInfos.length>0){this.spatialReferences=this.layerInfos[0].spatialReferences;}}this.getMapURL=this._getCapabilitiesURL;var _35b=_33c.query("DCPType",this._getTag("GetMap",xml));if(_35b&&_35b.length>0){var _35c=_33c.query("HTTP",_35b[0]);if(_35c&&_35c.length>0){var _35d=_33c.query("Get",_35c[0]);if(_35d&&_35d.length>0){var _35e=this._getAttributeValue("OnlineResource","xlink:href",_35d[0],null);if(_35e){if(_35e.indexOf("&")==(_35e.length-1)){_35e=_35e.substring(0,_35e.length-1);}this.getMapURL=_35e;}}}}this.getMapFormats=[];if(_33c.query("Operation",xml).length==0){_33e.forEach(_33c.query("Format",this._getTag("GetMap",xml)),function(_35f){this.getMapFormats.push(_35f.text?_35f.text:_35f.textContent);},this);}else{_33e.forEach(_33c.query("Operation",xml),function(_360){if(_360.getAttribute("name")=="GetMap"){_33e.forEach(_33c.query("Format",_360),function(_361){this.getMapFormats.push(_361.text?_361.text:_361.textContent);},this);}},this);}if(!_33e.some(this.getMapFormats,function(el){return el.indexOf(this.imageFormat)>-1;},this)){this.imageFormat=this.getMapFormats[0];}this._initLayer();},_getCapabilitiesError:function(_362,io){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed.",_362);},_getLayerInfo:function(_363){if(!_363){return null;}var _364=new _345();_364.name="";_364.title="";_364.description="";_364.allExtents=[];_364.spatialReferences=[];_364.subLayers=[];var _365=this._getTag("LatLonBoundingBox",_363);if(_365){_364.allExtents[0]=this._getExtent(_365,4326);}var _366=this._getTag("EX_GeographicBoundingBox",_363);if(_366){var _367=new _343(0,0,0,0,new _342({wkid:4326}));_367.xmin=parseFloat(this._getTagValue("westBoundLongitude",_366,0));_367.ymin=parseFloat(this._getTagValue("southBoundLatitude",_366,0));_367.xmax=parseFloat(this._getTagValue("eastBoundLongitude",_366,0));_367.ymax=parseFloat(this._getTagValue("northBoundLatitude",_366,0));_364.allExtents[0]=_367;}_364.extent=_364.allExtents[0];var _368=(_33e.indexOf(["1.0.0","1.1.0","1.1.1"],this.version)>-1)?"SRS":"CRS";_33e.forEach(_363.childNodes,function(_369){if(_369.nodeName=="Name"){_364.name=(_369.text?_369.text:_369.textContent)||"";}else{if(_369.nodeName=="Title"){_364.title=(_369.text?_369.text:_369.textContent)||"";}else{if(_369.nodeName=="Abstract"){_364.description=(_369.text?_369.text:_369.textContent)||"";}else{if(_369.nodeName=="BoundingBox"){var _36a=_369.getAttribute(_368),wkid;if(_36a&&_36a.indexOf("EPSG:")===0){wkid=parseInt(_36a.substring(5),10);if(wkid!==0&&!isNaN(wkid)){var _36b;if(this.version=="1.3.0"){_36b=this._getExtent(_369,wkid,this._useLatLong(wkid));}else{_36b=this._getExtent(_369,wkid);}_364.allExtents[wkid]=_36b;if(!_364.extent){_364.extent=_36b;}}}else{if(_36a&&_36a.indexOf("CRS:")===0){wkid=parseInt(_36a.substring(4),10);if(wkid!==0&&!isNaN(wkid)){if(this._CRS_TO_EPSG[wkid]){wkid=this._CRS_TO_EPSG[wkid];}_364.allExtents[wkid]=this._getExtent(_369,wkid);}}else{wkid=parseInt(_36a,10);if(wkid!==0&&!isNaN(wkid)){_364.allExtents[wkid]=this._getExtent(_369,wkid);}}}}else{if(_369.nodeName==_368){var _36c=_369.text?_369.text:_369.textContent;var arr=_36c.split(" ");_33e.forEach(arr,function(val){if(val.indexOf(":")>-1){val=parseInt(val.split(":")[1],10);}else{val=parseInt(val,10);}if(val!==0&&!isNaN(val)){if(this._CRS_TO_EPSG[val]){val=this._CRS_TO_EPSG[val];}if(_33e.indexOf(_364.spatialReferences,val)==-1){_364.spatialReferences.push(val);}}},this);}else{if(_369.nodeName=="Style"){var _36d=this._getTag("LegendURL",_369);if(_36d){var _36e=this._getTag("OnlineResource",_36d);if(_36e){_364.legendURL=_36e.getAttribute("xlink:href");}}}else{if(_369.nodeName==="Layer"){_364.subLayers.push(this._getLayerInfo(_369));}}}}}}}},this);return _364;},_getImageFormat:function(_36f){var _370=_36f?_36f.toLowerCase():"";switch(_370){case "jpg":return "image/jpeg";case "bmp":return "image/bmp";case "gif":return "image/gif";case "svg":return "image/svg+xml";default:return "image/png";}},getImageFormat:function(){var _371=this.imageFormat?this.imageFormat.toLowerCase():"";switch(_371){case "image/jpeg":return "jpg";case "image/bmp":return "bmp";case "image/gif":return "gif";case "image/svg+xml":return "svg";default:return "png";}},_getExtent:function(_372,wkid,_373){var _374;if(_372){_374=new _343();var minx=parseFloat(_372.getAttribute("minx"));var miny=parseFloat(_372.getAttribute("miny"));var maxx=parseFloat(_372.getAttribute("maxx"));var maxy=parseFloat(_372.getAttribute("maxy"));if(_373){_374.xmin=isNaN(miny)?((-1)*Number.MAX_VALUE):miny;_374.ymin=isNaN(minx)?((-1)*Number.MAX_VALUE):minx;_374.xmax=isNaN(maxy)?Number.MAX_VALUE:maxy;_374.ymax=isNaN(maxx)?Number.MAX_VALUE:maxx;}else{_374.xmin=isNaN(minx)?((-1)*Number.MAX_VALUE):minx;_374.ymin=isNaN(miny)?((-1)*Number.MAX_VALUE):miny;_374.xmax=isNaN(maxx)?Number.MAX_VALUE:maxx;_374.ymax=isNaN(maxy)?Number.MAX_VALUE:maxy;}_374.spatialReference=new _342({wkid:wkid});}return _374;},_useLatLong:function(wkid){var _375,i;for(i=0;i<this._REVERSED_LAT_LONG_RANGES.length;i++){var _376=this._REVERSED_LAT_LONG_RANGES[i];if(wkid>=_376[0]&&wkid<=_376[1]){_375=true;break;}}return _375;},_getTag:function(_377,xml){var tags=_33c.query(_377,xml);if(tags&&tags.length>0){return tags[0];}else{return null;}},_getTagValue:function(_378,xml,_379){var _37a=_33c.query(_378,xml);if(_37a&&_37a.length>0){if(_37a[0].text){return _37a[0].text;}else{return _37a[0].textContent;}}else{return _379;}},_getAttributeValue:function(_37b,_37c,xml,_37d){var _37e=_33c.query(_37b,xml);if(_37e&&_37e.length>0){return _37e[0].getAttribute(_37c);}else{return _37d;}},_checkVisibleLayersList:function(_37f){if(_37f&&_37f.length>0&&this.layerInfos&&this.layerInfos.length>0){if((typeof _37f[0])=="number"){var list=[];_33e.forEach(_37f,function(pos){if(pos<this.layerInfos.length){list.push(this.layerInfos[pos].name);}},this);_37f=list;}}return _37f;},_stripParameters:function(url,_380){var obj=_341.urlToObject(url),prop,qs=[];for(prop in obj.query){if(_33e.indexOf(_380,prop.toLowerCase())===-1){qs.push(prop+"="+obj.query[prop]);}}return obj.path+(qs.length?("?"+qs.join("&")):"");}});if(has("extend-esri")){lang.setObject("layers.WMSLayer",_346,_33f);}return _346;});},"esri/layers/SnapshotMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","esri/SpatialReference","esri/tasks/query","esri/layers/RenderMode"],function(_381,lang,has,_382,_383,_384,_385){var _386=_381([_385],{declaredClass:"esri.layers._SnapshotMode",constructor:function(_387){this.featureLayer=_387;this._featureMap={};this._drawFeatures=lang.hitch(this,this._drawFeatures);this._queryErrorHandler=lang.hitch(this,this._queryErrorHandler);},startup:function(){if(this.featureLayer._collection){this._applyTimeFilter();}else{this._fetchAll();}},propertyChangeHandler:function(type){if(this._init){if(type){if(this.featureLayer._collection){console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id = "+this.featureLayer.id);}else{this._fetchAll();}}else{this._applyTimeFilter();}}},drawFeature:function(_388){var _389=this.featureLayer,_38a=_389.objectIdField,oid=_388.attributes[_38a];this._addFeatureIIf(oid,_388);this._incRefCount(oid);},resume:function(){this.propertyChangeHandler(0);},refresh:function(){var _38b=this.featureLayer;if(_38b._collection){_38b._fireUpdateStart();_38b._refresh(true);_38b._fireUpdateEnd();}else{this._fetchAll();}},_getRequestId:function(_38c){var id="_"+_38c.name+_38c.layerId+_38c._ulid;return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_fetchAll:function(){var _38d=this.featureLayer;if(_38d._collection){return;}_38d._fireUpdateStart();this._clearIIf();this._sendRequest();},_sendRequest:function(){var map=this.map,_38e=this.featureLayer,_38f=_38e.getDefinitionExpression();var _390=new _384();_390.outFields=_38e._getOutFields();_390.where=_38f||"1=1";_390.returnGeometry=true;_390.outSpatialReference=new _383(map.spatialReference.toJson());_390.timeExtent=_38e.getTimeDefinition();_390.maxAllowableOffset=_38e._maxOffset;if(_38e._ts){_390._ts=(new Date()).getTime();}var _391;if(_38e._usePatch){_391=this._getRequestId(_38e);this._cancelPendingRequest(null,_391);}_38e._task.execute(_390,this._drawFeatures,this._queryErrorHandler,_391);},_drawFeatures:function(_392){this._purgeRequests();var _393=_392.features,_394=this.featureLayer,_395=_394.objectIdField,i,len=_393.length,_396,oid;for(i=0;i<len;i++){_396=_393[i];oid=_396.attributes[_395];this._addFeatureIIf(oid,_396);this._incRefCount(oid);}this._applyTimeFilter(true);_394._fireUpdateEnd(null,_392.exceededTransferLimit?{queryLimitExceeded:true}:null);if(_392.exceededTransferLimit){_394.onQueryLimitExceeded();}},_queryErrorHandler:function(err){this._purgeRequests();var _397=this.featureLayer;_397._errorHandler(err);_397._fireUpdateEnd(err);}});if(has("extend-esri")){lang.setObject("layers._SnapshotMode",_386,_382);}return _386;});},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","esri/layers/RenderMode"],function(_398,lang,has,_399,_39a){var _39b=_398([_39a],{declaredClass:"esri.layers._SelectionMode",constructor:function(_39c){this.featureLayer=_39c;this._featureMap={};},propertyChangeHandler:function(type){if(this._init&&type===0){this._applyTimeFilter();}},resume:function(){this.propertyChangeHandler(0);}});if(has("extend-esri")){lang.setObject("layers._SelectionMode",_39b,_399);}return _39b;});},"esri/layers/GridLayout":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","esri/kernel","esri/SpatialReference","esri/geometry/Extent","esri/geometry/Polyline"],function(_39d,lang,_39e,has,_39f,_3a0,_3a1,_3a2){var _3a3=_39d(null,{declaredClass:"esri.layers._GridLayout",constructor:function(_3a4,_3a5,_3a6,_3a7){this.origin=_3a4;this.cellWidth=_3a5.width;this.cellHeight=_3a5.height;this.mapWidth=_3a6.width;this.mapHeight=_3a6.height;this.srInfo=_3a7;},setResolution:function(_3a8){this._resolution=(_3a8.xmax-_3a8.xmin)/this.mapWidth;if(this.srInfo){var _3a9=Math.round((2*this.srInfo.valid[1])/this._resolution),_3aa=Math.round(_3a9/this.cellWidth);this._frameStats=[_3aa,0,_3aa-1];}},getCellCoordinates:function(_3ab){var res=this._resolution,_3ac=this.origin;return {row:Math.floor((_3ac.y-_3ab.y)/(this.cellHeight*res)),col:Math.floor((_3ab.x-_3ac.x)/(this.cellWidth*res))};},normalize:function(col){var _3ad=this._frameStats;if(_3ad){var _3ae=_3ad[0],m180=_3ad[1],p180=_3ad[2];if(col<m180){col=col%_3ae;col=col<m180?col+_3ae:col;}else{if(col>p180){col=col%_3ae;}}}return col;},intersects:function(_3af,_3b0){var _3b1=this.srInfo;if(_3b1){return _39e.some(_3b0._getParts(_3b1),function(_3b2){return _3af.intersects(_3b2.extent);});}else{return _3af.intersects(_3b0);}},getCellExtent:function(row,col){var res=this._resolution,_3b3=this.origin,_3b4=this.cellWidth,_3b5=this.cellHeight;return new _3a1((col*_3b4*res)+_3b3.x,_3b3.y-((row+1)*_3b5*res),((col+1)*_3b4*res)+_3b3.x,_3b3.y-(row*_3b5*res),new _3a0(_3b3.spatialReference.toJson()));},getLatticeID:function(_3b6){var _3b7=this.getCellCoordinates({x:_3b6.xmin,y:_3b6.ymax}),_3b8=this.getCellCoordinates({x:_3b6.xmax,y:_3b6.ymin}),_3b9=_3b7.row,_3ba=_3b8.row,_3bb=this.normalize(_3b7.col),_3bc=this.normalize(_3b8.col);return _3b9+"_"+_3ba+"_"+_3bb+"_"+_3bc;},sorter:function(a,b){return (a<b)?-1:1;},getCellsInExtent:function(_3bd,_3be){var _3bf=this.getCellCoordinates({x:_3bd.xmin,y:_3bd.ymax}),_3c0=this.getCellCoordinates({x:_3bd.xmax,y:_3bd.ymin}),_3c1=_3bf.row,_3c2=_3c0.row,_3c3=_3bf.col,_3c4=_3c0.col,_3c5=[],i,j,nj,_3c6=[],_3c7=[],len,xmin,xmax,ymin,ymax,_3c8=[],_3c9,_3ca;for(i=_3c1;i<=_3c2;i++){for(j=_3c3;j<=_3c4;j++){nj=this.normalize(j);_3bd=this.getCellExtent(i,nj);_3c5.push({row:i,col:nj,extent:_3bd,resolution:this._resolution});if(_3be){_3c6.push(_3bd.xmin,_3bd.xmax);_3c7.push(_3bd.ymin,_3bd.ymax);}}}_3c3=this.normalize(_3c3);_3c4=this.normalize(_3c4);_3c6.sort(this.sorter);_3c7.sort(this.sorter);len=_3c6.length;for(i=len-1;i>=0;i--){if(i<(len-1)){if(_3c6[i]===_3c6[i+1]){_3c6.splice(i,1);}}}len=_3c7.length;for(i=len-1;i>=0;i--){if(i<(len-1)){if(_3c7[i]===_3c7[i+1]){_3c7.splice(i,1);}}}if(_3c6.length&&_3c7.length){xmin=_3c6[0];xmax=_3c6[_3c6.length-1];ymin=_3c7[0];ymax=_3c7[_3c7.length-1];len=_3c6.length;for(i=0;i<len;i++){_3c8.push([[_3c6[i],ymax],[_3c6[i],ymin]]);}len=_3c7.length;for(i=0;i<len;i++){_3c8.push([[xmin,_3c7[i]],[xmax,_3c7[i]]]);}_3c9=new _3a2({paths:_3c8,spatialReference:this.origin.spatialReference.toJson()});_3ca=_3c1+"_"+_3c2+"_"+_3c3+"_"+_3c4;_3c5.push({latticeID:_3ca,lattice:_3c9,resolution:this._resolution});}return {minRow:_3c1,maxRow:_3c2,minCol:_3c3,maxCol:_3c4,cells:_3c5};}});if(has("extend-esri")){lang.setObject("layers._GridLayout",_3a3,_39f);}return _3a3;});},"dojox/data/CsvStore":function(){define("dojox/data/CsvStore",["dojo/_base/lang","dojo/_base/declare","dojo/_base/xhr","dojo/_base/kernel","dojo/data/util/filter","dojo/data/util/simpleFetch"],function(lang,_3cb,xhr,_3cc,_3cd,_3ce){var _3cf=_3cb("dojox.data.CsvStore",null,{constructor:function(_3d0){this._attributes=[];this._attributeIndexes={};this._dataArray=[];this._arrayOfAllItems=[];this._loadFinished=false;if(_3d0.url){this.url=_3d0.url;}this._csvData=_3d0.data;if(_3d0.label){this.label=_3d0.label;}else{if(this.label===""){this.label=undefined;}}this._storeProp="_csvStore";this._idProp="_csvId";this._features={"dojo.data.api.Read":true,"dojo.data.api.Identity":true};this._loadInProgress=false;this._queuedFetches=[];this.identifier=_3d0.identifier;if(this.identifier===""){delete this.identifier;}else{this._idMap={};}if("separator" in _3d0){this.separator=_3d0.separator;}if("urlPreventCache" in _3d0){this.urlPreventCache=_3d0.urlPreventCache?true:false;}},url:"",label:"",identifier:"",separator:",",urlPreventCache:false,_assertIsItem:function(item){if(!this.isItem(item)){throw new Error(this.declaredClass+": a function was passed an item argument that was not an item");}},_getIndex:function(item){var idx=this.getIdentity(item);if(this.identifier){idx=this._idMap[idx];}return idx;},getValue:function(item,_3d1,_3d2){this._assertIsItem(item);var _3d3=_3d2;if(typeof _3d1==="string"){var ai=this._attributeIndexes[_3d1];if(ai!=null){var _3d4=this._dataArray[this._getIndex(item)];_3d3=_3d4[ai]||_3d2;}}else{throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string");}return _3d3;},getValues:function(item,_3d5){var _3d6=this.getValue(item,_3d5);return (_3d6?[_3d6]:[]);},getAttributes:function(item){this._assertIsItem(item);var _3d7=[];var _3d8=this._dataArray[this._getIndex(item)];for(var i=0;i<_3d8.length;i++){if(_3d8[i]!==""){_3d7.push(this._attributes[i]);}}return _3d7;},hasAttribute:function(item,_3d9){this._assertIsItem(item);if(typeof _3d9==="string"){var _3da=this._attributeIndexes[_3d9];var _3db=this._dataArray[this._getIndex(item)];return (typeof _3da!=="undefined"&&_3da<_3db.length&&_3db[_3da]!=="");}else{throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string");}},containsValue:function(item,_3dc,_3dd){var _3de=undefined;if(typeof _3dd==="string"){_3de=_3cd.patternToRegExp(_3dd,false);}return this._containsValue(item,_3dc,_3dd,_3de);},_containsValue:function(item,_3df,_3e0,_3e1){var _3e2=this.getValues(item,_3df);for(var i=0;i<_3e2.length;++i){var _3e3=_3e2[i];if(typeof _3e3==="string"&&_3e1){return (_3e3.match(_3e1)!==null);}else{if(_3e0===_3e3){return true;}}}return false;},isItem:function(_3e4){if(_3e4&&_3e4[this._storeProp]===this){var _3e5=_3e4[this._idProp];if(this.identifier){var data=this._dataArray[this._idMap[_3e5]];if(data){return true;}}else{if(_3e5>=0&&_3e5<this._dataArray.length){return true;}}}return false;},isItemLoaded:function(_3e6){return this.isItem(_3e6);},loadItem:function(item){},getFeatures:function(){return this._features;},getLabel:function(item){if(this.label&&this.isItem(item)){return this.getValue(item,this.label);}return undefined;},getLabelAttributes:function(item){if(this.label){return [this.label];}return null;},_fetchItems:function(_3e7,_3e8,_3e9){var self=this;var _3ea=function(_3eb,_3ec){var _3ed=null;if(_3eb.query){var key,_3ee;_3ed=[];var _3ef=_3eb.queryOptions?_3eb.queryOptions.ignoreCase:false;var _3f0={};for(key in _3eb.query){_3ee=_3eb.query[key];if(typeof _3ee==="string"){_3f0[key]=_3cd.patternToRegExp(_3ee,_3ef);}}for(var i=0;i<_3ec.length;++i){var _3f1=true;var _3f2=_3ec[i];for(key in _3eb.query){_3ee=_3eb.query[key];if(!self._containsValue(_3f2,key,_3ee,_3f0[key])){_3f1=false;}}if(_3f1){_3ed.push(_3f2);}}}else{_3ed=_3ec.slice(0,_3ec.length);}_3e8(_3ed,_3eb);};if(this._loadFinished){_3ea(_3e7,this._arrayOfAllItems);}else{if(this.url!==""){if(this._loadInProgress){this._queuedFetches.push({args:_3e7,filter:_3ea});}else{this._loadInProgress=true;var _3f3={url:self.url,handleAs:"text",preventCache:self.urlPreventCache};var _3f4=xhr.get(_3f3);_3f4.addCallback(function(data){try{self._processData(data);_3ea(_3e7,self._arrayOfAllItems);self._handleQueuedFetches();}catch(e){_3e9(e,_3e7);}});_3f4.addErrback(function(_3f5){self._loadInProgress=false;if(_3e9){_3e9(_3f5,_3e7);}else{throw _3f5;}});var _3f6=null;if(_3e7.abort){_3f6=_3e7.abort;}_3e7.abort=function(){var df=_3f4;if(df&&df.fired===-1){df.cancel();df=null;}if(_3f6){_3f6.call(_3e7);}};}}else{if(this._csvData){try{this._processData(this._csvData);this._csvData=null;_3ea(_3e7,this._arrayOfAllItems);}catch(e){_3e9(e,_3e7);}}else{var _3f7=new Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(_3e9){_3e9(_3f7,_3e7);}else{throw _3f7;}}}}},close:function(_3f8){},_getArrayOfArraysFromCsvFileContents:function(_3f9){if(lang.isString(_3f9)){var _3fa=new RegExp("^\\s+","g");var _3fb=new RegExp("\\s+$","g");var _3fc=new RegExp("\"\"","g");var _3fd=[];var i;var _3fe=this._splitLines(_3f9);for(i=0;i<_3fe.length;++i){var _3ff=_3fe[i];if(_3ff.length>0){var _400=_3ff.split(this.separator);var j=0;while(j<_400.length){var _401=_400[j];var _402=_401.replace(_3fa,"");var _403=_402.replace(_3fb,"");var _404=_403.charAt(0);var _405=_403.charAt(_403.length-1);var _406=_403.charAt(_403.length-2);var _407=_403.charAt(_403.length-3);if(_403.length===2&&_403=="\"\""){_400[j]="";}else{if((_404=="\"")&&((_405!="\"")||((_405=="\"")&&(_406=="\"")&&(_407!="\"")))){if(j+1===_400.length){return;}var _408=_400[j+1];_400[j]=_402+this.separator+_408;_400.splice(j+1,1);}else{if((_404=="\"")&&(_405=="\"")){_403=_403.slice(1,(_403.length-1));_403=_403.replace(_3fc,"\"");}_400[j]=_403;j+=1;}}}_3fd.push(_400);}}this._attributes=_3fd.shift();for(i=0;i<this._attributes.length;i++){this._attributeIndexes[this._attributes[i]]=i;}this._dataArray=_3fd;}},_splitLines:function(_409){var _40a=[];var i;var line="";var _40b=false;for(i=0;i<_409.length;i++){var c=_409.charAt(i);switch(c){case "\"":_40b=!_40b;line+=c;break;case "\r":if(_40b){line+=c;}else{_40a.push(line);line="";if(i<(_409.length-1)&&_409.charAt(i+1)=="\n"){i++;}}break;case "\n":if(_40b){line+=c;}else{_40a.push(line);line="";}break;default:line+=c;}}if(line!==""){_40a.push(line);}return _40a;},_processData:function(data){this._getArrayOfArraysFromCsvFileContents(data);this._arrayOfAllItems=[];if(this.identifier){if(this._attributeIndexes[this.identifier]===undefined){throw new Error(this.declaredClass+": Identity specified is not a column header in the data set.");}}for(var i=0;i<this._dataArray.length;i++){var id=i;if(this.identifier){var _40c=this._dataArray[i];id=_40c[this._attributeIndexes[this.identifier]];this._idMap[id]=i;}this._arrayOfAllItems.push(this._createItemFromIdentity(id));}this._loadFinished=true;this._loadInProgress=false;},_createItemFromIdentity:function(_40d){var item={};item[this._storeProp]=this;item[this._idProp]=_40d;return item;},getIdentity:function(item){if(this.isItem(item)){return item[this._idProp];}return null;},fetchItemByIdentity:function(_40e){var item;var _40f=_40e.scope?_40e.scope:_3cc.global;if(!this._loadFinished){var self=this;if(this.url!==""){if(this._loadInProgress){this._queuedFetches.push({args:_40e});}else{this._loadInProgress=true;var _410={url:self.url,handleAs:"text"};var _411=xhr.get(_410);_411.addCallback(function(data){try{self._processData(data);var item=self._createItemFromIdentity(_40e.identity);if(!self.isItem(item)){item=null;}if(_40e.onItem){_40e.onItem.call(_40f,item);}self._handleQueuedFetches();}catch(error){if(_40e.onError){_40e.onError.call(_40f,error);}}});_411.addErrback(function(_412){this._loadInProgress=false;if(_40e.onError){_40e.onError.call(_40f,_412);}});}}else{if(this._csvData){try{self._processData(self._csvData);self._csvData=null;item=self._createItemFromIdentity(_40e.identity);if(!self.isItem(item)){item=null;}if(_40e.onItem){_40e.onItem.call(_40f,item);}}catch(e){if(_40e.onError){_40e.onError.call(_40f,e);}}}}}else{item=this._createItemFromIdentity(_40e.identity);if(!this.isItem(item)){item=null;}if(_40e.onItem){_40e.onItem.call(_40f,item);}}},getIdentityAttributes:function(item){if(this.identifier){return [this.identifier];}else{return null;}},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var i=0;i<this._queuedFetches.length;i++){var _413=this._queuedFetches[i];var _414=_413.filter;var _415=_413.args;if(_414){_414(_415,this._arrayOfAllItems);}else{this.fetchItemByIdentity(_413.args);}}this._queuedFetches=[];}}});lang.extend(_3cf,_3ce);return _3cf;});},"esri/arcgis/csv":function(){define(["dojo/_base/lang","dojo/_base/array","dojo/_base/Deferred","dojo/sniff","dojo/number","dojox/data/CsvStore","esri/kernel","esri/config","esri/request","esri/SpatialReference","esri/geometry/Point","esri/geometry/jsonUtils","esri/geometry/webMercatorUtils"],function(lang,_416,_417,has,_418,_419,_41a,_41b,_41c,_41d,_41e,_41f,_420){var _421=["lat","latitude","y","ycenter","latitude83","latdecdeg","POINT-Y"],_422=["lon","lng","long","longitude","x","xcenter","longitude83","longdecdeg","POINT-X"];function _423(_424){var _425=[","," ",";","|","\t"];var _426=0;var _427="";_416.forEach(_425,function(_428){var _429=_424.split(_428).length;if(_429>_426){_426=_429;_427=_428;}});return _427;};function _42a(d,_42b){if(!d||Object.prototype.toString.call(d)!=="[object Date]"||isNaN(d.getTime())){return false;}var _42c=true;if(has("chrome")&&/\d+\W*$/.test(_42b)){var _42d=_42b.match(/[a-zA-Z]{2,}/);if(_42d){var _42e=false,i=0,len=_42d.length,_42f=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;while(!_42e&&(i<=len)&&!(_42e=!_42f.test(_42d[i]))){i++;}_42c=!_42e;}}return _42c;};function _430(data,_431,_432){var _433=data.indexOf("\n");var _434=lang.trim(data.substr(0,_433));var _435=_431.columnDelimiter;if(!_435){_435=_423(_434);}var _436=new _419({data:data,separator:_435});var _437=(has("ie")<9)?750:1001;_436.fetch({start:0,count:_437,onComplete:function(_438,_439){var _43a=0;var _43b={"layerDefinition":_431.layerDefinition,"featureSet":{"features":[],"geometryType":"esriGeometryPoint"}};var _43c=_43b.layerDefinition.objectIdField;if(!_43c){if(!_416.some(_43b.layerDefinition.fields,function(_43d){if(_43d.type=="esriFieldTypeOID"){_43c=_43d.name;return true;}return false;})){_43b.layerDefinition.fields.push({"name":"__OBJECTID","alias":"__OBJECTID","type":"esriFieldTypeOID","editable":false,"domain":null});_43c="__OBJECTID";}}var _43e,_43f;var _440=_436._attributes;var _441=[];var _442=[];_416.forEach(_43b.layerDefinition.fields,function(_443,_444){if(_443.type==="esriFieldTypeDate"){_441.push(_443.name);}else{if(_443.type==="esriFieldTypeDouble"||_443.type==="esriFieldTypeInteger"){_442.push(_443.name);}}});if(_431.locationInfo&&_431.locationInfo.locationType==="coordinates"){_43e=_431.locationInfo.latitudeFieldName;_43f=_431.locationInfo.longitudeFieldName;}else{_416.forEach(_440,function(_445){var _446;_446=_416.indexOf(_421,_445.toLowerCase());if(_446!==-1){_43e=_445;}_446=_416.indexOf(_422,_445.toLowerCase());if(_446!==-1){_43f=_445;}},this);}if(!_43e||!_43f){setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.");},1);return;}var i=0,il=_438.length;for(i;i<il;i++){if(_43b.featureSet.features.length>=1000){setTimeout(function(){console.error("1000 feature limit reached. Unable to load any more data.");},1);break;}var item=_438[i];var _447=_436.getAttributes(item),_448={};_416.forEach(_447,function(attr,_449){if(attr){var _44a=attr;if(attr.length===0){_416.forEach(_43b.layerDefinition.fields,function(_44b,idx){if(_44b.name==="attribute_"+(idx-1)){attr="attribute_"+(idx-1);}});}if(_416.some(_441,function(a){return a===attr;})){var val=_436.getValue(item,_44a),date=new Date(val);_448[attr]=_42a(date,val)?date.getTime():null;}else{if(_416.some(_442,function(a){return a===attr;})){var _44c=_418.parse(_436.getValue(item,_44a));if((attr==_43e||attr==_43f)&&(isNaN(_44c)||Math.abs(_44c)>181)){_44c=parseFloat(_436.getValue(item,_44a));if(isNaN(_44c)){_448[attr]=null;}else{_448[attr]=_44c;}}else{if(isNaN(_44c)){_448[attr]=null;}else{_448[attr]=_44c;}}}else{_448[attr]=_436.getValue(item,_44a);}}}});_448[_43c]=_43a;_43a++;var _44d=_448[_43e];var _44e=_448[_43f];if(_44e==null||_44d==null||isNaN(_44d)||isNaN(_44e)){continue;}var _44f=new _41e(_44e,_44d,new _41d({wkid:4326}));var _450={"geometry":_44f.toJson(),"attributes":_448};_43b.featureSet.features.push(_450);}_43b.layerDefinition.name="csv";if(_432){_432(_43b);}},onError:function(_451){console.error("Error fetching items from CSV store: ",_451);}});return true;};function _452(_453,_454,inSR,_455,_456,_457){if(_453.length===0){_456(null);}var _458=_41f.getGeometryType(_454);var _459=[];_416.forEach(_453,function(_45a){var _45b=new _458(_45a);_45b.spatialReference=inSR;_459.push(_45b);},this);var _45c=[102113,102100,3857];if(inSR.wkid&&inSR.wkid===4326&&_455.wkid&&_416.indexOf(_45c,_455.wkid)>-1){_416.forEach(_459,function(_45d){if(_45d.xmin){_45d.xmin=Math.max(_45d.xmin,-180);_45d.xmax=Math.min(_45d.xmax,180);_45d.ymin=Math.max(_45d.ymin,-89.99);_45d.ymax=Math.min(_45d.ymax,89.99);}else{if(_45d.rings){_416.forEach(_45d.rings,function(ring){_416.forEach(ring,function(_45e){_45e[0]=Math.min(Math.max(_45e[0],-180),180);_45e[1]=Math.min(Math.max(_45e[1],-89.99),89.99);},this);},this);}else{if(_45d.paths){_416.forEach(_45d.paths,function(path){_416.forEach(path,function(_45f){_45f[0]=Math.min(Math.max(_45f[0],-180),180);_45f[1]=Math.min(Math.max(_45f[1],-89.99),89.99);},this);},this);}else{if(_45d.x){_45d.x=Math.min(Math.max(_45d.x,-180),180);_45d.y=Math.min(Math.max(_45d.y,-89.99),89.99);}}}}},this);_453=[];_416.forEach(_459,function(_460){var _461=_420.geographicToWebMercator(_460);if(_455.wkid!==102100){_461.spatialReference=_455;}_453.push(_461.toJson());},this);_456(_453);}else{if(inSR.wkid!==null&&_416.indexOf(_45c,inSR.wkid)>-1&&_455.wkid!==null&&_455.wkid===4326){_453=[];_416.forEach(_459,function(_462){_453.push(_420.webMercatorToGeographic(_462).toJson());},this);_456(_453);}else{var _463=function(_464,args){if(_464&&_464.length===_453.length){_453=[];_416.forEach(_464,function(_465){if(_465&&((_465.rings&&_465.rings.length>0&&_465.rings[0].length>0&&_465.rings[0][0].length>0&&!isNaN(_465.rings[0][0][0])&&!isNaN(_465.rings[0][0][1]))||(_465.paths&&_465.paths.length>0&&_465.paths[0].length>0&&_465.paths[0][0].length>0&&!isNaN(_465.paths[0][0][0])&&!isNaN(_465.paths[0][0][1]))||(_465.xmin&&!isNaN(_465.xmin)&&_465.ymin&&!isNaN(_465.ymin))||(_465.x&&!isNaN(_465.x)&&_465.y&&!isNaN(_465.y)))){_453.push(_465.toJson());}else{_453.push(null);}},this);_456(_453);}else{_457(_464,args);}};if(_41b.defaults.geometryService){_41b.defaults.geometryService.project(_459,_455,lang.hitch(this,_463),_457);}else{_456(null);}}}};function _466(sp1,sp2){var _467=[102113,102100,3857];if(sp1&&sp2&&sp1.wkid===sp2.wkid&&sp1.wkt===sp2.wkt){return true;}else{if(sp1&&sp2&&sp1.wkid&&sp2.wkid&&_416.indexOf(_467,sp1.wkid)>-1&&_416.indexOf(_467,sp2.wkid)>-1){return true;}}return false;};function _468(_469,_46a,_46b,_46c){if(!_469.featureSet||_469.featureSet.length===0){return;}if(_466(_46b,_46a)){_46c(_469);return;}var _46d=function(_46e){var _46f=[];_416.forEach(_469.featureSet.features,function(_470,i){if(_46e[i]){_470.geometry=_46e[i];_46f.push(_470);}},this);_46c(_469);};var _471=function(_472,args){console.error("error projecting featureSet ("+_469.layerDefinition.name+"). Final try.");_46c(_469);};var _473=function(_474,args){console.error("error projecting featureSet ("+_469.layerDefinition.name+"). Try one more time.");_452(_475,_469.featureSet.geometryType,_46a,_46b,lang.hitch(this,_46d),lang.hitch(this,_471));};if(_469.featureSet.features&&_469.featureSet.features.length>0){var _475=[];_416.forEach(_469.featureSet.features,function(_476){_475.push(_476.geometry);});_452(_475,_469.featureSet.geometryType,_46a,_46b,lang.hitch(this,_46d),lang.hitch(this,_473));}else{_46c(_469);}};function _477(_478){var _479=new _417();var _47a=function(_47b){_479.callback(_47b);};var _47c=_41c({url:_478.url,handleAs:"text",load:function(_47d){_430(_47d,_478,lang.hitch(this,_47a));},error:function(_47e){console.error("error: "+_47e);}},{usePost:false});return _479;};function _47f(_480,_481){var _482=new _417();var _483=function(_484){_482.callback(_484);};_468(_480,new _41d({wkid:4326}),_481,lang.hitch(this,_483));return _482;};function _485(_486){var _487=_486.layerDefinition.fields;var _488={"esriFieldTypeDouble":1,"esriFieldTypeSingle":1};var _489={"esriFieldTypeInteger":1,"esriFieldTypeSmallInteger":1};var dt={"esriFieldTypeDate":1};var _48a=null;var _48b=_416.map(_487,lang.hitch(this,function(item){if(item.name.toUpperCase()==="NAME"){_48a=item.name;}var _48c=(item.type!=="esriFieldTypeOID"&&item.type!=="esriFieldTypeGlobalID"&&item.type!=="esriFieldTypeGeometry");var _48d=null;if(_48c){var f=item.name.toLowerCase();var _48e=",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,";if(_48e.indexOf(","+f+",")>-1||f.indexOf("area")>-1||f.indexOf("length")>-1||f.indexOf("shape")>-1||f.indexOf("perimeter")>-1||f.indexOf("objectid")>-1||f.indexOf("_")===f.length-1||(f.indexOf("_i")===f.length-2&&f.length>1)){_48c=false;}if(item.type in _489){_48d={places:0,digitSeparator:true};}else{if(item.type in _488){_48d={places:2,digitSeparator:true};}else{if(item.type in dt){_48d={dateFormat:"shortDateShortTime"};}}}}return lang.mixin({},{fieldName:item.name,label:item.alias,isEditable:true,tooltip:"",visible:_48c,format:_48d,stringFieldOption:"textbox"});}));var _48f={title:_48a?"{"+_48a+"}":"",fieldInfos:_48b,description:null,showAttachments:false,mediaInfos:[]};return _48f;};var csv={latFieldStrings:_421,longFieldStrings:_422,buildCSVFeatureCollection:_477,projectFeatureCollection:_47f,generateDefaultPopupInfo:_485,_getSeparator:_423,_isValidDate:_42a,_processCsvData:_430,_projectGeometries:_452,_sameSpatialReference:_466,_projectFeatureSet:_468};if(has("extend-esri")){lang.setObject("arcgis.csv",csv,_41a);}return csv;});},"dojo/data/util/filter":function(){define(["../../_base/lang"],function(lang){var _490={};lang.setObject("dojo.data.util.filter",_490);_490.patternToRegExp=function(_491,_492){var rxp="^";var c=null;for(var i=0;i<_491.length;i++){c=_491.charAt(i);switch(c){case "\\":rxp+=c;i++;rxp+=_491.charAt(i);break;case "*":rxp+=".*";break;case "?":rxp+=".";break;case "$":case "^":case "/":case "+":case ".":case "|":case "(":case ")":case "{":case "}":case "[":case "]":rxp+="\\";default:rxp+=c;}}rxp+="$";if(_492){return new RegExp(rxp,"mi");}else{return new RegExp(rxp,"m");}};return _490;});},"esri/layers/WMSLayerInfo":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","esri/kernel"],function(_493,lang,_494,has,_495){var _496=_493(null,{declaredClass:"esri.layers.WMSLayerInfo",name:null,title:null,description:null,extent:null,legendURL:null,subLayers:[],allExtents:[],spatialReferences:[],constructor:function(_497){if(_497){this.name=_497.name;this.title=_497.title;this.description=_497.description;this.extent=_497.extent;this.legendURL=_497.legendURL;this.subLayers=_497.subLayers?_497.subLayers:[];this.allExtents=_497.allExtents?_497.allExtents:[];this.spatialReferences=_497.spatialReferences?_497.spatialReferences:[];}},clone:function(){var info={name:this.name,title:this.title,description:this.description,legendURL:this.legendURL},wkid;if(this.extent){info.extent=this.extent.getExtent();}info.subLayers=[];_494.forEach(this.subLayers,function(_498){info.subLayers.push(_498.clone());});info.allExtents=[];for(wkid in this.allExtents){wkid=parseInt(wkid,10);if(!isNaN(wkid)){info.allExtents[wkid]=this.allExtents[wkid].getExtent();}}info.spatialReferences=[];_494.forEach(this.spatialReferences,function(wkid){info.spatialReferences.push(wkid);});return info;}});if(has("extend-esri")){lang.setObject("layers.WMSLayerInfo",_496,_495);}return _496;});},"esri/layers/FeatureType":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","esri/kernel","esri/lang","esri/symbols/jsonUtils","esri/layers/RangeDomain","esri/layers/CodedValueDomain","esri/layers/InheritedDomain","esri/layers/FeatureTemplate"],function(_499,lang,_49a,has,_49b,_49c,_49d,_49e,_49f,_4a0,_4a1){var _4a2=_499(null,{declaredClass:"esri.layers.FeatureType",constructor:function(json){if(json&&lang.isObject(json)){this.id=json.id;this.name=json.name;var _4a3=json.symbol;if(_4a3){this.symbol=_49d.fromJson(_4a3);}var _4a4=json.domains,_4a5,i;var _4a6=this.domains={};for(_4a5 in _4a4){if(_4a4.hasOwnProperty(_4a5)){var _4a7=_4a4[_4a5];switch(_4a7.type){case "range":_4a6[_4a5]=new _49e(_4a7);break;case "codedValue":_4a6[_4a5]=new _49f(_4a7);break;case "inherited":_4a6[_4a5]=new _4a0(_4a7);break;}}}var _4a8=json.templates;if(_4a8){var _4a9=this.templates=[];for(i=0;i<_4a8.length;i++){_4a9.push(new _4a1(_4a8[i]));}}}},toJson:function(){var json={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()};var _4aa,_4ab=this.domains,_4ac=this.templates,_4ad=_49c.fixJson;if(_4ab){var _4ae=json.domains={};for(_4aa in _4ab){if(_4ab.hasOwnProperty(_4aa)){_4ae[_4aa]=_4ab[_4aa]&&_4ab[_4aa].toJson();}}_4ad(_4ae);}if(_4ac){json.templates=_49a.map(_4ac,function(_4af){return _4af.toJson();});}return _4ad(json);}});if(has("extend-esri")){lang.setObject("layers.FeatureType",_4a2,_49b);}return _4a2;});},"esri/layers/RenderMode":function(){define(["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojo/io/script","esri/kernel"],function(_4b0,_4b1,lang,_4b2,has,_4b3,_4b4){var _4b5=_4b1(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(_4b0._scopeName||"dojo")+"IoScript";},initialize:function(map){this.map=map;this._init=true;},startup:function(){},propertyChangeHandler:function(type){},destroy:function(){this._init=false;},drawFeature:function(_4b6){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(oid){var _4b7=this._featureMap[oid];if(_4b7){_4b7._count++;}},_decRefCount:function(oid){var _4b8=this._featureMap[oid];if(_4b8){_4b8._count--;}},_getFeature:function(oid){return this._featureMap[oid];},_addFeatureIIf:function(oid,_4b9){var fmap=this._featureMap,_4ba=fmap[oid],_4bb=this.featureLayer;if(!_4ba){fmap[oid]=_4b9;_4bb._add(_4b9);_4b9._count=0;}return _4ba||_4b9;},_removeFeatureIIf:function(oid){var _4bc=this._featureMap[oid],_4bd=this.featureLayer;if(_4bc){if(_4bc._count){return;}delete this._featureMap[oid];_4bd._remove(_4bc);}return _4bc;},_clearIIf:function(){var i,_4be=this.featureLayer,_4bf=_4be.graphics,_4c0=_4be._selectedFeatures,_4c1=_4be.objectIdField;for(i=_4bf.length-1;i>=0;i--){var _4c2=_4bf[i];var oid=_4c2.attributes[_4c1];if(oid in _4c0){_4c2._count=1;continue;}_4c2._count=0;this._removeFeatureIIf(oid);}},_isPending:function(id){var dfd=_4b3[this._prefix+id];return dfd?true:false;},_cancelPendingRequest:function(dfd,id){dfd=dfd||_4b3[this._prefix+id];if(dfd){try{dfd.cancel();_4b3._validCheck(dfd);}catch(e){}}},_purgeRequests:function(){_4b3._validCheck(null);},_toggleVisibility:function(show){var _4c3=this.featureLayer,_4c4=_4c3.graphics,_4c5=show?"show":"hide",i,len=_4c4.length;show=show&&_4c3._ager;for(i=0;i<len;i++){var _4c6=_4c4[i];_4c6[_4c5]();if(show){_4c3._repaint(_4c6);}}},_applyTimeFilter:function(_4c7){var _4c8=this.featureLayer;if(!_4c8.timeInfo||_4c8.suspended){return;}if(!_4c7){_4c8._fireUpdateStart();}var _4c9=_4c8._trackManager;if(_4c9){_4c9.clearTracks();}var defn=_4c8.getTimeDefinition(),_4ca=_4c8._getOffsettedTE(_4c8._mapTimeExtent);if(_4ca){_4ca=_4c8._getTimeOverlap(defn,_4ca);if(_4ca){var _4cb=_4c8._filterByTime(_4c8.graphics,_4ca.startTime,_4ca.endTime);if(_4c9){_4c9.addFeatures(_4cb.match);}_4b2.forEach(_4cb.match,function(_4cc){var _4cd=_4cc._shape;if(!_4cc.visible){_4cc.show();_4cd=_4cc._shape;_4cd&&_4cd._moveToFront();}if(_4c8._ager&&_4cd){_4c8._repaint(_4cc);}});_4b2.forEach(_4cb.noMatch,function(_4ce){if(_4ce.visible){_4ce.hide();}});}else{this._toggleVisibility(false);}}else{if(_4c9){_4c9.addFeatures(_4c8.graphics);}this._toggleVisibility(true);}if(_4c9){_4c9.moveLatestToFront();_4c9.drawTracks();}if(!_4c7){_4c8._fireUpdateEnd();}}});if(has("extend-esri")){lang.setObject("layers._RenderMode",_4b5,_4b4);}return _4b5;});},"esri/layers/GeoRSSLayer":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/json","dojo/has","esri/kernel","esri/config","esri/request","esri/layers/ServiceGeneratedFeatureCollection"],function(_4cf,lang,_4d0,has,_4d1,_4d2,_4d3,_4d4){var _4d5=_4cf([_4d4],{declaredClass:"esri.layers.GeoRSSLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/rss",constructor:function(url,_4d6){if(_4d2.defaults.geoRSSService){this.serviceUrl=_4d2.defaults.geoRSSService;}this._createLayer();},parse:function(){this._io=_4d3({url:this.serviceUrl,content:{url:this._url.path,refresh:this.loaded?true:undefined,outSR:this._outSR?_4d0.toJson(this._outSR.toJson()):undefined},callbackParamName:"callback"});return this._io;},_initLayer:function(json){this.inherited(arguments);if(!this.loaded){this.loaded=true;this.onLoad(this);}}});if(has("extend-esri")){lang.setObject("layers.GeoRSSLayer",_4d5,_4d1);}return _4d5;});},"esri/layers/FeatureTemplate":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","esri/lang","esri/graphic"],function(_4d7,lang,has,_4d8,_4d9,_4da){var _4db=_4d7(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(json){if(json&&lang.isObject(json)){this.name=json.name;this.description=json.description;this.drawingTool=json.drawingTool;var _4dc=json.prototype;this.prototype=new _4da(_4dc.geometry,null,_4dc.attributes);}},toJson:function(){return _4d9.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()});}});lang.mixin(_4db,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});if(has("extend-esri")){lang.setObject("layers.FeatureTemplate",_4db,_4d8);}return _4db;});},"*noref":1}});define("esri/arcgis/utils",["dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/Deferred","dojo/_base/json","dojo/_base/url","dojo/has","dojo/DeferredList","dojo/dom-construct","esri/kernel","esri/config","esri/lang","esri/request","esri/SpatialReference","esri/map","esri/urlUtils","esri/geometry/ScreenPoint","esri/geometry/Extent","esri/geometry/webMercatorUtils","esri/symbols/jsonUtils","esri/renderers/jsonUtils","esri/dijit/PopupTemplate","esri/dijit/Popup","esri/tasks/query","esri/tasks/GeometryService","esri/arcgis/csv","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/OpenStreetMapLayer","esri/layers/WebTiledLayer","esri/layers/FeatureLayer","esri/layers/WMSLayer","esri/layers/KMLLayer","esri/layers/GeoRSSLayer","esri/virtualearth/VETiledLayer","esri/layers/TileInfo","esri/layers/DynamicLayerInfo","esri/layers/LayerDrawingOptions","esri/layers/ImageParameters","esri/layers/ImageServiceParameters","esri/layers/WMSLayerInfo","dojo/i18n!esri/nls/jsapi"],function(lang,_4dd,_4de,_4df,_4e0,Url,has,_4e1,_4e2,_4e3,_4e4,_4e5,_4e6,_4e7,Map,_4e8,_4e9,_4ea,_4eb,_4ec,_4ed,_4ee,_4ef,_4f0,_4f1,csv,_4f2,_4f3,_4f4,_4f5,_4f6,_4f7,_4f8,_4f9,_4fa,_4fb,_4fc,_4fd,_4fe,_4ff,_500,_501,_502){String.prototype.endsWith=function(str){return (this.match(str+"$")==str);};var _503;function _504(_505){var url=_503.arcgisUrl+"/"+_505.itemId+"/data";var _506=_4e6({url:url,content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:true,_preLookup:true});return _506;};function _507(_508){var _509={f:"json"};if(_4e3.id){var _50a=_4e3.id.findCredential(_4e8.urlToObject(_503.arcgisUrl).path);if(_50a){_509.token=_50a.token;}}var _50b=_4e6({url:_508,content:_509,callbackParamName:"callback"});return _50b;};function _50c(_50d){if(_50d.itemProperties.layerDefinition){if(_50d.layerDefinition){if(!_50d.layerDefinition.drawingInfo){_50d.layerDefinition.drawingInfo=_50d.itemProperties.layerDefinition.drawingInfo;}if(!_4e5.isDefined(_50d.layerDefinition.definitionExpression)){_50d.layerDefinition.definitionExpression=_50d.itemProperties.layerDefinition.definitionExpression;}if(!_4e5.isDefined(_50d.layerDefinition.minScale)){_50d.layerDefinition.minScale=_50d.itemProperties.layerDefinition.minScale;}if(!_4e5.isDefined(_50d.layerDefinition.maxScale)){_50d.layerDefinition.maxScale=_50d.itemProperties.layerDefinition.maxScale;}}else{_50d.layerDefinition=_50d.itemProperties.layerDefinition;}}if(_50d.itemProperties.popupInfo&&!_50d.popupInfo&&!_50d.disablePopup){_50d.popupInfo=_50d.itemProperties.popupInfo;}};function _50e(_50f,_510){var _511=new _4df();var _512=_50f.itemData;var _513=[];var _514=[];_4dd.forEach(_512.operationalLayers,function(_515){if(_515.itemId&&!_515.type){var _516=_515.url.toLowerCase();if(_516.indexOf("/featureserver")>-1){_514.push(_515);_513.push(_504(_515));}else{if(_516.indexOf("/mapserver")>-1&&_516.indexOf("/mapserver/")===-1&&(!_515.layers||(!_4e5.isDefined(_515.minScale)&&!_4e5.isDefined(_515.maxScale)))){_514.push(_515);_513.push(_504(_515));}else{if(_516.indexOf("/imageserver")>-1&&!_4e5.isDefined(_515.minScale)&&!_4e5.isDefined(_515.maxScale)){_514.push(_515);_513.push(_504(_515));}}}}});if(_512.baseMap&&_512.baseMap.baseMapLayers){_4dd.forEach(_512.baseMap.baseMapLayers,function(_517){if((_517.type==="BingMapsAerial"||_517.type==="BingMapsRoad"||_517.type==="BingMapsHybrid")&&_517.portalUrl){_514.push(_517);_513.push(_507(_517.portalUrl));}});}if(_513.length>0){var _518=new _4e1(_513);_518.addCallback(function(_519){_4dd.forEach(_514,function(_51a,i){if((_51a.type==="BingMapsAerial"||_51a.type==="BingMapsRoad"||_51a.type==="BingMapsHybrid")&&_51a.portalUrl){_510.bingMapsKey=_519[i][1].bingKey;return;}var _51b=_519[i][1];if(_51b){var _51c=_51a.url.toLowerCase();if(_51c.indexOf("/featureserver")>-1&&_51b.layers){_4dd.forEach(_51b.layers,function(_51d){if(_51c.endsWith("/featureserver/"+_51d.id)){_51a.itemProperties=_51d;_50c(_51a);}});}else{if(_51c.indexOf("/mapserver")>-1){if(_51b.layers&&!_51a.layers){_51a.layers=_51b.layers;}if(_4e5.isDefined(_51b.minScale)&&!_4e5.isDefined(_51a.minScale)){_51a.minScale=_51b.minScale;}if(_4e5.isDefined(_51b.maxScale)&&!_4e5.isDefined(_51a.maxScale)){_51a.maxScale=_51b.maxScale;}}else{if(_51c.indexOf("/imageserver")>-1){if(_4e5.isDefined(_51b.minScale)&&!_4e5.isDefined(_51a.minScale)){_51a.minScale=_51b.minScale;}if(_4e5.isDefined(_51b.maxScale)&&!_4e5.isDefined(_51a.maxScale)){_51a.maxScale=_51b.maxScale;}}}}}});_511.callback(_50f);});}else{_511.callback(_50f);}return _511;};function _51e(_51f,_520){var _521=_51f.dynamicLayerInfos||_51f.layerInfos;var _522=_520.layers;if(_522&&_521){var _523=[],ids=[],urls=[];_4dd.forEach(_521,function(_524){var id=_524.id,i;if(!_524.subLayerIds&&_4dd.indexOf(_51f.visibleLayers,id)!==-1){for(i=0;i<_522.length;i++){var _525=_522[i];if(_525.id===id){ids.push(id);_523.push(_525.popupInfo);urls.push(_525.layerUrl||"");break;}}}});if(_523.length){_51f.__popups=_523;_51f.__popupIds=ids;_51f.__popupUrls=urls;_51f.__resourceInfo=_520.resourceInfo;}}};function _526(url){if(!url){return false;}var _527=".arcgis.com/";var _528=(new Url(_503.arcgisUrl)).authority;return (url.indexOf(_527)!==-1||url.indexOf(_528)!==-1);};function _529(url){if(!url){return false;}return (url.indexOf("/services.arcgisonline.com/")!==-1||url.indexOf("/server.arcgisonline.com/")!==-1);};function _52a(url){if(location.protocol==="https:"&&(_526(url)||_529(url))){url=url.replace("http:","https:");}return url;};function _52b(_52c){var _52d=[];if(!_52c.displayLevels){_52d=_4dd.map(_52c.resourceInfo.tileInfo.lods,function(lod){return lod.level;});}var _52e=new _4f2(_52a(_52c.url),{resourceInfo:_52c.resourceInfo,opacity:_52c.opacity,visible:_52c.visibility,displayLevels:_52c.displayLevels||_52d,id:_52c.id,minScale:_52c.minScale,maxScale:_52c.maxScale});_51e(_52e,_52c);return _52e;};function _52f(_530,_531){if(!_530||!_531||_531.length===0){return [];}var _532=","+_531+",";var _533=[];var _534="";var k,_535=",";for(k=0;k<_530.length;k++){if(_530[k].subLayerIds!==null){if(_532.indexOf(","+_530[k].id+",")===-1||_535.indexOf(","+_530[k].id+",")>-1){_535+=_530[k].subLayerIds.toString()+",";}}else{if(_532.indexOf(","+_530[k].id+",")>-1&&_535.indexOf(","+_530[k].id+",")===-1){_533.push(_530[k].id);_534=",";}}}return _533;};function _536(_537){var _538=new _4ff();_538.format="png24";if(_537.resourceInfo&&_537.resourceInfo.supportedImageFormatTypes&&_537.resourceInfo.supportedImageFormatTypes.indexOf("PNG32")>-1){_538.format="png32";}var _539=new _4f3(_52a(_537.url),{resourceInfo:_537.resourceInfo,opacity:_537.opacity,visible:_537.visibility,id:_537.id,imageParameters:_538,minScale:_537.minScale,maxScale:_537.maxScale});var _53a=_537.visibleLayers;if(!_537.visibleLayers){var _53b="";var _53c=_539.layerInfos;_4dd.forEach(_53c,function(_53d){if(_53d.defaultVisibility){_53b+=(_53b.length>0?",":"")+_53d.id;}});_53a=_53b;}_53a=_52f(_539.layerInfos,_53a);_539.setVisibleLayers(_53a);if(_537.layers&&_537.layers.length>0){var _53e=[],_53f=[],_540,_541=[],_542;_4dd.forEach(_537.layers,function(_543){if(_543.layerDefinition&&_543.layerDefinition.definitionExpression){_53e[_543.id]=_543.layerDefinition.definitionExpression;}if(_543.layerDefinition&&_543.layerDefinition.source){_540=new _4fd(lang.mixin(_543,_543.layerDefinition));delete _540.layerDefinition;_540.id=_543.id;if(_537.visibleLayers&&_4dd.indexOf(_537.visibleLayers,_543.id)===-1){_540.defaultVisibility=false;}if(_4e5.isDefined(_543.parentLayerId)){_540.parentLayerId=_543.parentLayerId;}if(_543.subLayerIds){_540.subLayerIds=_543.subLayerIds;}if(_543.name){_540.name=_543.name;}_53f.push(_540);}if(_543.layerDefinition&&_543.layerDefinition.source&&_543.layerDefinition.drawingInfo){_542=new _4fe(_543.layerDefinition.drawingInfo);_541[_543.id]=_542;}},this);if(_53e.length>0){_539.setLayerDefinitions(_53e);}if(_53f.length>0){_539.setDynamicLayerInfos(_53f,true);if(_541.length>0){_539.setLayerDrawingOptions(_541,true);}}}_51e(_539,_537);return _539;};function _544(_545,_546){var _547=[102113,102100,3857];var sp1=new _4e7(_546[0].layerObject.fullExtent.spatialReference);var sp2=new _4e7(_545.resourceInfo.fullExtent.spatialReference);if(_4e0.toJson(sp1.toJson())===_4e0.toJson(sp2.toJson())){return true;}else{if(_4dd.some(_547,function(wkid){return wkid===sp2.wkid;})&&_4dd.some(_547,function(wkid){return wkid===sp1.wkid;})){return true;}}return false;};function _548(_549,_54a){if(!_54a[0].layerObject.tileInfo){return false;}var _54b=[];_4dd.forEach(_54a,function(_54c){if(_54c.baseMapLayer){if(_54c.layerObject.tileInfo){_54b=_54b.concat(_4dd.map(_54c.layerObject.tileInfo.lods,function(lod){return lod.scale;}));}}});var _54d=_4dd.some(_549.resourceInfo.tileInfo.lods,function(lod){return _4dd.some(_54b,function(_54e){return _54e===lod.scale;});});return _54d;};function _54f(_550,_551,_552,_553){var _554,_555=_552._clazz;if(_550.type==="OpenStreetMap"){_554=new _4f5({id:_550.id,opacity:_550.opacity,visible:(_550.visibility!==null&&_550.visibility!==undefined)?_550.visibility:true});}else{if(_550.type==="WMS"){var _556=[];var _557=[];_4dd.forEach(_550.layers,function(_558){_557.push(new _501({name:_558.name,title:_558.title,legendURL:_558.legendURL}));_556.push(_558.name);},this);if(_550.visibleLayers){_556=_550.visibleLayers;}var _559=new _4ea(_550.extent[0][0],_550.extent[0][1],_550.extent[1][0],_550.extent[1][1],new _4e7({wkid:4326}));var _55a={extent:_559,layerInfos:_557,version:_550.version,maxWidth:_550.maxWidth,maxHeight:_550.maxHeight,getMapUrl:_550.mapUrl,spatialReferences:_550.spatialReferences,title:_550.title,copyright:_550.copyright};_554=new _4f8(_550.url,{id:_550.id,visibleLayers:_556,format:"png",transparent:_550.baseMapLayer?false:true,opacity:_550.opacity,visible:(_550.visibility!==null)?_550.visibility:true,resourceInfo:_55a});_554.spatialReference.wkid=_55a.spatialReferences[0];}else{if(_550.type==="KML"){_554=new _4f9(_550.url,{id:_550.id,visible:(_550.visibility!==null)?_550.visibility:true,outSR:_553});_4de.connect(_554,"onLoad",function(){var _55b=function(_55c){_4dd.forEach(_55c,function(_55d){if(_55d.declaredClass==="esri.layers.FeatureLayer"||_55d.declaredClass==="esri.layers.MapImageLayer"){_55d.setOpacity(_550.opacity);}else{if(_55d.declaredClass==="esri.layers.KMLLayer"){if(_55d.loaded){_55b(_55d.getLayers());}else{_4de.connect(_55d,"onLoad",lang.hitch(this,function(lyr){_55b(lyr.getLayers());}));}}}});};if(_550.opacity||_550.opacity===0){_55b(_554.getLayers());}if(_550.visibleFolders){_4dd.forEach(_554.folders,function(_55e){if(_4dd.indexOf(_550.visibleFolders,_55e.id)>-1){_554.setFolderVisibility(_55e,true);}else{_554.setFolderVisibility(_55e,false);}},this);}});}else{if(_550.type==="WebTiledLayer"){_554=new _4f6(_550.templateUrl,{id:_550.id,visible:(_550.visibility!==null)?_550.visibility:true,opacity:_550.opacity,copyright:_550.copyright,fullExtent:_550.fullExtent&&new _4ea(_550.fullExtent),initialExtent:_550.fullExtent&&new _4ea(_550.fullExtent),subDomains:_550.subDomains,tileInfo:_550.tileInfo?new _4fc(_550.tileInfo):null});_4de.connect(_554,"onLoad",function(){if(_4e5.isDefined(_550.minScale)||_4e5.isDefined(_550.maxScale)){_554.setScaleRange(_550.minScale,_550.maxScale);}});}else{if(_550.type==="GeoRSS"){_554=new _4fa(_550.url,{id:_550.id,visible:(_550.visibility!==null)?_550.visibility:true,opacity:_550.opacity,outSpatialReference:_553});_4de.connect(_554,"onLoad",function(){var _55f=_554.getFeatureLayers();_4dd.forEach(_55f,function(_560){if(_550.pointSymbol&&_560.geometryType==="esriGeometryPoint"){_560.renderer.symbol=_4ec.fromJson(_550.pointSymbol);}else{if(_550.lineSymbol&&_560.geometryType==="esriGeometryPolyline"){_560.renderer.symbol=_4ec.fromJson(_550.lineSymbol);}else{if(_550.polygonSymbol&&_560.geometryType==="esriGeometryPolygon"){_560.renderer.symbol=_4ec.fromJson(_550.polygonSymbol);}}}if(_4e5.isDefined(_550.minScale)||_4e5.isDefined(_550.maxScale)){_560.setScaleRange(_550.minScale,_550.maxScale);}});});}else{if(_550.type=="CSV"&&_550.url){_554=new _4f7(_550.featureCollection,{infoTemplate:new _4ee(_550.popupInfo?_550.popupInfo:csv.generateDefaultPopupInfo(_550.featureCollection)),id:_550.id?_550.id:null,outFields:["*"],visible:(_550.visibility!==null)?_550.visibility:true,opacity:_550.opacity,autoGeneralize:true});}else{if(_550.layerDefinition&&!_550.url){var _561=_4e0.fromJson(_4e0.toJson(_550));delete _561.id;delete _561.opacity;delete _561.visibility;_554=new _4f7(_561,{id:_550.id,opacity:_550.opacity,visible:_550.visibility,outFields:["*"],infoTemplate:_561.popupInfo&&new _555(_561.popupInfo),autoGeneralize:true});}else{if(_550.type==="BingMapsAerial"||_550.type==="BingMapsRoad"||_550.type==="BingMapsHybrid"){var _562=_4fb.MAP_STYLE_AERIAL_WITH_LABELS;if(_550.type==="BingMapsAerial"){_562=_4fb.MAP_STYLE_AERIAL;}else{if(_550.type==="BingMapsRoad"){_562=_4fb.MAP_STYLE_ROAD;}}_554=new _4fb({bingMapsKey:_552.bingMapsKey,mapStyle:_562,opacity:_550.opacity,id:_550.id});}else{if(_550.resourceInfo&&_550.resourceInfo.mapName){if(_550.resourceInfo.singleFusedMapCache===true){if(!_550.baseMapLayer){if(_544(_550,_551)){if(_548(_550,_551)){_554=_52b(_550);}else{_554=_536(_550);}}else{_554=_536(_550);}}else{_554=_52b(_550);}}else{_554=_536(_550);}}else{if(_550.resourceInfo&&_550.resourceInfo.pixelSizeX){var _563=new _500();_563.bandIds=_550.bandIds;if(!_550.bandIds&&_550.resourceInfo.bandCount&&parseInt(_550.resourceInfo.bandCount,10)>3){_563.bandIds=[0,1,2];}_554=new _4f4(_52a(_550.url),{resourceInfo:_550.resourceInfo,opacity:_550.opacity,visible:_550.visibility,id:_550.id,imageServiceParameters:_563,minScale:_550.minScale,maxScale:_550.maxScale});}else{if(_550.resourceInfo&&_550.resourceInfo.type==="Feature Layer"){_554=new _4f7(_52a(_550.url),{resourceInfo:_550.resourceInfo,opacity:_550.opacity,visible:_550.visibility,id:_550.id,mode:_4e5.isDefined(_550.mode)?_550.mode:_4f7.MODE_ONDEMAND,outFields:["*"],infoTemplate:_550.popupInfo&&new _555(_550.popupInfo),autoGeneralize:true});if(_550.layerDefinition){if(_550.layerDefinition.drawingInfo&&_550.layerDefinition.drawingInfo.renderer){var _564=_4ed.fromJson(_550.layerDefinition.drawingInfo.renderer);_564.isMaxInclusive=true;_554.setRenderer(_564);}if(_550.layerDefinition.definitionExpression){_554.setDefinitionExpression(_550.layerDefinition.definitionExpression);}if(_4e5.isDefined(_550.layerDefinition.minScale)){_554.setMinScale(_550.layerDefinition.minScale);}if(_4e5.isDefined(_550.layerDefinition.maxScale)){_554.setMaxScale(_550.layerDefinition.maxScale);}}}}}}}}}}}}}if(_554){_554.arcgisProps={title:_550.title};if(_550.baseMapLayer){if(_550.isReference){_554._basemapGalleryLayerType="reference";}else{_554._basemapGalleryLayerType="basemap";}}}return _554;};function _565(_566,_567,_568){_4dd.forEach(_566,function(_569,_56a){if(_569.url&&!_569.type){if(_56a===0||_566[0].layerObject){_569.layerObject=_54f(_569,_566,_567,_568);}}else{if(_569.url&&_569.type=="CSV"){_569.layerObject=_54f(_569,_566,_567,_568);}else{_569.layerObject=_54f(_569,_566,_567,_568);}}});var _56b=_4dd.filter(_566,function(lyr){return !lyr.isReference;});var _56c=_4dd.filter(_566,function(lyr){return !!lyr.isReference;});_566=_56b.concat(_56c);return _566;};function _56d(_56e){var _56f=null;var _570=_56e[0];if(_570.url&&!_570.type){if(_570.resourceInfo.spatialReference){_56f=new _4e7();if(_570.resourceInfo.spatialReference.wkid){_56f.wkid=_570.resourceInfo.spatialReference.wkid;}if(_570.resourceInfo.spatialReference.wkt){_56f.wkt=_570.resourceInfo.spatialReference.wkt;}}}else{if(_570.type.indexOf("BingMaps")>-1||_570.type=="OpenStreetMap"){_56f=new _4e7({wkid:102100});}else{if(_570.type=="WMS"){_56f=new _4e7({wkid:_570.spatialReferences[0]});}}}return _56f;};function _571(_572,_573,_574,_575,_576){_4dd.forEach(_573,function(_577,_578){if(_577.url&&!_577.type){_577.resourceInfo=_572[_577.deferredsPos][1];delete _577.deferredsPos;}else{if(_577.url&&_577.type=="CSV"){_577.featureCollection=_575[_577.deferredsPos].results[0];delete _577.deferredsPos;}}});var _579=_56d(_573);var _57a=[];var _57b=new _4df();_4dd.forEach(_573,function(_57c){if(_57c.url&&_57c.type=="CSV"){_57c.deferredsPos=_57a.length;_57a.push(csv.projectFeatureCollection(_57c.featureCollection,_579));}});if(_57a.length==0){_573=_565(_573,_574,_579);_576.callback(_573);}else{var _57d=new _4e1(_57a);_57d.addCallback(function(){_4dd.forEach(_573,function(_57e){if(_57e.url&&_57e.type=="CSV"){_57e.featureCollection=_57a[_57e.deferredsPos].results[0];delete _57e.deferredsPos;}});_573=_565(_573,_574,_579);_576.callback(_573);});}};function _57f(url,_580){var url2=_52a(url);return _4e6({url:url2,content:{f:"json"},callbackParamName:"callback",error:function(_581,io){if(_581.message){_581.message+=" [url:"+url2+"]";}else{_581.message="[url:"+url2+"]";}_580.push(_581);_4e4.defaults.io.errorHandler(_581,io);}});};function _582(_583,_584){var _585=[];var _586=[];var _587=[];var _588=new _4df();_4dd.forEach(_583.operationalLayers,function(_589,_58a){if(_589.featureCollection){_4dd.forEach(_589.featureCollection.layers,function(_58b,idx){var _58c=true;if(_589.visibleLayers){if(_4dd.indexOf(_589.visibleLayers,idx)==-1){_58c=false;}}_58b.visibility=(_589.visibility&&_58c);_58b.opacity=_589.opacity;_58b.id=(_589.id||("operational"+_58a))+"_"+idx;_587.push(_58b);},this);}else{_587.push(_589);}});_4dd.forEach(_583.baseMap.baseMapLayers,function(_58d,_58e){_58d.baseMapLayer=true;_58d.id=_58d.id||("base"+_58e);_585.push(_58d);});_4dd.forEach(_587,function(_58f,_590){_58f.id=_58f.id||("operational"+_590);_585.push(_58f);});_4dd.forEach(_585,function(_591){if(_591.url&&!_591.type){_591.deferredsPos=_586.length;_591.errors=[];_586.push(_57f(_591.url,_591.errors));}else{if(_591.url&&_591.type=="CSV"){_591.deferredsPos=_586.length;_586.push(csv.buildCSVFeatureCollection(_591));}}});if(_586.length==0){var _592=_56d(_585);_585=_565(_585,_584,_592);_588.callback(_585);}else{var _593=new _4e1(_586);_593.addCallback(function(_594){_571(_594,_585,_584,_586,_588);});}return _588;};function _595(_596,_597){if(_597.version<=10.1&&_596){var i,id=parseInt(_597.url.substring(_597.url.lastIndexOf("/")+1,_597.url.length));for(i=_596.length-1;i>=0;i--){if(_596[i].id==id){if(_597.minScale==0&&_596[i].minScale>0){_597.minScale=_596[i].minScale;}else{if(_597.minScale>0&&_596[i].minScale==0){_597.minScale=_597.minScale;}else{if(_597.minScale>0&&_596[i].minScale>0){_597.minScale=Math.min(_597.minScale,_596[i].minScale);}}}_597.maxScale=Math.max(_597.maxScale||0,_596[i].maxScale||0);if(_596[i].parentLayerId>-1){id=_596[i].parentLayerId;}else{break;}}}}};function _598(_599,_59a,_59b,map){var url=_599.url;var _59c=_599.__popups;var ids=_599.__popupIds;var urls=_599.__popupUrls;var _59d=_599.__resourceInfo;var _59e=[];_4dd.forEach(_59c,function(_59f,_5a0){if(!_59f){return;}var _5a1,_5a2=[];_4dd.forEach(_59f.fieldInfos,function(item){_5a2.push(item.fieldName);});if(_599.dynamicLayerInfos&&_599.dynamicLayerInfos.length>0){var _5a3=_4dd.filter(_599.dynamicLayerInfos,function(item){return ids[_5a0]==item.id;})[0].source;_5a1=new _4f7(url+"/dynamicLayer",{id:_599.id+"_"+ids[_5a0],source:_5a3,outFields:_5a2,mode:_4f7.MODE_SELECTION,infoTemplate:_59f&&new _59b(_59f),drawMode:false,visible:_599.visible,autoGeneralize:true});}else{var i,_5a4=null;if(_59a){for(i=0;i<_59a.length;i++){if(_59a[i].id===ids[_5a0]){_5a4=_59a[i];break;}}}var _5a5=url+"/"+ids[_5a0];if(urls[_5a0].length){_5a5=urls[_5a0];}_5a1=new _4f7(_52a(_5a5),{id:_599.id+"_"+ids[_5a0],outFields:_5a2,mode:_4f7.MODE_SELECTION,infoTemplate:_59f&&new _59b(_59f),drawMode:false,visible:_599.visible,resourceInfo:_5a4,autoGeneralize:true});}if(_5a1.loaded){_595(_59d.layers,_5a1);}else{_4de.connect(_5a1,"onLoad",function(_5a6){_595(_59d.layers,_5a6);});}_59e.push(_5a1);});if(_59e.length>0){var _5a7=function(_5a8,_5a9){_4dd.forEach(_5a8,function(_5aa){if(_5a9){_5aa.show();}else{_5aa.hide();}});};_4de.connect(_599,"onVisibilityChange",lang.hitch(this,_5a7,_59e));var _5ab=function(_5ac,_5ad,_5ae){if(_5ac.id===_5ae.id){_4dd.forEach(_5ad,function(_5af){map.removeLayer(_5af);});}};_4de.connect(map,"onLayerRemove",lang.hitch(this,_5ab,_599,_59e));}delete _599.__popups;delete _599.__popupIds;delete _599.__popupUrls;delete _599.__resourceInfo;return _59e;};function _5b0(_5b1){return _4e6({url:_52a(_5b1.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}});};function _5b2(_5b3,map,_5b4){var _5b5=[];_4dd.forEach(_5b3,function(_5b6){var _5b7=_5b6.__popups;if(_5b7&&_5b7.length>1&&_5b6.version>=10){_5b6.__deferredsPos=_5b5.length;_5b5.push(_5b0(_5b6));}});var _5b8=[];if(_5b5.length>0){var _5b9=new _4e1(_5b5);_5b9.addCallback(function(_5ba){_4dd.forEach(_5b3,function(_5bb){if(_5bb.__popups&&_5bb.__popups.length>0){if(_5bb.__deferredsPos||_5bb.__deferredsPos===0){var _5bc=_5ba[_5bb.__deferredsPos][1];_5b8=_5b8.concat(_598(_5bb,_5bc.layers,_5b4,map));delete _5bb.__deferredsPos;}else{_5b8=_5b8.concat(_598(_5bb,null,_5b4,map));}}});map.addLayers(_5b8);});}else{_4dd.forEach(_5b3,function(_5bd){if(_5bd.__popups&&_5bd.__popups.length>0){_5b8=_5b8.concat(_598(_5bd,null,_5b4,map));}});map.addLayers(_5b8);}};function _5be(_5bf){_4dd.forEach(_5bf,function(_5c0){var _5c1=_5c0.layer;if(_5c1.toJson){var json=_5c1.toJson();if(json.featureSet&&_5c1.name.indexOf("Text")>-1){_4dd.forEach(json.featureSet.features,function(_5c2,idx){if(_5c2.attributes.TEXT){var _5c3=_5c1.graphics[idx];_5c3.symbol.setText(_5c2.attributes.TEXT);if(_5c2.symbol.horizontalAlignment){_5c3.symbol.align=_5c2.symbol.horizontalAlignment;}_5c3.setSymbol(_5c3.symbol);_5c3.setAttributes(_5c2.attributes);}},this);}}});};function _5c4(_5c5){var _5c6=6;_4dd.forEach(_5c5,function(_5c7){var _5c8=_5c7.renderer;if(_5c8.declaredClass==="esri.renderer.SimpleRenderer"){var _5c9=_5c8.symbol;if(_5c9&&_5c9.xoffset){_5c6=Math.max(_5c6,Math.abs(_5c9.xoffset));}if(_5c9&&_5c9.yoffset){_5c6=Math.max(_5c6,Math.abs(_5c9.yoffset));}}else{if(_5c8.declaredClass==="esri.renderer.UniqueValueRenderer"||_5c8.declaredClass==="esri.renderer.ClassBreaksRenderer"){_4dd.forEach(_5c8.infos,function(info){var _5ca=info.symbol;if(_5ca&&_5ca.xoffset){_5c6=Math.max(_5c6,Math.abs(_5ca.xoffset));}if(_5ca&&_5ca.yoffset){_5c6=Math.max(_5c6,Math.abs(_5ca.yoffset));}});}}});return _5c6;};function _5cb(evt){var map=this,_5cc=map.infoWindow,_5cd=evt.graphic;if(!map.loaded){return;}_5cc.hide();_5cc.clearFeatures();var _5ce=[];_4dd.forEach(map.graphicsLayerIds,function(_5cf){var _5d0=map.getLayer(_5cf);if(_5d0&&_5d0.declaredClass.indexOf("FeatureLayer")!==-1&&_5d0.loaded&&_5d0.visible){_5d0.clearSelection();if(_5d0.infoTemplate&&!_5d0.suspended){_5ce.push(_5d0);}}});_5cd=(_5cd&&_5cd._getEffInfoTemplate())?_5cd:null;if(!_5ce.length&&!_5cd){return;}var _5d1=_5c4(_5ce);var _5d2=evt.screenPoint,_5d3=map.toMap(new _4e9(_5d2.x-_5d1,_5d2.y+_5d1)),_5d4=map.toMap(new _4e9(_5d2.x+_5d1,_5d2.y-_5d1)),_5d5=new _4ea(_5d3.x,_5d3.y,_5d4.x,_5d4.y,map.spatialReference);var _5d6=new _4f0();_5d6.geometry=_5d5;_5d6.timeExtent=map.timeExtent;var _5d7=_4dd.map(_5ce,function(_5d8){var dfd=_5d8.selectFeatures(_5d6);dfd.addCallback(function(){var _5d9=_5d8.getSelectedFeatures();return _5d9;});return dfd;});if(_5cd){var dfd=new _4df();dfd.callback([_5cd]);_5d7.splice(0,0,dfd);}var _5da=_4dd.some(_5d7,function(dfd){return dfd.fired===-1;});if(!_5da){var _5db=_5cd?1:0;_4dd.forEach(_5ce,function(_5dc){_5db=_5db+_5dc.getSelectedFeatures().length;});if(!_5db){return;}}_5cc.setFeatures(_5d7);_5cc.show(evt.mapPoint,{closestFirst:true});};function _5dd(_5de,_5df,_5e0,_5e1,_5e2,_5e3){var _5e4=(_5e2.mapOptions||{}),_5e5,_5e6;if(!_5e4.infoWindow){_5e5=new _4ef(null,_4e2.create("div"));_5e4.infoWindow=_5e5;}if(!_4e5.isDefined(_5e4.showInfoWindowOnClick)){_5e4.showInfoWindowOnClick=false;}var map=new Map(_5e1,_5e4);if(_5e2.ignorePopups){_4dd.forEach(_5de,function(_5e7){delete _5e7.infoTemplate;});}if(!(_5e2.ignorePopups||_5e2.disableClickBehavior)){_5e6=_4de.connect(map,"onClick",_5cb);}_4de.connect(map,"onLayersAddResult",_5be);map.addLayers(_5de);if(!_5e2.ignorePopups){_5b2(_5de,map,_5e2._clazz);}var _5e8=[];_4dd.forEach(_5df,function(_5e9){_5e8=_5e8.concat(_5e9.errors);},this);_5e3.callback({map:map,itemInfo:_5e0,errors:_5e8,clickEventHandle:_5e6,clickEventListener:_5cb});};function _5ea(_5eb,_5ec,_5ed,_5ee,_5ef){try{var _5f0=_5ed.mapOptions||{};_5ed.mapOptions=_5f0;var card=_5eb.item;var _5f1=[];_4dd.forEach(_5ef,function(_5f2){if(lang.isArray(_5f2.layerObject)){_4dd.forEach(_5f2.layerObject,function(l){_5f1.push(l);});}else{_5f1.push(_5f2.layerObject);}});if(!_5f1[0]){_5ee.errback(new Error(_502.arcgis.utils.baseLayerError));return;}_5f1=_4dd.filter(_5f1,_4e5.isDefined);if(card){if(card.extent){if(!_5f0.extent){var _5f3=new _4ea(card.extent[0][0],card.extent[0][1],card.extent[1][0],card.extent[1][1],new _4e7({wkid:4326}));var _5f4=_5f1[0].spatialReference;if(_5f4.wkid===4326){_5f0.extent=_5f3;_5dd(_5f1,_5ef,_5eb,_5ec,_5ed,_5ee);}else{if(_5f4.wkid===102100||_5f4.wkid===102113||_5f4.wkid===3857){_5f3.xmin=Math.max(_5f3.xmin,-180);_5f3.xmax=Math.min(_5f3.xmax,180);_5f3.ymin=Math.max(_5f3.ymin,-89.99);_5f3.ymax=Math.min(_5f3.ymax,89.99);_5f0.extent=_4eb.geographicToWebMercator(_5f3);_5dd(_5f1,_5ef,_5eb,_5ec,_5ed,_5ee);}else{if(_5ed.geometryServiceURL||_4e4.defaults.geometryService){var gs;if(_5ed.geometryServiceURL){gs=new _4f1(_5ed.geometryServiceURL);}else{gs=_4e4.defaults.geometryService;}gs.project([_5f3],_5f4,function(_5f5){var _5f6=_5f5[0];_5f0.extent=_5f0.extent||_5f6;_5dd(_5f1,_5ef,_5eb,_5ec,_5ed,_5ee);});}else{_5ee.errback(new Error(_502.arcgis.utils.geometryServiceError));}}}}else{_5dd(_5f1,_5ef,_5eb,_5ec,_5ed,_5ee);}}else{_5dd(_5f1,_5ef,_5eb,_5ec,_5ed,_5ee);}}else{_5dd(_5f1,_5ef,_5eb,_5ec,_5ed,_5ee);}}catch(err){_5ee.errback(err);}};function _5f7(_5f8){var _5f9=[];var _5fa=_5f8.baseMap.baseMapLayers.concat(_5f8.operationalLayers);_4dd.forEach(_5fa,function(_5fb,_5fc){var _5fd={};if(_5fb.featureCollection&&_5fb.type!=="CSV"){if(_5fb.featureCollection.showLegend===true){_4dd.forEach(_5fb.featureCollection.layers,function(_5fe){if(_5fe.showLegend!==false){_5fd={"layer":_5fe.layerObject,"title":_5fb.title,"defaultSymbol":false};if(_5fb.featureCollection.layers.length>1){_5fd.title+=" - "+_5fe.layerDefinition.name;}_5f9.push(_5fd);}});}}else{if((_5fb.baseMapLayer&&_5fb.showLegend===true&&_5fb.layerObject)||(!_5fb.baseMapLayer&&_5fb.showLegend!==false&&_5fb.layerObject)){var _5ff=false;if(_5fb.layerObject.version<10.1&&(_5fb.layerObject instanceof _4f3||_5fb.layerObject instanceof _4f2)){_5ff=true;}_5fd={"layer":_5fb.layerObject,"title":_5fb.title,"defaultSymbol":_5ff};if(_5fb.layers){var _600=_4dd.map(_4dd.filter(_5fb.layers,function(lyr){return (lyr.showLegend===false);}),function(lyr){return lyr.id;});if(_600.length){_5fd.hideLayers=_600;}}_5f9.push(_5fd);}}});return _5f9;};function _601(_602){if(_503._arcgisUrl&&_503._arcgisUrl.length>0){_503.arcgisUrl=_503._arcgisUrl;}var url=_503.arcgisUrl+"/"+_602;var _603={},_604=new _4df();_4e6({url:url,content:{f:"json"},callbackParamName:"callback",load:function(_605){_603.item=_605;_4e6({url:url+"/data",content:{f:"json"},callbackParamName:"callback",load:function(_606){_603.itemData=_606;_604.callback(_603);},error:function(_607){_604.errback(_607);}});},error:function(_608){_604.errback(_608);}});return _604;};function _609(arg1,_60a,_60b){var _60c=new _4df();_60b=_60b||{};var _60d=_60b.infoTemplateClass;_60b._clazz=(_60d&&(lang.isObject(_60d)?_60d:lang.getObject(_60d)))||_4ee;if(lang.isString(arg1)){_601(arg1).addCallback(function(_60e){_50e(_60e,_60b).addCallback(function(_60f){_582(_60f.itemData,_60b).addCallback(lang.hitch(null,_5ea,_60f,_60a,_60b,_60c));});}).addErrback(lang.hitch(_60c,_60c.errback));}else{_50e(arg1,_60b).addCallback(function(_610){_582(_610.itemData,_60b).addCallback(lang.hitch(null,_5ea,_610,_60a,_60b,_60c));});}return _60c;};function _611(_612){if(_612&&_612.itemInfo&&_612.itemInfo.itemData){return _5f7(_612.itemInfo.itemData);}else{return [];}};_503={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:_601,createMap:_609,getLegendLayers:_611,_arcgisUrl:null,_getItemProps:_50e,_getItemData:_504,_getBingKey:_507,_processFSItemProperties:_50c,_getLayers:_582,_preBuildLayerObjects:_571,_buildLayerObjects:_565,_preCreateMap:_5ea,_getMapSR:_56d,_createMap:_5dd,_addSelectionLayers:_5b2,_createSelectionFeatureLayers:_598,_getServiceInfo:_57f,_getLayersInfo:_5b0,_initLayer:_54f,_loadAsCached:_52b,_loadAsDynamic:_536,_processPopups:_51e,_onLayersAddResult:_5be,_sameSpatialReferenceAsBasemap:_544,_sameTilingSchemeAsBasemap:_548,_showPopup:_5cb,_calculateClickTolerance:_5c4,_getVisibleFeatureLayers:_52f,_updateLayerScaleInfo:_595,_checkUrl:_52a,_isHostedService:_526,_isAgolService:_529,_getLegendLayers:_5f7};lang.setObject("arcgis.utils",_503,_4e3);return _503;});