/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/arcgis/Portal",["dojo/_base/declare","dojo/_base/lang","dojo/_base/kernel","dojo/_base/Deferred","dojo/_base/array","dojo/_base/sniff","dojo/Evented","dojo/DeferredList","esri/kernel","esri/lang","esri/request","esri/IdentityManager"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c={"options":{"disableIdentityLookup":true},"requestParams":{"f":"json"}},_d=function(_e){if(!_e){return _e;}if(_e.then){_e=_2.delegate(_e);}if(!_e.total){_e.total=_4.when(_e,function(_f){return _a.isDefined(_f.total)?_f.total:(_f.length||0);});}function _10(_11){if(!_e[_11]){_e[_11]=function(){var _12=arguments;return _4.when(_e,function(_13){Array.prototype.unshift.call(_12,(_13.results||_13));return _d(_5[_11].apply(_5,_12));});};}};_10("forEach");_10("filter");_10("map");_10("some");_10("every");return _e;},_14={useSSL:function(_15,url){return (_15.indexOf("https:")!==-1||(_c.self&&_c.self.allSSL))?url.replace("http:","https:"):url;},formatUrl:function(url){var _16=_c.loggedInUser&&_c.loggedInUser.credential&&_c.loggedInUser.credential.token;return url.indexOf("null")!==-1?null:_14.useSSL(window.location.protocol,(_16?url+(url.indexOf("?")!==-1?"&":"?")+("token="+_16):url));},resultsToTypedArray:function(_17,_18,_19){_19=_19?(_19.notifications||_19.userInvitations||_19.tags||_19.items||_19.groups||_19.comments||_19.results||_19):[];return _5.map(_19,function(_1a){_1a=_2.mixin(_1a,_18||{});return _17?new _17(_1a):_1a;});},clearFieldsFromObject:function(_1b,obj){var fld,i,l=_1b.length;if(!_2.isArray(_1b)){for(fld in _1b){delete obj[fld];}}else{for(i=0;i<l;i++){delete obj[_1b[i]];}}return obj;},requestToTypedArray:function(url,_1c,_1d,_1e,_1f){return _d(_14.request(url,_1c,_1d).then(_2.partial(_14.resultsToTypedArray,_1e,_1f)));},request:function(url,_20,_21){_20&&_20.portal&&delete _20.portal;var _22=_2.mixin(_2.mixin({},_20||{}),_c.requestParams);var _23=_2.mixin(_21||{},_c.options);return _b({url:_14.useSSL(window.location.protocol,(url.url||url)),content:_22,callbackParamName:"callback",timeout:(_23&&_23.timeout)||0},_23);},formatQueryParams:function(_24,_25){var qp=_2.mixin(_2.mixin({},_24),(_2.isString(_25)?{"q":_25}:(_25||{})));qp.q=_c.extraQuery?"("+qp.q+")"+_c.extraQuery:qp.q;return qp;}},_26=_1([],{declaredClass:"esri.arcgis.PortalComment",constructor:function(_27){_2.mixin(this,_27);this.url=this.item.itemUrl+"/comments/"+this.id;this.created=this.created?new Date(this.created):null;}}),_28=_1([],{declaredClass:"esri.arcgis.PortalRating",constructor:function(_29){_2.mixin(this,_29);this.url=this.item.itemUrl+"/rating";this.created=this.created?new Date(this.created):null;}}),_2a=_1([],{declaredClass:"esri.arcgis.PortalItem",constructor:function(_2b){_2.mixin(this,_2b);this.folderId=this.ownerFolder||this.folderId;this.itemUrl=(this.portal&&this.portal.portalUrl)+"content/items/"+this.id;this.userItemUrl=_14.formatUrl(this.itemUrl.replace("content",("content/users/"+this.owner)+(this.folderId?"/"+this.folderId:"")));this.itemDataUrl=_14.formatUrl(this.itemUrl+"/data");this.thumbnailUrl=_14.formatUrl(this.itemUrl+"/info/"+this.thumbnail);this.created=this.created?new Date(this.created):null;this.uploaded=this.uploaded?new Date(this.uploaded):null;this.modified=this.modified?new Date(this.modified):null;},addComment:function(_2c){var _2d=_2.isString(_2c)?{"comment":_2c}:_2c;return _14.request(this.itemUrl+"/addComment",_2d,{"usePost":true}).then(_2.hitch(this,function(_2e){return _26(_2.mixin(_2d,{"id":_2e.commentId,"item":this}));}));},updateComment:function(_2f){if(_2f&&_2f.url&&_2f.comment){var _30={"comment":_2f.comment};return _14.request(_2f.url+"/update",_30,{"usePost":true}).then(function(_31){_2f.id=_31.commentId;return _2f;});}else{throw new Error();}},getComments:function(){return _14.requestToTypedArray(this.itemUrl+"/comments",null,null,_26,{"item":this});},deleteComment:function(_32){if(_32&&_32.url){return _14.request(_32.url+"/delete",null,{"usePost":true});}else{throw new Error();}},addRating:function(_33){var _34=_2.isObject(_33)?_33:{"rating":parseFloat(_33)};return _14.request(this.itemUrl+"/addRating",_34,{"usePost":true}).then(_2.hitch(this,function(_35){return new _28(_2.mixin(_34,{"id":_35.ratingId,"item":this}));}));},getRating:function(){return _14.request(this.itemUrl+"/rating").then(_2.hitch(this,function(_36){return new _28(_2.mixin(_36,{"item":this}));}));},deleteRating:function(){return _14.request(this.itemUrl+"/deleteRating",null,{"usePost":true});}}),_37=_1([],{declaredClass:"esri.arcgis.PortalGroup",constructor:function(_38){_2.mixin(this,_38);this.url=(this.portal&&this.portal.portalUrl)+"community/groups/"+this.id;this.thumbnailUrl=_14.formatUrl(this.url+"/info/"+this.thumbnail);this.modified=this.modified?new Date(this.modified):null;this.created=this.created?new Date(this.created):null;},getMembers:function(){return _14.request(this.url+"/users");},queryItems:function(_39){_39=_14.formatQueryParams({},_39);_39.q="group:"+this.id+(_39.q?(" "+_39.q):"");return this.portal.queryItems(_39);}}),_3a=_1([],{declaredClass:"esri.arcgis.PortalFolder",constructor:function(_3b){_2.mixin(this,_3b);this.url=(this.portal&&this.portal.portalUrl)+"content/users/"+this.username+"/"+this.id;this.created=this.created?new Date(this.created):null;},getItems:function(){return _14.requestToTypedArray(this.url,null,null,_2a,{"portal":this.portal,"folderId":this.id});}}),_3c=_1([],{declaredClass:"esri.arcgis.PortalUser",constructor:function(_3d){_2.mixin(this,_3d);this.url=(this.portal&&this.portal.portalUrl)+"community/users/"+this.username;this.userContentUrl=(this.portal&&this.portal.portalUrl)+"content/users/"+this.username;this.thumbnailUrl=_14.formatUrl(this.url+"/info/"+this.thumbnail);this.modified=this.modified?new Date(this.modified):null;this.created=this.created?new Date(this.created):null;},getGroups:function(){return _d(_14.request(this.url).then(_2.hitch(this,function(_3e){return _14.resultsToTypedArray(_37,{"portal":this.portal},_3e.groups);})));},getNotifications:function(){return _14.requestToTypedArray(this.url+"/notifications",null,null,null,{"portal":this.portal});},getGroupInvitations:function(){return _14.requestToTypedArray(this.url+"/invitations",null,null,null,{"portal":this.portal});},getTags:function(){return _14.requestToTypedArray(this.url+"/tags",null,null,null,{"portal":this.portal});},getFolders:function(){return _d(this.getContent().then(function(_3f){return _3f.folders;}));},getItems:function(_40){return _d(this.getContent(_40).then(function(_41){return _41.items;}));},getItem:function(_42){var url=this.portal.portalUrl+"content/items/"+_42;return _14.request(url).then(_2.hitch(this,function(_43){return new _2a(_2.mixin(_43,{"portal":this.portal}));}));},getContent:function(_44){var url=(this.url.replace("community","content"))+(_44?("/"+_44):"");return _14.request(url).then(_2.hitch(this,function(_45){_45.folders=_14.resultsToTypedArray(_3a,{"portal":this.portal},_45.folders);_45.items=_14.resultsToTypedArray(_2a,{"portal":this.portal,"folderId":_44},_45.items);return _45;}));}}),_46=_1([_7],{declaredClass:"esri.arcgis.Portal",onLoad:function(){},constructor:function(url){_2.mixin(this,{"url":url});this.init(url).then(_2.hitch(this,function(){this.emit("ready",this);this.onLoad(this);}));},init:function(url,_47){url=(url||this.portalUrl).replace(/\/+$/,"");var idx=url.indexOf("/sharing");this.portalUrl=(idx!==-1?(url+"/"):(url+"/sharing/rest/"));return this._getSelf(this.portalUrl).then(_2.hitch(this,function(_48){_c.self=_2.mixin({},_48);var _49=_48.user;if(_49){_49.portal=this;_49=new _3c(_49);}if(_c.self.id&&_c.self.canSearchPublic===false){_c.extraQuery=" AND orgid:"+_c.self.id;}_2.mixin(this,_c.self);_c.loggedInUser=_2.mixin({},_2.mixin(_49,{"credential":_47}));this.thumbnailUrl=_14.formatUrl(this.portalUrl+"accounts/self/resources/"+this.thumbnail);this.isOrganization=(this.access&&this.access.length)||false;this.created=this.created?new Date(this.created):null;this.modified=this.modified?new Date(this.modified):null;return this;}));},signIn:function(){_c.options.disableIdentityLookup=false;return _9.id.getCredential(this.url).then(_2.hitch(this,"init",this.url)).then(function(){return _c.loggedInUser;},function(_4a){_c.options.disableIdentityLookup=true;throw _4a;});},signOut:function(){_c.loggedInUser.credential&&_c.loggedInUser.credential.destroy();_c.loggedInUser=null;_c.options.disableIdentityLookup=true;_14.clearFieldsFromObject(_c.self,this);_c.self=null;return this.init(this.url);},getPortalUser:function(){return _c.loggedInUser;},queryGroups:function(_4b){return this._queryPortal(this.portalUrl+"community/groups",_14.formatQueryParams({},_4b),_37);},queryItems:function(_4c){return this._queryPortal(this.portalUrl+"search",_14.formatQueryParams({},_4c),_2a);},queryUsers:function(_4d){return this._queryPortal(this.portalUrl+"community/users",_14.formatQueryParams({"sortField":"username"},_4d),_3c);},_getSelf:function(url){var _4e=url+"accounts/self?"+"culture="+_3.locale;return _14.request(_4e);},_queryPortal:function(url,_4f,_50){var _51=_2.mixin({"num":10,"start":0,"sortField":"title","sortOrder":"asc"},_4f),_52=["start","query","num","nextStart"],dfd=_14.request(url,_51).then(_2.hitch(this,function(_53){_53.results=_14.resultsToTypedArray(_50,{"portal":this},_53.results);_53.queryParams=_2.mixin({},_51);_53.nextQueryParams=_2.mixin(_51,{"start":_53.nextStart});return _14.clearFieldsFromObject(_52,_53);}));dfd=_2.delegate(dfd);dfd.queryParams=_2.mixin({},_51);dfd.nextQueryParams=_4.when(dfd,function(_54){return _54.nextQueryParams;});return _d(dfd);}}),_55={Portal:_46,PortalFolder:_3a,PortalGroup:_37,PortalItem:_2a,PortalComment:_26,PortalRating:_28,PortalUtil:_14,PortalResult:_d};if(_6("extend-esri")){_2.mixin(_2.getObject("arcgis",true,_9),_55);}return _55;});