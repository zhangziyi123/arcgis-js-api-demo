/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/Attribution",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/kernel","dojo/has","dojo/query","dojo/dom","dojo/dom-attr","dojo/dom-construct","dojo/dom-style","dojo/dom-class","dojo/dom-geometry","esri/kernel","esri/lang","esri/SpatialReference","esri/geometry/webMercatorUtils","esri/geometry/Extent"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12){var ATR=_1(null,{declaredClass:"esri.dijit.Attribution",itemDelimiter:" | ",listClass:"esriAttributionList",itemClass:"esriAttributionItem",lastItemClass:"esriAttributionLastItem",delimiterClass:"esriAttributionDelim",constructor:function(_13,_14){try{_2.mixin(this,_13);this._attributions={};this._pendingDfds={};this._activeLayers=[];this._sharedLayers=[];var _15=(this.domNode=_8.byId(_14)),map=this.map,_16="<span class='"+this.listClass+"'></span>";if(_15){_9.set(_15,"innerHTML",_16);this.listNode=_5.query(".esriAttributionList",_15)[0];this.itemNodes={};}this._eventConnections=[_4.connect(map,"onLayerAdd",this,this._onLayerAdd),_4.connect(map,"onLayerRemove",this,this._onLayerRemove),_4.connect(map,"onLayerSuspend",this,this._onLayerSuspend),_4.connect(map,"onLayerResume",this,this._onLayerResume),_4.connect(map,"onExtentChange",this,this._onExtentChange)];if(map.loaded){var _17=map.layerIds.concat(map.graphicsLayerIds),_18,i,len=_17.length;for(i=0;i<len;i++){_18=map.getLayer(_17[i]);if(_18.loaded){this._onLayerAdd(_18);}}}}catch(err){}},startup:function(){},destroy:function(){_3.forEach(this._eventConnections,_4.disconnect);_a.destroy(this.listNode);this.map=this.domNode=this._eventConnections=this.listNode=this._attributions=this._pendingDfds=this.itemNodes=this._activeLayers=this._lastItem=this._sharedLayers=null;},_onLayerAdd:function(_19){try{var _1a=this._attributions,_1b=_19.id;if(_f.isDefined(_1a[_1b])||!_19.showAttribution){return;}if(_19.hasAttributionData){var dfd=_19.getAttributionData();this._pendingDfds[_1b]=1;_1a[_1b]=dfd;dfd.addBoth(_2.partial(this._onAttributionLoad,this,_19));}else{_1a[_1b]=_19.copyright||_19.copyrightText||"";if(_1a[_1b]){if(!_19.suspended){this._activeLayers.push(_1b);}this._createNode(_1b);}else{this._onLayerRemove(_19);}}}catch(err){}},_onAttributionLoad:function(_1c,_1d,_1e){var _1f=_1c._attributions,_20=_1c._pendingDfds,_21=_1d.id;if(!_20||!_20[_21]){return;}delete _20[_21];if(!_1e||_1e instanceof Error){_1e="";}if(_1e){_1f[_21]=_1c._createIndexByLevel(_1e,_1d.declaredClass.toLowerCase().indexOf("vetiledlayer")!==-1);}else{_1f[_21]=_1d.copyright||_1d.copyrightText||"";}if(_1f[_21]){if(!_1d.suspended){_1c._activeLayers.push(_21);}_1c._createNode(_21);}else{_1c._onLayerRemove(_1d);}},_onLayerRemove:function(_22){try{var _23=_22.id,_24=this.itemNodes,idx,_25=-1;this._onLayerSuspend(_22);delete this._attributions[_23];delete this._pendingDfds[_23];idx=this._getGroupIndex(_23);if(idx!==-1){_25=_3.indexOf(this._sharedLayers[idx],_23);if(_25!==-1){this._sharedLayers[idx].splice(_25,1);if(this._sharedLayers[idx].length<=1){this._sharedLayers.splice(idx,1);}}}if(_24[_23]&&_25===-1){_a.destroy(_24[_23]);}delete _24[_23];this._updateLastItem();}catch(err){}},_onLayerSuspend:function(_26){try{var _27=_26.id;if(this._attributions[_27]){var idx=_3.indexOf(this._activeLayers,_27),_28=this.itemNodes[_27];if(idx!==-1){this._activeLayers.splice(idx,1);}if(_28){this._toggleItem(_28,false,this._getGroupIndex(_27));}}}catch(err){}},_onLayerResume:function(_29){try{var _2a=_29.id,_2b=this._attributions[_2a],_2c=this.itemNodes[_2a];if(_2b){if(_3.indexOf(this._activeLayers,_2a)===-1){this._activeLayers.push(_2a);}if(_2c){var _2d=_2.isString(_2b)?_2b:this._getContributorsList(_2b,this.map.extent,this.map.getLevel());if(!_2.isString(_2b)){_9.set(_2c,"innerHTML",(_2d?(_2d+this._getDelimiter()):""));}if(_2d){this._toggleItem(_2c,true,this._getGroupIndex(_2a));}}}}catch(err){}},_onExtentChange:function(_2e,_2f,_30,lod){try{var _31=this._activeLayers,_32=this._attributions,_33=this.itemNodes,_34,_35,_36,i,len=_31.length||0;for(i=0;i<len;i++){_35=_31[i];_36=_32[_35];_34=_33[_35];if(_34&&!_2.isString(_36)){var _37=this._getContributorsList(_36,_2e,lod?lod.level:-1);_9.set(_34,"innerHTML",(_37?(_37+this._getDelimiter()):""));this._toggleItem(_34,!!_37,-1);}}}catch(err){}this._adjustCursorStyle();},_createNode:function(_38){if(!this.domNode){return;}var _39=this._checkShareInfo(_38),_3a=_39&&_39.sharedWith,_3b=_3a&&this.itemNodes[_3a];var map=this.map,_3c=this._attributions[_38],_3d,_3e=(_2.isString(_3c)?_3c:this._getContributorsList(_3c,map.extent,map.getLevel())),_3f=(!!_3e&&!map.getLayer(_38).suspended);if(_3b){this.itemNodes[_38]=_3b;this._toggleItem(_3b,_3f,_39.index);}else{_3d=(this.itemNodes[_38]=_a.create("span",{"class":this.itemClass,"innerHTML":_3e?(_3e+this._getDelimiter()):"","style":{"display":(_3f?"inline":"none")}},this.listNode));if(_3f){this._setLastItem(_3d);}}this._adjustCursorStyle();},_checkShareInfo:function(_40){var _41=this._attributions,_42,i,_43=-1,_44=_41[_40],_45;if(_44&&_2.isString(_44)){for(i in _41){_42=_41[i];if(i!==_40&&_42&&_2.isString(_42)){if(_42.length===_44.length&&_42.toLowerCase()===_44.toLowerCase()){_45=i;break;}}}var _46=this._sharedLayers,len=_46.length,_47;if(_45){for(i=0;i<len;i++){_47=_46[i];if(_3.indexOf(_47,_45)!==-1){_43=i;_47.push(_40);break;}}if(_43===-1){_43=_46.push([_45,_40])-1;}}}return (_43>-1)?{index:_43,sharedWith:_45}:null;},_getGroupIndex:function(_48){var _49=this._sharedLayers,i,len=_49.length,_4a=-1;for(i=0;i<len;i++){if(_3.indexOf(_49[i],_48)!==-1){_4a=i;break;}}return _4a;},_getDelimiter:function(){var _4b=this.itemDelimiter;return _4b?("<span class='"+this.delimiterClass+"'>"+_4b+"</span>"):"";},_toggleItem:function(_4c,_4d,_4e){if(_4e>-1&&!_4d){var _4f=this._sharedLayers[_4e],i,len=_4f.length,_50=this._activeLayers;for(i=0;i<len;i++){if(_3.indexOf(_50,_4f[i])!==-1){return;}}}_b.set(_4c,"display",(_4d?"inline":"none"));this._updateLastItem();},_updateLastItem:function(){var _51=this.listNode.childNodes,i,len=_51.length,_52;if(len){for(i=len-1;i>=0;i--){_52=_51[i];if(_b.get(_52,"display")!=="none"){this._setLastItem(_52);break;}}}this._adjustCursorStyle();},_setLastItem:function(_53){var _54=this.itemClass,_55=this.lastItemClass;if(this._lastItem){_c.replace(this._lastItem,_54,_55);}if(_53){_c.replace(_53,_55,_54);this._lastItem=_53;}},_createIndexByLevel:function(_56,_57){var _58=_56.contributors,_59,_5a,_5b,i,_5c=_58?_58.length:0,j,_5d,z,sr=new _10(4326),_5e={},_5f,_60;for(i=0;i<_5c;i++){_59=_58[i];_5a=_59.coverageAreas;_5d=_5a?_5a.length:0;for(j=0;j<_5d;j++){_5b=_5a[j];_60=_5b.bbox;_5f={extent:_11.geographicToWebMercator(new _12(_60[1],_60[0],_60[3],_60[2],sr)),attribution:_59.attribution||"",zoomMin:_5b.zoomMin-((_57&&_5b.zoomMin)?1:0),zoomMax:_5b.zoomMax-((_57&&_5b.zoomMax)?1:0),score:_f.isDefined(_5b.score)?_5b.score:100,objectId:i};for(z=_5f.zoomMin;z<=_5f.zoomMax;z++){_5e[z]=_5e[z]||[];_5e[z].push(_5f);}}}return _5e;},_getContributorsList:function(_61,_62,_63){var _64="";if(_62&&_f.isDefined(_63)&&_63>-1){var _65=_61[_63],_66,_67=_62.getCenter().normalize(),i,_68=_65?_65.length:0,_69=[],_6a={};for(i=0;i<_68;i++){_66=_65[i];if(!_6a[_66.objectId]&&_66.extent.contains(_67)){_6a[_66.objectId]=1;_69.push(_66);}}_69.sort(function(a,b){return b.score-a.score;});_68=_69.length;for(i=0;i<_68;i++){_69[i]=_69[i].attribution;}_64=_69.join(", ");}return _64;},_adjustCursorStyle:function(){var _6b=_d.position(this.listNode.parentNode,true).h;if(_c.contains(this.listNode.parentNode,"esriAttributionOpen")){_c.remove(this.listNode.parentNode,"esriAttributionOpen");if(_6b>_d.position(this.listNode.parentNode,true).h){_b.set(this.listNode.parentNode,"cursor","pointer");_c.add(this.listNode.parentNode,"esriAttributionOpen");}else{_b.set(this.listNode.parentNode,"cursor","default");}}else{_c.add(this.listNode.parentNode,"esriAttributionOpen");if(_6b<_d.position(this.listNode.parentNode,true).h){_b.set(this.listNode.parentNode,"cursor","pointer");}else{_b.set(this.listNode.parentNode,"cursor","default");}_c.remove(this.listNode.parentNode,"esriAttributionOpen");}}});if(_6("extend-esri")){_2.setObject("dijit.Attribution",ATR,_e);}return ATR;});