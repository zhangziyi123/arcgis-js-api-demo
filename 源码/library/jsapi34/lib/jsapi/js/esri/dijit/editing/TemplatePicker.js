/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
require({cache:{"url:esri/dijit/editing/templates/TemplatePicker.html":"<div class=\"templatePicker\">\r\n\r\n  <table dojoType=\"dojox.grid.DataGrid\" noDataMessage=\"${emptyMessage}\" selectionMode=\"none\" autoHeight=\"${_rows}\" autoWidth=\"${_autoWidth}\"\r\n         query=\"{ query: '*' }\" dojoAttachPoint=\"grid\" class=\"grid\">\r\n  </table>\r\n  \r\n</div>"}});define("esri/dijit/editing/TemplatePicker",["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/html","dojo/_base/array","dojo/_base/json","dojo/_base/kernel","dojo/has","dojo/query","dojo/sniff","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dijit/_Widget","dijit/_Templated","dojo/data/ItemFileReadStore","dojox/grid/DataGrid","dojox/gfx","esri/layers/FeatureLayer","esri/symbols/PictureMarkerSymbol","esri/dijit/editing/TemplatePickerItem","esri/kernel","esri/lang","esri/request","dojo/i18n!esri/nls/jsapi","dojo/text!esri/dijit/editing/templates/TemplatePicker.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,gfx,_14,_15,_16,_17,_18,_19,_1a,_1b){var TP=_2([_10,_11],{declaredClass:"esri.dijit.editing.TemplatePicker",widgetsInTemplate:true,templateString:_1b,basePath:_1.toUrl("esri/dijit/editing")+"/",featureLayers:null,items:null,grouping:true,showTooltip:false,maxLabelLength:0,rows:4,columns:3,surfaceWidth:30,surfaceHeight:30,emptyMessage:"",useLegend:true,legendCache:{},_uniqueId:{id:0},_assumedCellWidth:90,_initialAutoWidth:300,_initialAutoHeight:200,_ieTimer:150,constructor:function(_1c,_1d){_1c=_1c||{};if(!_1c.items&&!_1c.featureLayers){console.error("TemplatePicker: please provide 'featureLayers' or 'items' parameter in the constructor");}this._dojo14x=(_8.version.minor>=4);this._itemWidgets={};if(_1c.featureLayers&&_1c.featureLayers.length){this._flChanged=1;}this._nls=_1a.widgets.templatePicker;this.emptyMessage=_1c.emptyMessage||(this._nls&&this._nls.creationDisabled)||"";},postMixInProperties:function(){this.inherited(arguments);this._preprocess();},startup:function(){this.inherited(arguments);if(this.rows==="auto"&&this.columns==="auto"){var box=_e.getContentBox(this.domNode);if(!box.w){this.domNode.style.width=this._initialAutoWidth+"px";}if(!box.h){this.domNode.style.height=this._initialAutoHeight+"px";}box=_e.getContentBox(this.domNode);this._columns=Math.floor(box.w/this._assumedCellWidth)||1;}this._applyGridPatches();this._setGridLayout();_4.connect(this.grid,"onRowClick",this,this._rowClicked);this._setGridData();this._toggleTooltip();if(_9("ie")<9){this._repaintItems=_3.hitch(this,this._repaintItems);setTimeout(this._repaintItems,this._ieTimer);}},destroy:function(){this.showTooltip=false;this._toggleTooltip();this._clearLegendInfo();this.featureLayers=this.items=this.grid=this._flItems=this._itItems=this._groupRowIndices=this._selectedCell=this._selectedInfo=this._selectedItem=null;this.inherited(arguments);},getSelected:function(){return this._selectedCell?this._selectedItem:null;},clearSelection:function(){var _1e=this._selectedCell,_1f=this._selectedInfo;if(_1e){this._rowClicked({cellNode:_1e,rowIndex:_1f.selRow,cellIndex:_1f.selCol});}},update:function(_20){var _21=(this.rows==="auto"&&this.columns==="auto"&&_20)?true:false,_22=this.grid,box;if(_21){var _23=this.domNode,id=_23.id,_24,_25=_8.query("#"+id+".templatePicker div.item")[0];box=_e.getContentBox(_23);_25=_25&&_25.parentNode;if(_25){_24=_5.coords(_25).w;}else{_24=this._assumedCellWidth;}this._columns=Math.floor((box.w-_22.views.views[0].getScrollbarWidth())/_24);this._columns=this._columns||1;}var _26=this._rows;this._preprocess();var _27=this._rows;this._setGridLayout();this._setGridData();if(_27!==_26){_22.set("autoHeight",this._rows,false);}if(_21){_22._resize({w:box.w,h:box.h});_22.viewsHeaderNode.style.display="none";}else{_22.update();}this._toggleTooltip();var _28=this,_29=this.getSelected();if(_29){_22.store.fetch({onComplete:function(its){var _2a=_28._locate(_29,_28._selectedInfo,its);var _2b=_2a&&_22.views.views[0].getCellNode(_2a[0],_2a[1]);if(_2b){_28._rowClicked({cellNode:_2b,rowIndex:_2a[0],cellIndex:_2a[1]},true);}}});}if(_9("ie")<9){setTimeout(this._repaintItems,this._ieTimer);}var _2c=this.featureLayers,_2d=this.items;if((!_2c||!_2c.length)&&(!_2d||!_2d.length)&&_22&&this.emptyMessage){_22.showMessage(this.emptyMessage);}},onSelectionChange:function(){},_setUseLegendAttr:function(use){var _2e=this.useLegend;if(!this._started||_2e!==use){if(use){this._flChanged=1;}else{this._clearLegendInfo();}}this.useLegend=use;},_setFeatureLayersAttr:function(_2f){var _30=this.featureLayers;if(!this._started||_30!==_2f){this._flChanged=1;}this.featureLayers=_2f;},_preprocess:function(){if(this.items){this.grouping=false;}this._autoWidth=false;if(this.rows==="auto"||this.columns==="auto"){this._autoWidth=true;}var _31;if(this.featureLayers){if(this.useLegend&&this._flChanged){this._legendIndices=[];this._loadingIndices=[];this._legendSymbols={};this._ignoreLegends();this._loadingLegends=[];clearTimeout(this._legendTimer);this._legendTimer=null;this._processSelectionLayers();this._flChanged=0;}_31=this._flItems=this._getItemsFromLayers(this.featureLayers);}else{_31=this._itItems=this._getItemsFromItems(this.items);}if(this.rows==="auto"&&this.columns==="auto"){if(!this._started){this._rows=false;this._columns=null;this._autoWidth=false;}return;}var len=0;this._rows=this.rows;this._columns=this.columns;if(this.rows==="auto"){if(this.featureLayers){if(this.grouping){len=_31.length;_6.forEach(_31,function(_32){len+=Math.ceil(_32.length/this.columns);},this);}else{_6.forEach(_31,function(_33){len+=_33.length;},this);len=Math.ceil(len/this.columns);}}else{len=Math.ceil(_31.length/this.columns);}this._rows=len;}else{if(this.columns==="auto"){if(this.featureLayers){if(this.grouping){len=3;}else{_6.forEach(_31,function(_34){len+=_34.length;},this);len=Math.ceil(len/this.rows);}}else{len=Math.ceil(_31.length/this.rows);}this._columns=len;}}},_processSelectionLayers:function(){var map,_35,_36,_37,key,_38,_39,_3a={};_6.forEach(this.featureLayers,function(_3b,idx){if(_3b.mode===_14.MODE_SELECTION&&_3b._map&&_3b.url&&_3b._params.drawMode&&!_3b.source){_35=_3.trim(_3b._url.path).replace(/\/(MapServer|FeatureServer).*/ig,"/MapServer").replace(/^https?:\/\//ig,"").toLowerCase();_36=(_3a[_35]=_3a[_35]||{});_37=(_36.featureLayers=_36.featureLayers||{});_38=(_36.indices=_36.indices||[]);_37[idx]=_3b;_38.push(idx);map=_3b._map;}});if(map){_6.forEach(map.layerIds,function(_3c){_3c=map.getLayer(_3c);if(_3c&&_3c.url&&(_3c.getImageUrl||_3c.getTileUrl)&&_3c.loaded&&_3c.version>=10.1){_35=_3.trim(_3c._url.path).replace(/(\/MapServer).*/ig,"$1");key=_35.replace(/^https?:\/\//ig,"").toLowerCase();if(_3a[key]&&(!_3a[key].mapServiceUrl)){_36=_3a[key];_36.mapServiceUrl=_35;_36.mapServiceLayer=_3c;this._legendIndices=this._legendIndices.concat(_36.indices);_39=this._fetchLegend({pickerInstance:this,info:_36},key);if(_39.then){this._loadingIndices=this._loadingIndices.concat(_36.indices);this._loadingLegends.push(_39);}else{this._processLegendResponse(_39,_36);}}}},this);}},_fetchLegend:function(_3d,key){var _3e=TP.prototype,_3f=_3e.legendCache[key];if(!_3f){_3f=(_3e.legendCache[key]=_19({url:_3d.info.mapServiceUrl+"/legend",content:{f:"json"},callbackParamName:"callback"}));_3f._contexts=[_3d];_3f.addBoth(function(_40){if(_3f.canceled){return;}_3e.legendCache[key]=_40;var _41=_3f._contexts;_3f._contexts=null;_6.forEach(_41,function(_42){var _43=_42.pickerInstance,_44=_42.info,_45;if(_43._destroyed){return;}_6.forEach(_44.indices,function(idx){_45=_6.indexOf(_43._loadingIndices,idx);if(_45>-1){_43._loadingIndices.splice(_45,1);}});_45=_6.indexOf(_43._loadingLegends,_3f);if(_45>-1){_43._loadingLegends.splice(_45,1);}_43._processLegendResponse(_40,_44);});});}else{if(_3f.then){_3f._contexts.push(_3d);}}return _3f;},_clearLegendInfo:function(){clearTimeout(this._legendTimer);this._ignoreLegends();this._legendIndices=this._loadingIndices=this._legendSymbols=this._loadingLegends=this._legendTimer=null;},_ignoreLegends:function(){if(this._loadingLegends){_6.forEach(this._loadingLegends,function(_46){var _47=-1;_6.some(_46._contexts,function(_48,idx){if(_48.pickerInstance===this){_47=idx;}return (_47>-1);},this);if(_47>-1){_46._contexts.splice(_47,1);}},this);}},_processLegendResponse:function(_49,_4a){if(_49&&!(_49 instanceof Error)){_6.forEach(_4a.indices,function(idx){var _4b=_4a.featureLayers[idx].layerId,i,_4c=_4a.mapServiceUrl+"/"+_4b+"/images/",_4d=_4a.mapServiceLayer._getToken(),_4e,obj,_4f,url;if(this._legendSymbols[idx]){return;}_4e=null;_6.some(_49.layers,function(_50){if(_50.layerId==_4b){_4e=_50;}return !!_4e;});if(_4e){obj=(this._legendSymbols[idx]={});_6.forEach(_4e.legend,function(_51){_4f=_51.values;if(_4f&&_4f.length){for(i=0;i<_4f.length;i++){obj[_4f[i]]=_51;}}else{obj.defaultSymbol=_51;}url=_51.url;if(url&&!_51._fixed){_51._fixed=1;if((url.search(/https?\:/)===-1)){_51.url=_4c+url;}if(_4d&&_51.url.search(/https?\:/)!==-1){_51.url+=(((_51.url.indexOf("?")>-1)?"&":"?")+"token="+_4d);}}});}},this);}else{var _52;_6.forEach(_4a.indices,function(idx){_52=_6.indexOf(this._legendIndices,idx);if(_52>-1){this._legendIndices.splice(_52,1);}},this);}var _53=this;if(_53._started&&!_53._legendTimer){_53._legendTimer=setTimeout(function(){clearTimeout(_53._legendTimer);_53._legendTimer=null;if(!_53._destroyed){_53.update();}},0);}},_applyGridPatches:function(){var _54=this.grid;var _55=_54.adaptWidth,_56,i,_57;_54.adaptWidth=function(){_56=this.views.views;for(i=0;_57=_56[i];i++){_f.set(_57.headerNode,"display","block");}_55.apply(this,arguments);for(i=0;_57=_56[i];i++){_f.set(_57.headerNode,"display","none");}};if(this._dojo14x){if(this.rows!=="auto"&&this.columns!=="auto"){var _58=_4.connect(_54,"_onFetchComplete",this,function(){_4.disconnect(_58);this.grid.set("autoHeight",this._rows);});}_4.connect(_54,"_onDelete",this,this._destroyItems);_4.connect(_54,"_clearData",this,this._destroyItems);_4.connect(_54,"destroy",this,this._destroyItems);var _59=_54.focus;if(_59&&_59.findAndFocusGridCell){_59.findAndFocusGridCell=function(){return false;};}}},_setGridLayout:function(){var _5a=function(_5b){return function(_5c,_5d){return this._cellGet(_5b,_5c,_5d);};};var _5e=_3.hitch(this,this._cellFormatter),_5f=[],_60=this._columns,i;for(i=0;i<_60;i++){_5f.push({field:"cell"+i,get:_3.hitch(this,_5a(i)),formatter:_5e});}var _61={cells:[_5f]};if(this.grouping){var _62={field:"groupName",colSpan:_60,get:_3.hitch(this,this._cellGetGroup),formatter:_3.hitch(this,this._cellGroupFormatter)};_61.cells.push([_62]);}var _63=this.grid,_64=_13.prototype.rowsPerPage;_63.set("rowsPerPage",(this._rows>_64)?this._rows:_64);_63.set("structure",_61);},_setGridData:function(){var _65=[];if(this.grouping){this._groupRowIndices=[];var _66,_67,_68=this._columns;_6.forEach(this._flItems,function(_69,idx){_65.push({});var _6a=(idx===0)?0:(_66+_67+1);this._groupRowIndices.push(_6a);_66=_6a;_67=Math.ceil(_69.length/_68);_65=_65.concat(this._getStoreItems(_69));},this);}else{if(this.featureLayers){_6.forEach(this._flItems,function(_6b){_65=_65.concat(_6b);});_65=this._getStoreItems(_65);}else{_65=this._getStoreItems(this._itItems);}}var _6c=new _12({data:{items:_65}});this.grid.setStore(_6c);},_toggleTooltip:function(){if(this.showTooltip){if(this.tooltip){return;}this.tooltip=_d.create("div",{"class":"tooltip"},this.domNode);this.tooltip.style.display="none";this.tooltip.style.position="fixed";var _6d=this.grid;this._mouseOverConnect=_4.connect(_6d,"onCellMouseOver",this,this._cellMouseOver);this._mouseOutConnect=_4.connect(_6d,"onCellMouseOut",this,this._cellMouseOut);}else{if(this.tooltip){_4.disconnect(this._mouseOverConnect);_4.disconnect(this._mouseOutConnect);_d.destroy(this.tooltip);this.tooltip=null;}}},_rowClicked:function(evt,_6e){var _6f=evt.cellNode,row=evt.rowIndex,col=evt.cellIndex;var _70=this._getCellInfo(_6f,row,col);if(!_70){return;}var _71=this.grid.store;if(_71.getValue(_70,"loadingCell")){return;}if(this._selectedCell){_c.remove(this._selectedCell,"selectedItem");}if(_6f!==this._selectedCell){_c.add(_6f,"selectedItem");this._selectedCell=_6f;this._selectedItem={featureLayer:_71.getValue(_70,"layer"),type:_71.getValue(_70,"type"),template:_71.getValue(_70,"template"),symbolInfo:_71.getValue(_70,"symbolInfo"),item:this._getItem(_70)};this._selectedInfo={selRow:row,selCol:col,index1:_71.getValue(_70,"index1"),index2:_71.getValue(_70,"index2"),index:_71.getValue(_70,"index")};}else{this._selectedCell=this._selectedInfo=this._selectedItem=null;}if(!_6e){this.onSelectionChange();}},_locate:function(_72,_73,_74){var _75=this.grid.store,_76=new Array(this._columns);var _77,_78=_73.index1,_79=_73.index2,_7a=_73.index,_7b=_72.item;_6.some(_74,function(_7c,_7d){return _6.some(_76,function(_7e,_7f){var _80=_75.getValue(_7c,"cell"+_7f);if(_80&&(_7b?(_7a===_75.getValue(_80,"index")):(_78===_75.getValue(_80,"index1")&&_79===_75.getValue(_80,"index2")))){_77=[_7d,_7f];return true;}else{return false;}});});return _77;},_getCellInfo:function(_81,row,col){if(!_81){return;}var _82=this.grid;var _83=_82.getItem(row);var _84=_82.store.getValue(_83,"cell"+col);return _84;},_getItem:function(_85){var _86=this.items;if(_86){return _86[this.grid.store.getValue(_85,"index")];}},_cellMouseOver:function(evt){var _87=this.tooltip;var _88=evt.cellNode,row=evt.rowIndex,col=evt.cellIndex;var _89=this._getCellInfo(_88,row,col);if(_87&&_89){var _8a=this.grid.store;var _8b=_8a.getValue(_89,"template");var _8c=_8a.getValue(_89,"type");var _8d=_8a.getValue(_89,"symbolInfo");var _8e=_8a.getValue(_89,"layer");var _8f=this._getItem(_89);var _90=(_8f&&(_8f.label+(_8f.description?(": "+_8f.description):"")))||(_8b&&(_8b.name+(_8b.description?(": "+_8b.description):"")))||(_8c&&_8c.name)||(_8d&&(_8d.label+(_8d.description?(": "+_8d.description):"")))||((_8e&&_8e.name+": ")+"Default");_87.style.display="none";_87.innerHTML=_90;var _91=_5.coords(_88.firstChild);_f.set(_87,{left:(_91.x)+"px",top:(_91.y+_91.h+5)+"px"});_87.style.display="";}},_cellMouseOut:function(){var _92=this.tooltip;if(_92){_92.style.display="none";}},_destroyItems:function(){var _93=this._itemWidgets,w;for(w in _93){if(!_93[w]){continue;}_93[w].destroy();delete _93[w];}},_repaintItems:function(){var _94=this._itemWidgets,w;for(w in _94){var _95=_94[w];if(_95){_95._repaint(_95._surface);}}},_getStoreItems:function(_96){var uid=this._uniqueId;_96=_6.map(_96,function(_97){return _3.mixin({"surfaceId":"tpick-surface-"+(uid.id++)},_97);});var len=_96.length,_98=0,obj={},k=0,_99,_9a=[],_9b=true,_9c=this._columns;while(_98<len){_9b=true;_99="cell"+k;obj[_99]=_96[_98];_98++;k++;if(k%_9c===0){_9b=false;_9a.push(obj);obj={};k=0;}}if(_9b&&len){_9a.push(obj);}return _9a;},_getItemsFromLayers:function(_9d){var _9e=[];_6.forEach(_9d,function(_9f,_a0){_9e.push(this._getItemsFromLayer(_9f,_a0));},this);return _9e;},_getItemsFromLayer:function(_a1,_a2){var _a3=[];if(this.useLegend&&_6.indexOf(this._loadingIndices,_a2)>-1){return [{label:(this._nls&&this._nls.loading)||"",symbol:null,layer:_a1,type:null,template:null,index1:_a2,index2:0,loadingCell:1}];}var _a4=[];_a4=_a4.concat(_a1.templates);_6.forEach(_a1.types,function(_a5){var _a6=_a5.templates;_6.forEach(_a6,function(_a7){_a7._type_=_a5;});_a4=_a4.concat(_a6);});_a4=_6.filter(_a4,_18.isDefined);var _a8=_a1.renderer;if(_a8){var _a9=_a8.declaredClass.replace("esri.renderer.","");if(_a4.length>0){_6.forEach(_a4,function(_aa){var _ab=_aa.prototype;if(_ab){var _ac=_a8.getSymbol(_ab);if(_ac){var _ad=null,pms,_ae;if(this.useLegend&&_6.indexOf(this._legendIndices,_a2)>-1){_ae=this._legendSymbols&&this._legendSymbols[_a2];if(_ae){switch(_a9){case "SimpleRenderer":_ad=_ae.defaultSymbol;break;case "UniqueValueRenderer":_6.some(_a8.infos,function(_af){if(_af.symbol===_ac){_ad=_ae[_af.value];}return !!_ad;});break;case "ClassBreaksRenderer":_6.some(_a8.infos,function(_b0){if(_b0.symbol===_ac){_ad=_ae[_b0.maxValue];}return !!_ad;});break;}}if(_ad){pms=_7.fromJson(_7.toJson(_15.defaultProps));pms.url=_ad.url;pms.imageData=_ad.imageData;pms.contentType=_ad.contentType;pms.width=_ad.width;pms.height=_ad.height;if(!_18.isDefined(pms.width)||!_18.isDefined(pms.height)){pms.width=15;pms.height=15;}_ad=new _15(pms);}}_a3.push({label:this._trimLabel(_aa.name),symbol:_ad||_ac,legendOverride:!!_ad,layer:_a1,type:_aa._type_,template:_aa,index1:_a2,index2:_a3.length});}}delete _aa._type_;},this);}else{var _b1=[];if(_a9==="TemporalRenderer"){_a8=_a8.observationRenderer;if(_a8){_a9=_a8.declaredClass.replace("esri.renderer.","");}}switch(_a9){case "SimpleRenderer":_b1=[{symbol:_a8.symbol,label:_a8.label,description:_a8.description}];break;case "UniqueValueRenderer":case "ClassBreaksRenderer":_b1=_a8.infos;break;}_a3=_6.map(_b1,function(_b2,idx){return {label:this._trimLabel(_b2.label),description:_b2.description,symbolInfo:_3.mixin({constructor:function(){}},_b2),symbol:_b2.symbol,layer:_a1,index1:_a2,index2:idx};},this);}}return _a3;},_getItemsFromItems:function(_b3){return _6.map(_b3,function(_b4,idx){_b4=_3.mixin({index:idx},_b4);_b4.label=this._trimLabel(_b4.label);return _b4;},this);},_trimLabel:function(_b5){var max=this.maxLabelLength;if(max&&_b5){if(_b5.length>max){_b5=_b5.substr(0,max)+"...";}}return _b5||"";},_cellGet:function(_b6,_b7,_b8){if(!_b8){return "";}return this.grid.store.getValue(_b8,"cell"+_b6);},_cellFormatter:function(_b9){if(_b9){var _ba=this._itemWidgets,_bb=this.grid.store;var sid=_bb.getValue(_b9,"surfaceId");var w=_ba[sid];if(!w){w=(_ba[sid]=new _16({id:sid,label:_bb.getValue(_b9,"label"),symbol:_bb.getValue(_b9,"symbol"),legendOverride:_bb.getValue(_b9,"legendOverride"),surfaceWidth:this.surfaceWidth,surfaceHeight:this.surfaceHeight,template:_bb.getValue(_b9,"template")}));}return w||"";}else{return "";}},_cellGetGroup:function(_bc,_bd){if(!this._groupRowIndices){return "";}var _be=_6.indexOf(this._groupRowIndices,_bc);if(!_bd||_be===-1){return "";}return (this.featureLayers[_be]&&this.featureLayers[_be].name)||"";},_cellGroupFormatter:function(_bf){if(_bf){return "<div class='groupLabel'>"+_bf+"</div>";}else{return "";}}});if(_9("extend-esri")){_3.setObject("dijit.editing.TemplatePicker",TP,_17);}return TP;});