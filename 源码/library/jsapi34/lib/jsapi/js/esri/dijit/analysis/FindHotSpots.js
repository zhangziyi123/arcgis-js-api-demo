/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/analysis/FindHotSpots",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dijit/form/Form,dijit/form/Select,dijit/form/ComboBox,dijit/form/CheckBox,dijit/Menu,dijit/MenuItem,esri/dijit/analysis/HelpWindow,esri/dijit/analysis/utils,esri/dijit/analysis/HelpWindow,esri/dijit/analysis/AnalysisBase,esri/toolbars/draw,esri/dijit/PopupTemplate,esri/map"],function(_1,_2,_3){_2.provide("esri.dijit.analysis.FindHotSpots");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.require("dijit.form.Form");_2.require("dijit.form.Select");_2.require("dijit.form.ComboBox");_2.require("dijit.form.CheckBox");_2.require("dijit.Menu");_2.require("dijit.MenuItem");_2.require("esri.dijit.analysis.HelpWindow");_2.require("esri.dijit.analysis.utils");_2.require("esri.dijit.analysis.HelpWindow");_2.require("esri.dijit.analysis.AnalysisBase");_2.require("esri.toolbars.draw");_2.require("esri.dijit.PopupTemplate");_2.require("esri.map");_2.declare("esri.dijit.analysis.FindHotSpots",[_1._Widget,_1._Templated,esri.dijit.analysis.AnalysisBase],{widgetsInTemplate:true,templateString:"<div class=\"esriAnalysis\">\r\n  <div data-dojo-type=\"dijit.layout.ContentPane\" style=\"margin-top:0.5em; margin-bottom: 0.5em;\">\r\n    <div data-dojo-attach-point=\"_hotspotsToolContentTitle\" class=\"analysisTitle\">\r\n         <table class=\"esriFormTable\" > \r\n            <tr>\r\n              <td><div class=\"findHotSpotsIcon\"></div></td>\r\n              <td>${i18n.findHotSpots}</td>\r\n              <td>\r\n                <div class=\"esriFloatTrailing\" style=\"padding:0;\">\r\n                  <a href=\"#\" class='esriFloatLeading helpIcon' esriHelpTopic=\"toolDescription\"></a>\r\n                  <a href=\"#\" data-dojo-attach-point=\"_closeBtn\" title=\"${i18n.close}\" class=\"closeIcon\">              \r\n                  <img src=\"images/close.gif\" border=\"0\"/></a>            \r\n                </div>\r\n              </td>\r\n            </tr>\r\n         </table>\r\n    </div>\r\n    <div style=\"clear:both; border-bottom: #333 thin solid; height:1px;width:100%;\"></div>\r\n  </div>\r\n  <div data-dojo-type=\"dijit.form.Form\" data-dojo-attach-point=\"_form\" readOnly=\"true\">\r\n     <table class=\"esriFormTable\"  data-dojo-attach-point=\"_hotspotsTable\"> \r\n       <tbody>\r\n        <tr>\r\n          <td  colspan=\"3\" class=\"sectionHeader\" data-dojo-attach-point=\"_hotspotsToolDescription\" ></td>\r\n        </tr>\r\n        <!--<tr data-dojo-attach-point=\"_pointFieldTd\">\r\n           <td colspan=\"3\">\r\n             <label class=\"esriFloatLeading esriTrailingMargin025\">${i18n.oneLabel}</label>\r\n             <label class=\"\">${i18n.chooseAttributeLabel}</label>\r\n           </td>\r\n        </tr>-->\r\n        <tr>\r\n          <td colspan=\"2\">\r\n            <label data-dojo-attach-point=\"_labelOne\" class=\"esriFloatLeading esriTrailingMargin025\">${i18n.oneLabel}</label>\r\n            <label data-dojo-attach-point=\"_polylabel\" class=\"\">${i18n.chooseAttributeLabel}</label>\r\n            <select class=\"longTextInput\"  style=\"margin-top:10px;\" data-dojo-type=\"dijit.form.Select\" data-dojo-attach-point=\"_analysFieldSelect\" data-dojo-attach-event=\"onChange:_handleFieldChange\"></select>\r\n          </td>\r\n          <td class=\"shortTextInput\">\r\n            <a href=\"#\" class='esriFloatTrailing helpIcon' data-dojo-attach-point=\"_analysisFieldHelpLink\" esriHelpTopic=\"AnalysisFieldPoly\"></a> \r\n          </td> \r\n        </tr>\r\n        <tr data-dojo-attach-point=\"_optionsRow\">\r\n          <td colspan=\"3\">\r\n            <div class=\"optionsClose\" style=\"width:99%\" data-dojo-attach-point=\"_optionsDiv\">\r\n              <div class=\"dijitTreeExpando\" data-dojo-attach-event=\"onclick:_handleOptionsBtnClick\"><label class=\"esriLeadingMargin2\">${i18n.Options}</label></div>\r\n              <table class=\"esriFormTable optionsTable\">\r\n                <tbody>\r\n                  <tr>\r\n                    <td colspan=\"2\">\r\n                        <label class=\"longTextInput\">${i18n.defineBoundingLabel}</label>\r\n                    </td>                    \r\n                  </tr>\r\n                  <tr>\r\n                    <td style=\"width:95%\">\r\n                      <select class=\"longTextInput esriMediumlabel\"  style=\"width:100%;table-layout:fixed;\" data-dojo-type=\"dijit.form.Select\" data-dojo-attach-point=\"_boundingAreaSelect\" data-dojo-attach-event=\"onChange:_handleBoundingSelectChange\"></select>                      \r\n                    </td>\r\n                    <td style=\"width:8%\">\r\n                      <button data-dojo-type=\"dijit.form.ToggleButton\" class=\"esriboundingButton\" data-dojo-props=\"showLabel:false,iconClass:'toolbarIcon polygonIcon',style:'width:16px;'\" data-dojo-attach-event=\"onClick:_handleBoundingBtnClick\"></button>\r\n                    </td> \r\n                    <td class=\"shortTextInput\">\r\n                       <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"BoundingPolygonLayer\"></a> \r\n                    </td> \r\n                   \r\n                  </tr>      \r\n                  <tr>\r\n                    <td colspan=\"2\">\r\n                        <label class=\"longTextInput\">${i18n.provideAggLabel}</label>\r\n                    </td>                    \r\n                  </tr>\r\n                  <tr>\r\n                    <td colspan=\"2\">\r\n                        <select class=\"longTextInput\"  data-dojo-type=\"dijit.form.Select\" data-dojo-attach-point=\"_aggAreaSelect\" data-dojo-attach-event=\"onChange:_handleAggAreaSelectChange\"></select>\r\n                    </td>   \r\n                    <td class=\"shortTextInput\">\r\n                      <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"AggregationPolygonLayer\"></a> \r\n                    </td> \r\n                 \r\n                  </tr>                               \r\n                </tbody>\r\n              </table>\r\n            </div>\r\n          </td>\r\n        </tr>\r\n        <tr>\r\n          <td colspan=\"2\">\r\n            <label class=\"esriFloatLeading esriTrailingMargin025\">${i18n.twoLabel}</label>\r\n            <label class=\"longTextInput\">${i18n.outputLayerLabel}</label>\r\n          </td>\r\n          <td class=\"shortTextInput\">\r\n            <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"OutputLayerName\"></a> \r\n          </td>             \r\n        </tr>\r\n        <tr>\r\n          <td colspan=\"3\">\r\n            <input type=\"text\" data-dojo-type=\"dijit.form.TextBox\" class=\"longTextInput esriLeadingMargin05\" data-dojo-attach-point=\"_outputLayerInput\" value=\"${i18n.hotspots}\"></input>\r\n          </td>                \r\n        </tr>                             \r\n      </tbody>         \r\n     </table>\r\n   </div>\r\n  <div id=\"hotspotsToolContentButtons\" style=\"padding:5px;margin-top:5px;border-top:solid 1px #BBB;\">\r\n    <button data-dojo-type=\"dijit.form.Button\" type=\"submit\" data-dojo-attach-point=\"_saveBtn\" class=\"esriLeadingMargin4\" data-dojo-attach-event=\"onClick:_handleSaveBtnClick\">\r\n        ${i18n.runAnalysis}\r\n    </button>\r\n  </div>\r\n</div>\r\n",analysisLayer:null,analysisField:null,aggregationPolygonLayer:null,boundingPolygonLayer:null,outputLayerName:null,i18n:null,map:null,toolName:"FindHotSpots",helpFileName:"FindHotSpots",resultParameter:"HotSpotsResultLayer",constructor:function(_4,_5){this.inherited(arguments);this._pbConnects=[];if(_4.containerNode){this.container=_4.containerNode;}},destroy:function(){this.inherited(arguments);_2.forEach(this._pbConnects,_2.disconnect);delete this._pbConnects;},postMixInProperties:function(){this.inherited(arguments);this.i18n={};_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").common);_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").analysisTools);_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").aggregatePointsTool);_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").findHotSpotsTool);this.set("drawLayerName",this.i18n.blayerName);},postCreate:function(){this.inherited(arguments);_2.addClass(this._form.domNode,"esriSimpleForm");this._buildUI();},startup:function(){},_onClose:function(_6){if(_6){if(this._featureLayer){this.map.removeLayer(this._featureLayer);_2.forEach(this.boundingPolygonLayers,function(_7,_8){if(_7==this._featureLayer){this._boundingAreaSelect.removeOption({value:_8+1,label:this._featureLayer.name});this.boundingPolygonLayers.splice(_8,1);return;}},this);}}this._toolbar.deactivate();this.onClose();},_handleSaveBtnClick:function(e){this._saveBtn.set("disabled",true);var _9={},_a={};if(this.analysisLayer.url){console.log(this.analysisLayer.getDefinitionExpression());var _b={url:this.analysisLayer.url};if(this.analysisLayer.getDefinitionExpression()){_b.filter=this.analysisLayer.getDefinitionExpression();}_9.AnalysisLayer=_2.toJson(_b);}else{if(!this.analysisLayer.url){var _c={};var _d=this.analysisLayer.toJson();_c.featureCollection=_d.layerDefinition;_c.featureCollection.features=_d.featureSet.features;_9.AnalysisLayer=_2.toJson(_c);}}if(this._analysFieldSelect.get("value")!=="0"){_9.AnalysisField=this._analysFieldSelect.get("value");}if(this._isPoint&&this._analysFieldSelect.get("value")==="0"){if(this._boundingAreaSelect.get("value")!=="-1"){var _e=this.boundingPolygonLayers[this._boundingAreaSelect.get("value")-1];if(_e.url){var _f={url:_e.url};if(_e.getDefinitionExpression()){_f.filter=_e.getDefinitionExpression();}_9.BoundingPolygonLayer=_2.toJson(_f);}else{if(!_e.url){var _c={};var _d=_e.toJson();_c.featureCollection=_d.layerDefinition;_c.featureCollection.features=_d.featureSet.features;_9.BoundingPolygonLayer=_2.toJson(_c);}}}if(this._aggAreaSelect.get("value")!=="-1"){var _10=this.aggregationPolygonLayers[this._aggAreaSelect.get("value")-1];if(_10.url){var _11={url:_10.url};if(_10.getDefinitionExpression()){_11.filter=_10.getDefinitionExpression();}_9.AggregationPolygonLayer=_2.toJson(_11);}else{if(!_10.url){var _c={};var _d=_10.toJson();_c.featureCollection=_d.layerDefinition;_c.featureCollection.features=_d.featureSet.features;_9.AggregationPolygonLayer=_2.toJson(_c);}}}}_9.OutputName=_2.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}});_a.jobParams=_9;_a.itemParams={"description":this.i18n.itemDescription,"tags":_2.string.substitute(this.i18n.itemTags,{layername:this.analysisLayer.name,fieldname:(!_9.AnalysisField)?"":_9.AnalysisField}),"snippet":this.i18n.itemSnippet};this.execute(_a);},_save:function(){},_buildUI:function(){this._loadConnections();esri.dijit.analysis.utils.initHelpLinks(this.domNode);if(this.analysisLayer){if(this.analysisLayer.geometryType==="esriGeometryPolygon"){this._isPoint=false;_2.attr(this._hotspotsToolDescription,"innerHTML",_2.string.substitute(this.i18n.hotspotsPolyDefine,{layername:this.analysisLayer.name}));_2.style(this._optionsRow,"display","none");_2.attr(this._analysisFieldHelpLink,"esriHelpTopic","AnalysisFieldPoly");}else{if(this.analysisLayer.geometryType==="esriGeometryPoint"||this.analysisLayer.geometryType==="esriGeometryMultipoint"){this._isPoint=true;_2.attr(this._hotspotsToolDescription,"innerHTML",_2.string.substitute(this.i18n.hotspotsPointDefine,{layername:this.analysisLayer.name}));_2.addClass(this._analysFieldSelect.domNode,"esriLeadingMargin1");_2.style(this._optionsRow,"display","");_2.attr(this._analysisFieldHelpLink,"esriHelpTopic","AnalysisFieldPoint");this._outputLayerInput.set("value",_2.string.substitute(this.i18n.outputLayerName,{layername:this.analysisLayer.name}));}}this.set("AnalyisFields",this.analysisLayer);}if(this.outputLayerName){this._outputLayerInput.set("value",this.outputLayerName);}if(this.boundingPolygonLayers){this._boundingAreaSelect.addOption({value:"-1",label:this.i18n.defaultBoundingOption,selected:true});_2.forEach(this.boundingPolygonLayers,function(_12,_13){if(_12.geometryType==="esriGeometryPolygon"){this._boundingAreaSelect.addOption({value:_13+1,label:_12.name,selected:false});}},this);}if(this.aggregationPolygonLayers){this._aggAreaSelect.addOption({value:"-1",label:this.i18n.defaultAggregationOption,selected:true});_2.forEach(this.aggregationPolygonLayers,function(_14,_15){if(_14.geometryType==="esriGeometryPolygon"){this._aggAreaSelect.addOption({value:_15+1,label:_14.name,selected:false});}},this);}},_handleFieldChange:function(_16){if(this._analysFieldSelect.get("value")==="0"){this._outputLayerInput.set("value",_2.string.substitute(this.i18n.outputLayerName,{layername:this.analysisLayer.name}));if(this._isPoint){_2.removeClass(this._optionsDiv,"disabled");}}else{this._outputLayerInput.set("value",_2.string.substitute(this.i18n.outputLayerName,{layername:this._analysFieldSelect.getOptions(_16).label}));if(this._isPoint){_2.addClass(this._optionsDiv,"disabled");if(_2.hasClass(this._optionsDiv,"optionsOpen")){_2.removeClass(this._optionsDiv,"optionsOpen");_2.addClass(this._optionsDiv,"optionsClose");}}}},_handleOptionsBtnClick:function(){if(_2.hasClass(this._optionsDiv,"disabled")){return;}else{if(_2.hasClass(this._optionsDiv,"optionsClose")){_2.removeClass(this._optionsDiv,"optionsClose");_2.addClass(this._optionsDiv,"optionsOpen");}else{if(_2.hasClass(this._optionsDiv,"optionsOpen")){_2.removeClass(this._optionsDiv,"optionsOpen");_2.addClass(this._optionsDiv,"optionsClose");}}}},_handleBoundingSelectChange:function(_17){this._aggAreaSelect.set("disabled",this._boundingAreaSelect.get("value")!=="-1");},_handleAggAreaSelectChange:function(_18){this._boundingAreaSelect.set("disabled",this._aggAreaSelect.get("value")!=="-1");},_handleBoundingBtnClick:function(e){e.preventDefault();this.onDrawToolActivate();if(!this._featureLayer){this._createBoundingPolyFeatColl();}this._toolbar.activate(esri.toolbars.Draw.POLYGON);},_loadConnections:function(){this._connect(this,"onExecute",_2.hitch(this,"_onClose",false));this._connect(this._closeBtn,"onclick",_2.hitch(this,"_onClose",true));},_createBoundingPolyFeatColl:function(){var _19={"layerDefinition":null,"featureSet":{"features":[],"geometryType":"esriGeometryPolygon"}};_19.layerDefinition={"currentVersion":10.11,"copyrightText":"","defaultVisibility":true,"relationships":[],"isDataVersioned":false,"supportsRollbackOnFailureParameter":true,"supportsStatistics":true,"supportsAdvancedQueries":true,"geometryType":"esriGeometryPolygon","minScale":0,"maxScale":0,"objectIdField":"OBJECTID","templates":[],"type":"Feature Layer","displayField":"TITLE","visibilityField":"VISIBLE","name":this.drawLayerName,"hasAttachments":false,"typeIdField":"TYPEID","capabilities":"Query","allowGeometryUpdates":true,"htmlPopupType":"","hasM":false,"hasZ":false,"globalIdField":"","typeIdField":"","supportedQueryFormats":"JSON","hasStaticData":false,"maxRecordCount":-1,"indexes":[],"types":[],"drawingInfo":{"renderer":{"type":"simple","symbol":{"color":[0,0,0,255],"outline":{"color":[0,0,0,255],"width":3,"type":"esriSLS","style":"esriSLSSolid"},"type":"esriSFS","style":"esriSFSNull"},"label":"","description":""},"transparency":0,"labelingInfo":null,"fixedSymbols":true},"fields":[{"alias":"OBJECTID","name":"OBJECTID","type":"esriFieldTypeOID","editable":false},{"alias":"Title","name":"TITLE","length":50,"type":"esriFieldTypeString","editable":true},{"alias":"Visible","name":"VISIBLE","type":"esriFieldTypeInteger","editable":true},{"alias":"Description","name":"DESCRIPTION","length":1073741822,"type":"esriFieldTypeString","editable":true},{"alias":"Type ID","name":"TYPEID","type":"esriFieldTypeInteger","editable":true}]};var _1a=new esri.dijit.PopupTemplate({title:"{title}",description:"{description}"});this._featureLayer=new esri.layers.FeatureLayer(_19,{id:this.drawLayerName});this.map.addLayer(this._featureLayer);_2.connect(this._featureLayer,"onClick",_2.hitch(this,function(evt){this.map.infoWindow.setFeatures([evt.graphic]);}));},_addFeatures:function(_1b){this.onDrawToolDeactivate();this._toolbar.deactivate();var _1c=[];var _1d={};var _1e=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new _2.Color([0,0,0]),4));var _1f=new esri.Graphic(_1b,_1e);this.map.graphics.add(_1f);_1d["description"]="blayer desc";_1d["title"]="blayer";_1f.setAttributes(_1d);_1c.push(_1f);this._featureLayer.applyEdits(_1c,null,null);if(this.boundingPolygonLayers.length===0||this.boundingPolygonLayers[this.boundingPolygonLayers.length-1]!==this._featureLayer){var _20=this.boundingPolygonLayers.push(this._featureLayer);var _21=this._boundingAreaSelect.getOptions();this._boundingAreaSelect.removeOption(_21);_21=_2.map(_21,function(_22){_22.selected=false;return _22;});this._boundingAreaSelect.addOption({value:_20,label:this._featureLayer.name,selected:true});this._boundingAreaSelect.addOption(_21);}},_setAnalysisGpServerAttr:function(url){this.analysisGpServer=url;this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);},_setAnalysisLayerAttr:function(_23){this.analysisLayer=_23;},_setAnalyisFieldsAttr:function(_24){var _25=_24.fields;if(this._isPoint){this._analysFieldSelect.addOption({value:"0",label:this.i18n.noAnalysisField});}_2.forEach(_25,function(_26,_27){if(_2.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],_26.type)!==-1){this._analysFieldSelect.addOption({value:_26.name,label:_26.name});}},this);},_setMapAttr:function(map){this.map=map;this._toolbar=new esri.toolbars.Draw(this.map);_2.connect(this._toolbar,"onDrawEnd",_2.hitch(this,this._addFeatures));},_getMapAttr:function(){return this.map;},_setDrawLayerNameAttr:function(_28){this.drawLayerName=_28;},_getDrawLayerNameAttr:function(){return this._featureLayer.name;},_getDrawLayerAttr:function(){return this._featureLayer;},_getDrawToolbarAttr:function(){return this._toolbar;},_setDisableRunAnalysisAttr:function(_29){this._saveBtn.set("disabled",_29);},_connect:function(_2a,evt,_2b){this._pbConnects.push(_2.connect(_2a,evt,_2b));},onDrawToolActivate:function(){},onDrawToolDeactivate:function(){},onSave:function(){},onClose:function(){}});});