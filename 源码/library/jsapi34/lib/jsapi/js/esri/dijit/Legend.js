/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/Legend",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/sniff","dojo/DeferredList","dojo/json","dojo/dom","dojo/dom-construct","dojo/dom-style","dijit/_Widget","dojox/gfx","dojox/html/entities","esri/kernel","esri/config","esri/request","esri/geometry/scaleUtils","esri/renderers/SimpleRenderer","esri/renderers/UniqueValueRenderer","esri/renderers/ClassBreaksRenderer","esri/symbols/jsonUtils","dojo/i18n!esri/nls/jsapi"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18){var _19=_1([_d],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:false,layers:null,alignRight:false,_ieTimer:100,constructor:function(_1a,_1b){_2.mixin(this,_18.widgets.legend);_1a=_1a||{};if(!_1a.map){console.error("esri.dijit.Legend: unable to find the 'map' property in parameters");return;}if(!_1b){console.error("esri.dijit.Legend: must specify a container for the legend");return;}this.map=_1a.map;this.layerInfos=_1a.layerInfos;this._respectCurrentMapScale=(_1a.respectCurrentMapScale===false)?false:true;this.arrangement=(_1a.arrangement===_19.ALIGN_RIGHT)?_19.ALIGN_RIGHT:_19.ALIGN_LEFT;if(this.arrangement===_19.ALIGN_RIGHT){this.alignRight=true;}this.autoUpdate=(_1a.autoUpdate===false)?false:true;this._surfaceItems=[];},startup:function(){this.inherited(arguments);this._initialize();if(_6("ie")){this._repaintItems=_2.hitch(this,this._repaintItems);setTimeout(this._repaintItems,this._ieTimer);}},destroy:function(){this._deactivate();this.inherited(arguments);},refresh:function(_1c){var i;if(!this.domNode){return;}if(_1c){this.layerInfos=_1c;this.layers=[];_3.forEach(this.layerInfos,function(_1d){if(this._isSupportedLayerType(_1d.layer)){if(_1d.title){_1d.layer._titleForLegend=_1d.title;}if(_1d.defaultSymbol===false){_1d.layer._hideDefaultSymbolInLegend=true;}if(_1d.hideLayers){_1d.layer._hideLayersInLegend=_1d.hideLayers;this._addSubLayersToHide(_1d);}else{_1d.layer._hideLayersInLegend=[];}this.layers.push(_1d.layer);}},this);}else{if(this.useAllMapLayers){this.layerInfos=null;this.layers=null;}}for(i=this.domNode.children.length-1;i>=0;i--){_b.destroy(this.domNode.children[i]);}this.startup();},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){if(this.layerInfos){this.layers=[];_3.forEach(this.layerInfos,function(_1e){if(this._isSupportedLayerType(_1e.layer)){if(_1e.title){_1e.layer._titleForLegend=_1e.title;}if(_1e.defaultSymbol===false){_1e.layer._hideDefaultSymbol=true;}if(_1e.hideLayers){_1e.layer._hideLayersInLegend=_1e.hideLayers;this._addSubLayersToHide(_1e);}else{_1e.layer._hideLayersInLegend=[];}this.layers.push(_1e.layer);}},this);}this.useAllMapLayers=false;if(!this.layers){this.useAllMapLayers=true;this.layers=[];var _1f=[];var _20=[];_3.forEach(this.map.layerIds,function(_21){var _22=this.map.getLayer(_21);if(this._isSupportedLayerType(_22)){if(_22.arcgisProps&&_22.arcgisProps.title){_22._titleForLegend=_22.arcgisProps.title;}this.layers.push(_22);}if(_22.declaredClass=="esri.layers.KMLLayer"){var _23=_22.getLayers();_3.forEach(_23,function(_24){_1f.push(_24.id);},this);}if(_22.declaredClass=="esri.layers.GeoRSSLayer"){var _23=_22.getFeatureLayers();_3.forEach(_23,function(_25){_20.push(_25.id);},this);}},this);_3.forEach(this.map.graphicsLayerIds,function(_26){var _27=this.map.getLayer(_26);if(_3.indexOf(_1f,_26)==-1&&_3.indexOf(_20,_26)==-1){if(this._isSupportedLayerType(_27)&&_27._params&&_27._params.drawMode){if(_27.arcgisProps&&_27.arcgisProps.title){_27._titleForLegend=_27.arcgisProps.title;}this.layers.push(_27);}}},this);}this._createLegend();},_activate:function(){this._deactivate();if(!this.autoUpdate){return;}if(this._respectCurrentMapScale){this._ozeConnect=_4.connect(this.map,"onZoomEnd",this,"_refreshLayers");}if(this.useAllMapLayers){this._olaConnect=_4.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers");this._olrConnect=_4.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers");this._olroConnect=_4.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers");}_3.forEach(this.layers,function(_28){_28.ovcConnect=_4.connect(_28,"onVisibilityChange",this,"_refreshLayers");_28.oscConnect=_4.connect(_28,"onScaleRangeChange",this,"_refreshLayers");if(_28.declaredClass==="esri.layers.ArcGISDynamicMapServiceLayer"&&_28.supportsDynamicLayers){_28.odcConnect=_4.connect(_28,"_onDynamicLayersChange",this,"_updateDynamicLayers");}},this);},_deactivate:function(){if(this._ozeConnect){_4.disconnect(this._ozeConnect);}if(this._olaConnect){_4.disconnect(this._olaConnect);}if(this._olroConnect){_4.disconnect(this._olroConnect);}if(this._olrConnect){_4.disconnect(this._olrConnect);}_3.forEach(this.layers,function(_29){if(_29.ovcConnect){_4.disconnect(_29.ovcConnect);}if(_29.oscConnect){_4.disconnect(_29.oscConnect);}if(_29.odcConnect){_4.disconnect(_29.odcConnect);}},this);},_updateDynamicLayers:function(){this._dynamicLayerChanged=true;this._refreshLayers();},_refreshLayers:function(){this.refresh();},_updateAllMapLayers:function(){this.layers=[];_3.forEach(this.map.layerIds,function(_2a){var _2b=this.map.getLayer(_2a);if(this._isSupportedLayerType(_2b)){this.layers.push(_2b);}},this);_3.forEach(this.map.graphicsLayerIds,function(_2c){var _2d=this.map.getLayer(_2c);if(this._isSupportedLayerType(_2d)&&_2d._params&&_2d._params.drawMode){this.layers.push(_2d);}},this);this.refresh();},_createLegend:function(){_c.set(this.domNode,"position","relative");_b.create("div",{id:this.id+"_msg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var _2e=[];_3.forEach(this.layers,function(_2f){if(_2f.declaredClass=="esri.layers.KMLLayer"||_2f.declaredClass=="esri.layers.GeoRSSLayer"){var _30;if(_2f.declaredClass=="esri.layers.KMLLayer"){_30=_2f.getLayers();}else{if(_2f.declaredClass=="esri.layers.GeoRSSLayer"){_30=_2f.getFeatureLayers();if(_2f._hideLayersInLegend){_30=_3.filter(_30,function(_31){return (_3.indexOf(_2f._hideLayersInLegend,_31.id)==-1);});}}}_3.forEach(_30,function(_32){if(_32.declaredClass=="esri.layers.FeatureLayer"&&_2f._titleForLegend){_32._titleForLegend=_2f._titleForLegend+" - ";if(_32.geometryType=="esriGeometryPoint"){_32._titleForLegend+=this.NLS_points;}else{if(_32.geometryType=="esriGeometryPolyline"){_32._titleForLegend+=this.NLS_lines;}else{if(_32.geometryType=="esriGeometryPolygon"){_32._titleForLegend+=this.NLS_polygons;}}}_2e.push(_32);}},this);}else{_2e.push(_2f);}},this);var _33=[];_3.forEach(_2e,function(_34){if(_34.visible===true&&(_34.layerInfos||_34.renderer)){var d=_b.create("div",{id:this.id+"_"+_34.id,style:"display: none;","class":"esriLegendService"});_b.create("span",{innerHTML:this._getServiceTitle(_34),"class":"esriLegendServiceLabel"},_b.create("td",{align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%"},d)))));_b.place(d,this.id,"first");if(_6("ie")){_c.set(_a.byId(this.id+"_"+_34.id),"display","none");}if((_34.legendResponse||_34.renderer)&&!this._dynamicLayerChanged){this._createLegendForLayer(_34);}else{_33.push(this._legendRequest(_34));}this._dynamicLayerChanged=false;}},this);if(_33.length===0){_a.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate();}else{var _35=new _8(_33);_35.addCallback(_2.hitch(this,function(_36){_a.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate();}));}},_createLegendForLayer:function(_37){if(_37.legendResponse||_37.renderer){var _38=false;if(_37.legendResponse){var _39=_37.dynamicLayerInfos||_37.layerInfos;_3.forEach(_39,function(_3a,i){if(!_37._hideLayersInLegend||_3.indexOf(_37._hideLayersInLegend,_3a.id)==-1){var f=this._buildLegendItems(_37,_3a,i);_38=_38||f;}},this);}else{if(_37.renderer){var id;if(!_37.url){id="fc_"+_37.id;}else{id=_37.url.substring(_37.url.lastIndexOf("/")+1,_37.url.length);}var _3b={id:id,name:null,subLayerIds:null,parentLayerId:-1};_38=this._buildLegendItems(_37,_3b,0);}}if(_38){_c.set(_a.byId(this.id+"_"+_37.id),"display","block");_c.set(_a.byId(this.id+"_msg"),"display","none");}}},_legendRequest:function(_3c){if(!_3c.loaded){_4.connect(_3c,"onLoad",_2.hitch(this,"_legendRequest"));return;}if(_3c.version>=10.01){return this._legendRequestServer(_3c);}else{return this._legendRequestTools(_3c);}},_legendRequestServer:function(_3d){var url=_3d.url;var pos=url.indexOf("?");if(pos>-1){url=url.substring(0,pos)+"/legend"+url.substring(pos);}else{url+="/legend";}var _3e=_3d._getToken();if(_3e){url+="?token="+_3e;}var _3f=_2.hitch(this,"_processLegendResponse");var _40={};_40.f="json";if(_3d._params.dynamicLayers){_40.dynamicLayers=_9.stringify(this._createDynamicLayers(_3d));if(_40.dynamicLayers==="[{}]"){_40.dynamicLayers="[]";}}var _41=_12({url:url,content:_40,callbackParamName:"callback",load:function(_42,_43){_3f(_3d,_42,_43);},error:_11.defaults.io.errorHandler});return _41;},_legendRequestTools:function(_44){var p=_44.url.toLowerCase().indexOf("/rest/");var _45=_44.url.substring(0,p)+_44.url.substring(p+5,_44.url.length);var url=this._legendUrl+"?soapUrl="+window.escape(_45);if(!_6("ie")||_6("ie")>8){url+="&returnbytes=true";}var _46=_2.hitch(this,"_processLegendResponse");var _47={};_47.f="json";var _48=_12({url:url,content:_47,callbackParamName:"callback",load:function(_49,_4a){_46(_44,_49,_4a);},error:_11.defaults.io.errorHandler});return _48;},_processLegendResponse:function(_4b,_4c){if(_4c&&_4c.layers){_4b.legendResponse=_4c;_b.empty(_a.byId(this.id+"_"+_4b.id));_b.create("span",{innerHTML:this._getServiceTitle(_4b),"class":"esriLegendServiceLabel"},_b.create("td",{align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%"},_a.byId(this.id+"_"+_4b.id))))));this._createLegendForLayer(_4b);}else{console.log("Legend could not get generated for "+_4b.url+": "+_5.toJson(_4c));}},_buildLegendItems:function(_4d,_4e,pos){var _4f=false;var _50=_a.byId(this.id+"_"+_4d.id);var _51=_4e.subLayerIds;var _52=_4e.parentLayerId;if(_51){var _53=_b.create("div",{id:this.id+"_"+_4d.id+"_"+_4e.id+"_group",style:"display: none;","class":(_52==-1)?((pos>0)?"esriLegendGroupLayer":""):(this.alignRight?"esriLegendRight":"esriLegendLeft")},(_52==-1)?_50:_a.byId(this.id+"_"+_4d.id+"_"+_52+"_group"));if(_6("ie")){_c.set(_a.byId(this.id+"_"+_4d.id+"_"+_4e.id+"_group"),"display","none");}_b.create("td",{innerHTML:_4e.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%","class":"esriLegendLayerLabel"},_53))));}else{if(_4d.visibleLayers&&(","+_4d.visibleLayers+",").indexOf(","+_4e.id+",")==-1){return _4f;}var d=_b.create("div",{id:this.id+"_"+_4d.id+"_"+_4e.id,style:"display:none;","class":(_52>-1)?(this.alignRight?"esriLegendRight":"esriLegendLeft"):""},(_52==-1)?_50:_a.byId(this.id+"_"+_4d.id+"_"+_52+"_group"));if(_6("ie")){_c.set(_a.byId(this.id+"_"+_4d.id+"_"+_4e.id),"display","none");}_b.create("td",{innerHTML:(_4e.name)?_4e.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"):"",align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));if(_4d.legendResponse){_4f=_4f||this._buildLegendItems_Tools(_4d,_4e,d);}else{if(_4d.renderer){_4f=_4f||this._buildLegendItems_Renderer(_4d,_4e,d);}}}return _4f;},_buildLegendItems_Tools:function(_54,_55,_56){var i;var _57=_55.parentLayerId;var _58=_13.getScale(this.map);var _59=false;var _5a=function(_5b,_5c){for(i=0;i<_5b.length;i++){if(_5c.dynamicLayerInfos){for(var k=0;k<_5c.dynamicLayerInfos[k].length;k++){if(_5c.dynamicLayerInfos[k].mapLayerId==_5b[i].layerId){return _5b[i];}}}else{if(_5c.id==_5b[i].layerId){return _5b[i];}}}return {};};if(!this._respectCurrentMapScale||(this._respectCurrentMapScale&&this._isLayerInScale(_54,_55,_58))){var _5d=_5a(_54.legendResponse.layers,_55);var _5e=_5d.legend;if(_5e.length==3&&_5e[0].label.replace(/\s+/g,"").indexOf(":Band_")>-1){}else{var _5f=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_56));_3.forEach(_5e,function(_60){if((_60.url&&_60.url.indexOf("http")===0)||(_60.imageData&&_60.imageData.length>0)){_59=true;this._buildRow_Tools(_60,_5f,_54,_55.id);}},this);}}if(_59){_c.set(_a.byId(this.id+"_"+_54.id+"_"+_55.id),"display","block");if(_57>-1){_c.set(_a.byId(this.id+"_"+_54.id+"_"+_57+"_group"),"display","block");this._findParentGroup(_54.id,_54,_57);}}return _59;},_buildRow_Tools:function(_61,_62,_63,_64){var tr=_b.create("tr",{},_62);var _65;var _66;if(this.alignRight){_65=_b.create("td",{align:"right"},tr);_66=_b.create("td",{align:"right",width:35},tr);}else{_66=_b.create("td",{width:35},tr);_65=_b.create("td",{},tr);}var src=_61.url;if((!_6("ie")||_6("ie")>8)&&_61.imageData&&_61.imageData.length>0){src="data:image/png;base64,"+_61.imageData;}else{if(_61.url.indexOf("http")!==0){src=_63.url+"/"+_64+"/images/"+_61.url;var _67=_63._getToken();if(_67){src+="?token="+_67;}}}var img=_b.create("img",{src:src,border:0,style:"opacity:"+_63.opacity},_66);_b.create("td",{innerHTML:_61.label.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%",dir:"ltr"},_65))));if(_6("ie")<9){img.style.filter="alpha(opacity="+(_63.opacity*100)+")";}},_buildLegendItems_Renderer:function(_68,_69,_6a){var _6b=_69.parentLayerId;var _6c=_13.getScale(this.map);var _6d=false;if(!this._respectCurrentMapScale||this._isLayerInScale(_68,_69,_6c)){var _6e;if(_68.renderer instanceof _15){if(_68.renderer.infos&&_68.renderer.infos.length>0){_6d=true;_6e=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_6a));_3.forEach(_68.renderer.infos,function(_6f,_70){var _71=null;if(_68._editable&&_68.types){_71=this._getTemplateFromTypes(_68.types,_6f.value);}var _72=_6f.label;if(!_72||_72.length===0){_72=_6f.value;}this._buildRow_Renderer(_68,_6f.symbol,_72,_71,_6e);},this);}}if(_68.renderer instanceof _16){if(_68.renderer.infos&&_68.renderer.infos.length>0){_6d=true;_6e=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_6a));_3.forEach(_68.renderer.infos,function(_73,_74){var _75=_73.label;if(!_75||_75.length===0){_75=_73.minValue+" - "+_73.maxValue;}this._buildRow_Renderer(_68,_73.symbol,_75,null,_6e);},this);}}if(_68.renderer instanceof _14){_6d=true;_6e=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_6a));var _76=null;if(_68._editable&&_68.templates&&_68.templates.length>0){_76=_68.templates[0];}this._buildRow_Renderer(_68,_68.renderer.symbol,_68.renderer.label,_76,_6e);}if(!_68._hideDefaultSymbol&&_68.renderer.defaultSymbol){_6d=true;_6e=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_6a));this._buildRow_Renderer(_68,_68.renderer.defaultSymbol,_68.renderer.defaultLabel?_68.renderer.defaultLabel:"others",null,_6e);}}if(_6d){_c.set(_a.byId(this.id+"_"+_68.id+"_"+_69.id),"display","block");if(_6b>-1){_c.set(_a.byId(this.id+"_"+_68.id+"_"+_6b+"_group"),"display","block");this._findParentGroup(_68.id,_6b);}}return _6d;},_buildRow_Renderer:function(_77,_78,_79,_7a,_7b){var tr=_b.create("tr",{},_7b);var _7c;var _7d;if(this.alignRight){_7c=_b.create("td",{align:"right"},tr);_7d=_b.create("td",{align:"right",width:35},tr);}else{_7d=_b.create("td",{width:35},tr);_7c=_b.create("td",{},tr);}var _7e=30;var _7f=30;if(_78.type=="simplemarkersymbol"){_7e=Math.min(Math.max(_7e,_78.size+12),125);_7f=Math.min(Math.max(_7f,_78.size+12),125);}else{if(_78.type=="picturemarkersymbol"){_7e=Math.min(Math.max(_7e,_78.width),125);_7f=Math.min(_78.height?_78.height:_7f,125);}}var div=_b.create("div",{style:"width:"+_7e+"px;height:"+_7f+"px;"},_7d);_b.create("td",{innerHTML:_79?_79.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;").replace(/^#/,""):"",align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%"},_7c))));var _80=this._drawSymbol(div,_78,_7e,_7f,_7a,_77.opacity);this._surfaceItems.push(_80);},_drawSymbol:function(_81,sym,_82,_83,_84,_85){var _86=_17.fromJson(sym.toJson());if(_86.type==="simplelinesymbol"||_86.type==="cartographiclinesymbol"||_86.type==="textsymbol"){if(!_86.color){return;}var _87=_86.color.toRgba();_87[3]=_87[3]*_85;_86.color.setColor(_87);}else{if(_86.type==="simplemarkersymbol"||_86.type==="simplefillsymbol"){if(!_86.color){return;}var _87=_86.color.toRgba();_87[3]=_87[3]*_85;_86.color.setColor(_87);if(_86.outline&&_86.outline.color){_87=_86.outline.color.toRgba();_87[3]=_87[3]*_85;_86.outline.color.setColor(_87);}}else{if(_86.type==="picturemarkersymbol"){_81.style.opacity=_85;_81.style.filter="alpha(opacity=("+_85*100+"))";}}}var _88=_e.createSurface(_81,_82,_83);if(_6("ie")){var _89=_88.getEventSource();_c.set(_89,"position","relative");_c.set(_89.parentNode,"position","relative");}var _8a=this._getDrawingToolShape(_86,_84)||_17.getShapeDescriptors(_86);var _8b;try{_8b=_88.createShape(_8a.defaultShape).setFill(_8a.fill).setStroke(_8a.stroke);}catch(e){_88.clear();_88.destroy();return;}var _8c=_8b.getBoundingBox(),_8d=_8c.width,_8e=_8c.height,_8f=-(_8c.x+(_8d/2)),_90=-(_8c.y+(_8e/2)),dim=_88.getDimensions(),_91={dx:_8f+dim.width/2,dy:_90+dim.height/2};if(_8d>_82||_8e>_83){var _92=_8d>_8e?_8d:_8e;var _93=_82<_83?_82:_83;var _94=(_93-5)/_92;_2.mixin(_91,{xx:_94,yy:_94});}_8b.applyTransform(_91);return _88;},_getDrawingToolShape:function(_95,_96){var _97,_98=_96?_96.drawingTool||null:null;switch(_98){case "esriFeatureEditToolArrow":_97={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolTriangle":_97={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":_97={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":_97={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":_97={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null;}return {defaultShape:_97,fill:_95.getFill(),stroke:_95.getStroke()};},_repaintItems:function(){_3.forEach(this._surfaceItems,function(_99){this._repaint(_99);},this);},_repaint:function(_9a){if(!_9a){return;}if(_9a.getStroke&&_9a.setStroke){_9a.setStroke(_9a.getStroke());}try{if(_9a.getFill&&_9a.setFill){_9a.setFill(_9a.getFill());}}catch(e){}if(_9a.children&&_2.isArray(_9a.children)){_3.forEach(_9a.children,this._repaint,this);}},_createDynamicLayers:function(_9b){var _9c=[],_9d;var _9e=_9b.dynamicLayerInfos||_9b.layerInfos;dojo.forEach(_9e,function(_9f){var _a0={id:_9f.id};_a0.source=_9f.source&&_9f.source.toJson();var _a1;if(_9b.layerDefinitions&&_9b.layerDefinitions[_9f.id]){_a1=_9b.layerDefinitions[_9f.id];}if(_a1){_a0.definitionExpression=_a1;}var _a2;if(_9b.layerDrawingOptions&&_9b.layerDrawingOptions[_9f.id]){_a2=_9b.layerDrawingOptions[_9f.id];}if(_a2){_a0.drawingInfo=_a2.toJson();}_a0.minScale=_9f.minScale||0;_a0.maxScale=_9f.maxScale||0;_9c.push(_a0);});return _9c;},_getTemplateFromTypes:function(_a3,_a4){var i;for(i=0;i<_a3.length;i++){if(_a3[i].id==_a4&&_a3[i].templates&&_a3[i].templates.length>0){return _a3[i].templates[0];}}return null;},_findParentGroup:function(_a5,_a6,_a7){var k;var _a8=_a6.dynamicLayerInfos||_a6.layerInfos;for(k=0;k<_a8.length;k++){if(_a7==_a8[k].id){if(_a8[k].parentLayerId>-1){_c.set(_a.byId(this.id+"_"+_a5+"_"+_a8[k].parentLayerId+"_group"),"display","block");this._findParentGroup(_a5,_a6,_a8[k].parentLayerId);}break;}}},_addSubLayersToHide:function(_a9){var i;if(!_a9.layer.layerInfos){return;}function _aa(id,_ab){var _ac=_a9.layer.dynamicLayerInfos||_a9.layer.layerInfos;for(var i=0;i<_ac.length;i++){if(_ac[i].id===id&&_ac[i].subLayerIds){for(var k=0;k<_ac[i].subLayerIds.length;k++){var _ad=_ac[i].subLayerIds[k];if(_3.indexOf(_ab,_ad)===-1){_ab.push(_ad);_aa(_ad,_ab);}}}}};_3.forEach(_a9.layer._hideLayersInLegend,function(_ae){_aa(_ae,_a9.layer._hideLayersInLegend);});},_isLayerInScale:function(_af,_b0,_b1){var i;var _b2=true;if(_af.legendResponse&&_af.legendResponse.layers){for(i=0;i<_af.legendResponse.layers.length;i++){var _b3=_af.legendResponse.layers[i];if(_b0.id==_b3.layerId){var _b4,_b5;if((!_af.minScale&&_af.minScale!==0)||(!_af.maxScale&&_af.maxScale!==0)){if(_b3.minScale==0&&_af.tileInfo){_b4=_af.tileInfo.lods[0].scale;}if(_b3.maxScale==0&&_af.tileInfo){_b5=_af.tileInfo.lods[_af.tileInfo.lods.length-1].scale;}}else{_b4=Math.min(_af.minScale,_b3.minScale)||_af.minScale||_b3.minScale;_b5=Math.max(_af.maxScale,_b3.maxScale);}if((_b4>0&&_b4<_b1)||_b5>_b1){_b2=false;}break;}}}else{if(_af.minScale||_af.maxScale){if((_af.minScale&&_af.minScale<_b1)||_af.maxScale&&_af.maxScale>_b1){_b2=false;}}}return _b2;},_getServiceTitle:function(_b6){var _b7=_b6._titleForLegend;if(!_b7){_b7=_b6.url;if(!_b6.url){_b7="";}else{if(_b6.url.indexOf("/MapServer")>-1){_b7=_b6.url.substring(0,_b6.url.indexOf("/MapServer"));_b7=_b7.substring(_b7.lastIndexOf("/")+1,_b7.length);}else{if(_b6.url.indexOf("/ImageServer")>-1){_b7=_b6.url.substring(0,_b6.url.indexOf("/ImageServer"));_b7=_b7.substring(_b7.lastIndexOf("/")+1,_b7.length);}else{if(_b6.url.indexOf("/FeatureServer")>-1){_b7=_b6.url.substring(0,_b6.url.indexOf("/FeatureServer"));_b7=_b7.substring(_b7.lastIndexOf("/")+1,_b7.length);}}}}if(_b6.name){if(_b7.length>0){_b7+=" - "+_b6.name;}else{_b7=_b6.name;}}}return _f.encode(_b7);},_isSupportedLayerType:function(_b8){if(_b8&&(_b8.declaredClass==="esri.layers.ArcGISDynamicMapServiceLayer"||_b8.declaredClass==="esri.layers.ArcGISTiledMapServiceLayer"||_b8.declaredClass==="esri.layers.FeatureLayer"||_b8.declaredClass==="esri.layers.KMLLayer"||_b8.declaredClass==="esri.layers.GeoRSSLayer")){return true;}return false;}});_2.mixin(_19,{ALIGN_LEFT:0,ALIGN_RIGHT:1});if(_6("extend-esri")){_2.setObject("dijit.Legend",_19,_10);}return _19;});