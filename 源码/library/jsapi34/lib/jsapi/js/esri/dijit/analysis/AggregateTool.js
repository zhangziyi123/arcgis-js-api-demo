/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/analysis/AggregateTool",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dijit/form/Form,dijit/form/Select,dijit/form/ComboBox,dijit/form/CheckBox,dijit/Menu,dijit/MenuItem,esri/dijit/analysis/HelpWindow,esri/dijit/analysis/utils,esri/dijit/analysis/HelpWindow,esri/dijit/analysis/AnalysisBase"],function(_1,_2,_3){_2.provide("esri.dijit.analysis.AggregateTool");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.require("dijit.form.Form");_2.require("dijit.form.Select");_2.require("dijit.form.ComboBox");_2.require("dijit.form.CheckBox");_2.require("dijit.Menu");_2.require("dijit.MenuItem");_2.require("esri.dijit.analysis.HelpWindow");_2.require("esri.dijit.analysis.utils");_2.require("esri.dijit.analysis.HelpWindow");_2.require("esri.dijit.analysis.AnalysisBase");_2.declare("esri.dijit.analysis.AggregateTool",[_1._Widget,_1._Templated,esri.dijit.analysis.AnalysisBase],{widgetsInTemplate:true,templateString:"<div class=\"esriAnalysis\">\r\n    <div data-dojo-type=\"dijit.layout.ContentPane\" style=\"margin-top:0.5em; margin-bottom: 0.5em;\">\r\n      <div data-dojo-attach-point=\"_aggregateToolContentTitle\" class=\"analysisTitle\">\r\n        <table class=\"esriFormTable\" > \r\n          <tr>\r\n            <td><div class=\"aggregateIcon\"></div></td>\r\n            <td>${i18n.aggregateToolName}</td>\r\n            <td>\r\n              <div class=\"esriFloatTrailing\" style=\"padding:0;\">\r\n                  <a href=\"#\" class='esriFloatLeading helpIcon' esriHelpTopic=\"toolDescription\"></a>\r\n                  <a href=\"#\" data-dojo-attach-point=\"_closeBtn\" title=\"${i18n.close}\" class=\"closeIcon\">              \r\n                  <img src=\"images/close.gif\" border=\"0\"/></a>            \r\n              </div>                \r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </div>\r\n      <div style=\"clear:both; border-bottom: #333 thin solid; height:1px;width:100%;\"></div>\r\n    </div>\r\n    <div data-dojo-type=\"dijit.form.Form\" data-dojo-attach-point=\"_form\" readOnly=\"true\">\r\n       <table class=\"esriFormTable\"  data-dojo-attach-point=\"_aggregateTable\"  style=\"border-collapse:collapse;border-spacing:5px;\" cellpadding=\"5px\" cellspacing=\"5px\"> \r\n         <tbody>\r\n          <tr>\r\n            <td  colspan=\"3\" class=\"sectionHeader\" data-dojo-attach-point=\"_aggregateToolDescription\" >${i18n.aggregateDefine}</td>\r\n          </tr>      \r\n          <tr>\r\n            <td colspan=\"2\">\r\n              <label class=\"esriFloatLeading esriTrailingMargin025\">${i18n.oneLabel}</label>\r\n              <label class=\"\">${i18n.chooseAreaLabel}</label>\r\n              <select class=\"longInput esriLongLabel\"  data-dojo-type=\"dijit.form.Select\" data-dojo-attach-point=\"_layersSelect\" data-dojo-attach-event=\"onChange:_handleLayerChange\"></select>\r\n            </td>\r\n            <td class=\"shortTextInput\">\r\n              <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"PolygonLayer\"></a> \r\n            </td>             \r\n          </tr>\r\n          <tr>\r\n         <tr>\r\n           <td colspan=\"3\">\r\n              <div data-dojo-type=\"dijit.form.CheckBox\" data-dojo-attach-point=\"_keepPolygonsCheck\" data-dojo-props=\"checked:'true'\"></div>\r\n              <label>${i18n.keepPolygonLabel}</label>\r\n              <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"KeepBoundaryNoPoints\"></a>\r\n           </td>\r\n          </tr>    \r\n          <tr>\r\n            <td colspan=\"3\" class=\"clear\"></td>\r\n          </tr>\r\n          <tr>\r\n            <td colspan=\"2\">\r\n              <label class=\"esriFloatLeading esriTrailingMargin025\">${i18n.twoLabel}</label>\r\n              <label class=\"longTextInput\">${i18n.addStatsLabel}</label>\r\n            </td>\r\n            <td class=\"shortTextInput\">\r\n              <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"SummaryFields\"></a> \r\n            </td>             \r\n          </tr>\r\n          <tr data-dojo-attach-point=\"_afterStatsRow\">\r\n            <td colspan=\"3\" class=\"clear\"></td>\r\n          </tr>\r\n          <!--\r\n          <tr>\r\n            <td colspan=\"2\">\r\n              <label class=\"esriFloatLeading esriTrailingMargin025\">${i18n.threeLabel}</label>\r\n              <label class=\"longTextInput\"  data-dojo-attach-point=\"_groupByLabel\">${i18n.groupByLabel}</label>\r\n            </td>\r\n            <td class=\"shortTextInput\">\r\n              <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"GroupByField\"></a> \r\n            </td>             \r\n          </tr>\r\n          <tr>\r\n            <td colspan=\"3\">\r\n              <select class=\"longInput\" data-dojo-type=\"dijit.form.Select\"  data-dojo-props=\"disabled:true\" data-dojo-attach-point=\"_groupBySelect\"></select>\r\n            </td>                \r\n          </tr>         \r\n          <tr>\r\n            <td colspan=\"3\" class=\"clear\"></td>\r\n          </tr> -->\r\n          <tr>\r\n            <td colspan=\"2\">\r\n              <label class=\"esriFloatLeading esriTrailingMargin025\">${i18n.fourLabel}</label>\r\n              <label class=\"longTextInput\">${i18n.outputLayerLabel}</label>\r\n            </td>\r\n            <td class=\"shortTextInput\">\r\n              <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"OutputLayer\"></a> \r\n            </td>             \r\n          </tr>\r\n          <tr>\r\n            <td colspan=\"3\">\r\n              <input type=\"text\" data-dojo-type=\"dijit.form.TextBox\" class=\"longInput\" data-dojo-attach-point=\"_outputLayerInput\" value=\"\"></input>\r\n            </td>                \r\n          </tr>                             \r\n        </tbody>         \r\n       </table>\r\n     </div>\r\n    <div id=\"aggregateToolContentButtons\" style=\"padding:5px;margin-top:5px;border-top:solid 1px #BBB;\">\r\n        <button data-dojo-type=\"dijit.form.Button\" type=\"submit\" data-dojo-attach-point=\"_saveBtn\" class=\"esriLeadingMargin4\" data-dojo-attach-event=\"onClick:_handleSaveBtnClick\">\r\n            ${i18n.runAnalysis}\r\n        </button>\r\n    </div>\r\n</div>\r\n",pointLayer:null,polygonLayers:null,summaryFields:null,outputLayerName:null,keepBoundariesWithNoPoints:true,polygonLayer:null,groupByField:null,i18n:null,toolName:"AggregatePoints",helpFileName:"AggregatePoints",resultParameter:"AggregatedLayer",constructor:function(_4,_5){this.inherited(arguments);this._pbConnects=[];if(_4.containerNode){this.container=_4.containerNode;}},destroy:function(){this.inherited(arguments);_2.forEach(this._pbConnects,_2.disconnect);delete this._pbConnects;},postMixInProperties:function(){this.inherited(arguments);this.i18n={};_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").common);_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").analysisTools);_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").aggregatePointsTool);},postCreate:function(){this.inherited(arguments);_2.addClass(this._form.domNode,"esriSimpleForm");this._buildUI();},startup:function(){},_onClose:function(_6){if(_6){this._save();this.onSave();}this.onClose();},_handleSaveBtnClick:function(e){this._saveBtn.set("disabled",true);var _7={},_8={};var _9=this.polygonLayers[this._layersSelect.get("value")];if(_9.url){var _a={url:_9.url};if(_9.getDefinitionExpression()){_a.filter=_9.getDefinitionExpression();}_7.PolygonLayer=_2.toJson(_a);}else{if(!_9.url){var _b={};var _c=_9.toJson();_b.featureCollection=_c.layerDefinition;_b.featureCollection.features=_c.featureSet.features;_7.PolygonLayer=_2.toJson(_b);}}if(this.pointLayer.url){var _d={url:this.pointLayer.url};if(this.pointLayer.getDefinitionExpression()){_d.filter=this.pointLayer.getDefinitionExpression();}_7.PointLayer=_2.toJson(_d);}else{if(!this.pointLayer.url){var _b={};var _c=this.pointLayer.toJson();_b.featureCollection=_c.layerDefinition;_b.featureCollection.features=_c.featureSet.features;_7.PointLayer=_2.toJson(_b);}}_7.SummaryFields=_2.toJson(this.get("aggregateFields"));_7.OutputName=_2.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}});_7.KeepBoundariesWithNoPoints=this._keepPolygonsCheck.get("checked");_8.jobParams=_7;_8.itemParams={"description":_2.string.substitute(this.i18n.itemDescription,{pointlayername:this.pointLayer.name,polygonlayername:_9.name}),"tags":_2.string.substitute(this.i18n.itemTags,{pointlayername:this.pointLayer.name,polygonlayername:_9.name}),"snippet":this.i18n.itemSnippet};this.execute(_8);},_handleLayerChange:function(_e){},_handleAttrSelectChange:function(_f){if(_f!=="0"){statsSelect=this.get("statisticSelect");if(statsSelect.get("value")!=="0"){if(!statsSelect.get("isnewRowAdded")){removeTd=statsSelect.get("removeTd");_2.style(removeTd,"display","block");var obj=statsSelect.get("referenceWidget");_2.hitch(obj,obj._createStatsRow());statsSelect.set("isnewRowAdded",true);}}}},_handleStatsValueUpdate:function(_10,_11,_12){var _13,_14;if(!this.get("attributeSelect")){return;}_13=this.get("attributeSelect");if(_13.get("value")!=="0"&&_12!=="0"){if(!this.get("isnewRowAdded")){_14=this.get("removeTd");_2.style(_14,"display","block");var obj=this.get("referenceWidget");_2.hitch(obj,obj._createStatsRow());this.set("isnewRowAdded",true);}}},_save:function(){},_buildUI:function(){this._loadConnections();esri.dijit.analysis.utils.initHelpLinks(this.domNode);if(this.pointLayer){_2.attr(this._aggregateToolDescription,"innerHTML",_2.string.substitute(this.i18n.aggregateDefine,{layername:this.pointLayer.name}));}if(this.polygonLayers){_2.forEach(this.polygonLayers,function(_15,_16){if(_15.geometryType==="esriGeometryPolygon"){this._layersSelect.addOption({value:_16,label:_15.name});if(_16===0&&!this.outputLayerName){this.outputLayerName=_2.string.substitute(this.i18n.outputLayerName,{pointlayername:this.pointLayer.name,polygonlayername:_15.name});}}},this);}if(this.outputLayerName){this._outputLayerInput.set("value",this.outputLayerName);}this._keepPolygonsCheck.set("checked",this.keepBoundariesWithNoPoints);if(this.polygonLayer){this._layersSelect.set();}this._createStatsRow();_2.forEach(this.aggregateFields,function(_17){var _18=_17.split(" ");this._currentAttrSelect.set("value",_18[0]);_2.hitch(this._currentAttrSelect,this._handleAttrSelectChange,_18[0])();this._currentStatsSelect.set("value",_18[1]);_2.hitch(this._currentStatsSelect,this._handleStatsValueUpdat,"value","",_18[1])();},this);},_loadConnections:function(){this._connect(this,"onExecute",_2.hitch(this,"_onClose",false));this._connect(this._closeBtn,"onclick",_2.hitch(this,"_onClose",false));},_createStatsRow:function(_19){var _1a,_1b,_1c,_1d,_1e,_1f,_20;_1a=_2.create("tr",null,this._afterStatsRow,"before");_1c=_2.create("td",{style:{width:"49%",maxWidth:"100px"}},_1a);_1b=_2.create("td",{style:{width:"50%",maxWidth:"104px"}},_1a);_1d=new _1.form.Select({"class":"mediumInput esriTrailingMargin025 attrSelect",style:{tableLayout:"fixed",overflowX:"hidden"}},_2.create("select",null,_1c));this.set("attributes",{selectWidget:_1d,pointLayer:this.pointLayer});_1e=new _1.form.Select({"class":"mediumInput statsSelect",style:{tableLayout:"fixed",overflowX:"hidden"}},_2.create("select",null,_1b));this.set("statistics",{selectWidget:_1e});_1d.set("statisticSelect",_1e);_2.connect(_1d,"onChange",this._handleAttrSelectChange);_20=_2.create("td",{"class":"shortTextInput removeTd",style:{"display":"none",maxWidth:"12px"}},_1a);_1f=_2.create("a",{"title":this.i18n.removeAttrStats,"class":"closeIcon statsRemove","innerHTML":"<img src='images/close.gif' border='0''/>"},_20);_2.connect(_1f,"onclick",_2.hitch(this,this._removeStatsRow,_1a));_1e.set("attributeSelect",_1d);_1e.set("removeTd",_20);_1e.set("isnewRowAdded",false);_1e.set("referenceWidget",this);_1e.watch("value",this._handleStatsValueUpdate);this._currentStatsSelect=_1e;this._currentAttrSelect=_1d;return true;},_removeStatsRow:function(row){_2.forEach(_1.findWidgets(row),function(w){w.destroyRecursive();});_2.destroy(row);},_setAnalysisGpServerAttr:function(url){this.analysisGpServer=url;this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);},_setPointLayerAttr:function(_21){if(_21.geometryType==="esriGeometryPoint"){this.pointLayer=_21;}else{}},_setPolygonLayersAttr:function(_22){this.polygonLayers=_22;},_setLayersAttr:function(_23){this.polygonLayers=[];_2.forEach(_23,function(_24,_25){if(_24.geometryType==="esriGeometryPolygon"){this.polygonLayers.push(_24);}else{if(_24.geometryType==="esriGeometryPoint"){this.pointLayer=_24;}}},this);},_setAttributesAttr:function(_26){if(!_26.pointLayer){return;}var _27=_26.pointLayer;var _28=_26.selectWidget;var _29=_27.fields;_28.addOption({value:"0",label:this.i18n.attribute});_2.forEach(_29,function(_2a,_2b){if(_2.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],_2a.type)!==-1){_28.addOption({value:_2a.name,label:_2a.name});}},this);},_setStatisticsAttr:function(_2c){var _2d=_2c.selectWidget;_2d.addOption({value:"0",label:this.i18n.statistic});_2d.addOption({value:"SUM",label:this.i18n.sum});_2d.addOption({value:"MIN",label:this.i18n.minimum});_2d.addOption({value:"MAX",label:this.i18n.maximum});_2d.addOption({value:"MEAN",label:this.i18n.average});_2d.addOption({value:"STDDEV",label:this.i18n.standardDev});},_setAggregateFieldsAttr:function(_2e){this.aggregateFields=_2e;},_getAggregateFieldsAttr:function(){var _2f="";var _30=[];_2.query(".statsSelect",this.domNode).forEach(function(_31,_32){var _33=_1.byNode(_31);var _34=_33.get("attributeSelect");if(_34.get("value")!=="0"&&_33.get("value")!=="0"){_2f+=_34.get("value")+" "+_33.get("value")+";";_30.push(_34.get("value")+" "+_33.get("value"));}});return _30;},_setDisableRunAnalysisAttr:function(_35){this._saveBtn.set("disabled",_35);},_connect:function(_36,evt,_37){this._pbConnects.push(_2.connect(_36,evt,_37));},onSave:function(){},onClose:function(){}});});