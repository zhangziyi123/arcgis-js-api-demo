/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/analysis/OverlayLayers",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dijit/form/Form,dijit/form/Select,dijit/form/ComboBox,dijit/form/CheckBox,dijit/form/Button,esri/dijit/analysis/GroupToggleButton,dijit/Menu,dijit/MenuItem,esri/dijit/analysis/HelpWindow,esri/dijit/analysis/utils,esri/dijit/analysis/HelpWindow,esri/dijit/analysis/AnalysisBase,esri/dijit/analysis/AnalysisToggleButton,dojo/fx/easing"],function(_1,_2,_3){_2.provide("esri.dijit.analysis.OverlayLayers");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.require("dijit.form.Form");_2.require("dijit.form.Select");_2.require("dijit.form.ComboBox");_2.require("dijit.form.CheckBox");_2.require("dijit.form.Button");_2.require("esri.dijit.analysis.GroupToggleButton");_2.require("dijit.Menu");_2.require("dijit.MenuItem");_2.require("esri.dijit.analysis.HelpWindow");_2.require("esri.dijit.analysis.utils");_2.require("esri.dijit.analysis.HelpWindow");_2.require("esri.dijit.analysis.AnalysisBase");_2.require("esri.dijit.analysis.AnalysisToggleButton");_2.require("dojo.fx.easing");_2.declare("esri.dijit.analysis.OverlayLayers",[_1._Widget,_1._Templated,esri.dijit.analysis.AnalysisBase],{widgetsInTemplate:true,templateString:"<div class=\"esriAnalysis\">\r\n  <div data-dojo-type=\"dijit.layout.ContentPane\" style=\"margin-top:0.5em; margin-bottom: 0.5em;\">\r\n    <div data-dojo-attach-point=\"_overlaylayersToolContentTitle\" class=\"analysisTitle\">\r\n         <table class=\"esriFormTable\" > \r\n            <tr>\r\n              <td><div class=\"overlayLayersIcon\"></div></td>\r\n              <td>${i18n.overlayLayers}</td>\r\n              <td>\r\n                <div class=\"esriFloatTrailing\" style=\"padding:0;\">\r\n                  <a href=\"#\" class='esriFloatLeading helpIcon' esriHelpTopic=\"toolDescription\"></a>\r\n                  <a href=\"#\" data-dojo-attach-point=\"_closeBtn\" title=\"${i18n.close}\" class=\"closeIcon\">              \r\n                  <img src=\"images/close.gif\" border=\"0\"/></a>            \r\n                </div>\r\n              </td>\r\n            </tr>\r\n         </table>\r\n    </div>\r\n    <div style=\"clear:both; border-bottom: #333 thin solid; height:1px;width:100%;\"></div>\r\n  </div>\r\n  <div data-dojo-type=\"dijit.form.Form\" data-dojo-attach-point=\"_form\" readOnly=\"true\">\r\n     <table class=\"esriFormTable\"  data-dojo-attach-point=\"_overlaylayersTable\"> \r\n       <tbody>\r\n        <tr>\r\n          <td  colspan=\"3\" class=\"sectionHeader\" data-dojo-attach-point=\"_overlaylayersToolDescription\"></td>\r\n        </tr>\r\n        <tr>\r\n          <td colspan=\"2\">\r\n            <label data-dojo-attach-point=\"_labelOne\" class=\"esriFloatLeading esriTrailingMargin025\">${i18n.oneLabel}</label>\r\n            <label data-dojo-attach-point=\"_polylabel\" class=\"\">${i18n.chooseOverlayLayer}</label>\r\n            <select class=\"esriLeadingMargin05  longInput\"  style=\"width:125%;margin-top:10px;table-layout:fixed;\" data-dojo-type=\"dijit.form.Select\" data-dojo-attach-point=\"_overlayFeaturesSelect\" data-dojo-attach-event=\"onChange:_handleLayerChange\"></select>\r\n          </td>\r\n          <td class=\"shortTextInput\" width=\"1%\">\r\n            <a href=\"#\" class='esriFloatTrailing helpIcon' data-dojo-attach-point=\"_analysisFieldHelpLink\" esriHelpTopic=\"OverlayLayer\"></a> \r\n          </td> \r\n        </tr>\r\n        <tr>\r\n          <td width=\"99%\" colspan=\"2\" style=\"white-space:nowrap;\">\r\n            <label class=\"esriFloatLeading esriTrailingMargin025\">${i18n.twoLabel}</label>\r\n            <label class=\"longTextInput\">${i18n.chooseOverlayMethod}</label>\r\n          </td>\r\n          <td>\r\n            <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"OverlayType\"></a> \r\n          </td>          \r\n        </tr>  \r\n        <tr>\r\n          <td style=\"width:33%\" align='center'>\r\n            <div class=\"esriContainerSelector\" data-dojo-props=\"groupName:'overlayType',checked:true\" data-dojo-type=\"esri.dijit.analysis.AnalysisToggleButton\" data-dojo-attach-point=\"_intersectBtnCtr\" style=\"width:100%\" data-dojo-attach-event=\"onClick:_handleIntersectBtnCtrClick\" >\r\n              <div data-dojo-type=\"esri.dijit.analysis.GroupToggleButton\" class=\"\" data-dojo-attach-event=\"onClick:_handleIntersectBtnClick\" data-dojo-attach-point=\"_intersectBtn\" data-dojo-props=\"groupName:'overlayType',showLabel:false,iconClass:'intersectLayersIcon',checked:true, style:'width:36px;height:36px;',label:'intersect'\"></div>\r\n              <div><label>${i18n.intersect}</label></div>\r\n            </div>\r\n          </td>\r\n          <td style=\"width:33%\" align='center'>  \r\n            <div class=\"esriContainerSelector\" data-dojo-props=\"groupName:'overlayType'\"  data-dojo-type=\"esri.dijit.analysis.AnalysisToggleButton\" data-dojo-attach-point=\"_unionBtnCtr\" style=\"width:100%\" data-dojo-attach-event=\"onClick:_handleUnionBtnCtrClick\">          \r\n            <div data-dojo-type=\"esri.dijit.analysis.GroupToggleButton\" class=\"\" data-dojo-attach-event=\"onClick:_handleUnionBtnClick\" data-dojo-attach-point=\"_unionBtn\" data-dojo-props=\"groupName:'overlayType',showLabel:false,iconClass:'unionLayersIcon' ,   style:'width:36px;height:36px;',label:'union'\"></div>\r\n              <div><label>${i18n.union}</label></div>\r\n            </div>\r\n          </td>\r\n          <td style=\"width:33%\" align='center'>\r\n            <div class=\"esriContainerSelector\" data-dojo-props=\"groupName:'overlayType'\"  data-dojo-type=\"esri.dijit.analysis.AnalysisToggleButton\" style=\"width:100%\" data-dojo-attach-point=\"_eraseBtnCtr\" data-dojo-attach-event=\"onClick:_handleEraseBtnCtrClick\">\r\n              <div  data-dojo-type=\"esri.dijit.analysis.GroupToggleButton\" class=\"\" data-dojo-attach-event=\"onClick:_handleEraseBtnClick\" data-dojo-attach-point=\"_eraseBtn\" data-dojo-props=\"groupName:'overlayType',showLabel:false,iconClass:'eraseLayersIcon',   style:'width:36px;height:36px;',label:'erase'\"></div>\r\n              <div><label>${i18n.erase}</label></div>\r\n            </div>\r\n          </td>\r\n        </tr>               \r\n        <tr>\r\n          <td colspan=\"2\">\r\n            <label class=\"esriFloatLeading esriTrailingMargin025\">${i18n.threeLabel}</label>\r\n            <label class=\"longTextInput\">${i18n.outputLayerLabel}</label>\r\n          </td>\r\n          <td class=\"shortTextInput\">\r\n            <a href=\"#\" class='esriFloatTrailing helpIcon' esriHelpTopic=\"OutputLayer\"></a> \r\n          </td>             \r\n        </tr>\r\n        <tr>\r\n          <td colspan=\"3\">\r\n            <input type=\"text\" data-dojo-type=\"dijit.form.TextBox\" class=\"longTextInput esriLeadingMargin05\" data-dojo-attach-point=\"_outputLayerInput\"></input>\r\n          </td>                \r\n        </tr>                             \r\n      </tbody>         \r\n     </table>\r\n   </div>\r\n  <div id=\"overlaylayersToolContentButtons\" style=\"padding:5px;margin-top:5px;border-top:solid 1px #BBB;\">\r\n    <button data-dojo-type=\"dijit.form.Button\" type=\"submit\" data-dojo-attach-point=\"_saveBtn\" class=\"esriLeadingMargin4\" data-dojo-attach-event=\"onClick:_handleSaveBtnClick\">\r\n        ${i18n.runAnalysis}\r\n    </button>\r\n  </div>\r\n  <div class=\"esriFormWarning esriRoundedBox\" dojoAttachPoint=\"_errorMessagePane\" style=\"display:none;\">\r\n    <a href=\"#\" title=\"${i18n.close}\" class=\"esriFloatTrailing closeIcon\" title='${i18n.close}' data-dojo-attach-event=\"onclick:_handleCloseMsg\">\r\n      <img src='images/close.gif' border='0'/> \r\n    </a>\r\n    <span dojoAttachPoint=\"_bodyNode\"></span>\r\n  </div>\r\n</div>\r\n",inputFeatures:null,overlayFeatures:null,overlayType:"intersect",tolerance:null,snapToInputFeatures:false,outputLayerName:null,i18n:null,toolName:"OverlayLayers",helpFileName:"OverlayLayers",resultParameter:"Outputlayer",constructor:function(_4,_5){this.inherited(arguments);this._pbConnects=[];if(_4.containerNode){this.container=_4.containerNode;}this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);},destroy:function(){this.inherited(arguments);_2.forEach(this._pbConnects,_2.disconnect);delete this._pbConnects;},postMixInProperties:function(){this.inherited(arguments);this.i18n={};_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").common);_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").analysisTools);_2.mixin(this.i18n,_2.i18n.getLocalization("esri","jsapi").overlayLayersTool);},postCreate:function(){this.inherited(arguments);_2.addClass(this._form.domNode,"esriSimpleForm");this._buildUI();},startup:function(){},_onClose:function(_6){if(_6){this._save();this.onSave();}this.onClose();},_handleSaveBtnClick:function(e){this._saveBtn.set("disabled",true);var _7={},_8={};if(this.inputFeatures.url){var _9={url:this.inputFeatures.url};if(this.inputFeatures.getDefinitionExpression()){_9.filter=this.inputFeatures.getDefinitionExpression();}_7.InputLayer=_2.toJson(_9);}else{if(!this.inputFeatures.url){var _a={};var _b=this.inputFeatures.toJson();_a.featureCollection=_b.layerDefinition;_a.featureCollection.features=_b.featureSet.features;_7.InputLayer=_2.toJson(_a);}}if(this._overlayFeaturesSelect.get("value")!=="0"){var _c=this.overlayFeatures[this._overlayFeaturesSelect.get("value")-1];if(_c.url){var _d={url:_c.url};if(_c.getDefinitionExpression()){_d.filter=_c.getDefinitionExpression();}_7.OverlayLayer=_2.toJson(_d);}else{if(!_c.url){var _a={};var _b=_c.toJson();_a.featureCollection=_b.layerDefinition;_a.featureCollection.features=_b.featureSet.features;_7.OverlayLayer=_2.toJson(_a);}}}_7.OverlayType=this.get("overlayType");_7.OutputName=_2.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}});_7.Tolerance=0;_7.SnapToInput=false;_8.jobParams=_7;_8.itemParams={"description":this.i18n.itemDescription,"tags":_2.string.substitute(this.i18n.itemTags,{layername:this.inputFeatures.name}),"snippet":this.i18n.itemSnippet};this.execute(_8);},_save:function(){},_sortbyGeometryType:function(a,b){if(a.geometryType==="esriGeometryPolygon"){return -1;}else{if(b.geometryType==="esriGeometryPolygon"){return 1;}else{if(a.geometryType==="esriGeometryPolyline"){return -1;}else{if(b.geometryType==="esriGeometryPolyline"){return 1;}else{if(a.geometryType==="esriGeometryPoint"){return -1;}else{if(b.geometryType==="esriGeometryPoint"){return 1;}}}}}}},_buildUI:function(){this._loadConnections();esri.dijit.analysis.utils.initHelpLinks(this.domNode);if(this.inputFeatures){console.log(this.inputFeatures.name);_2.attr(this._overlaylayersToolDescription,"innerHTML",_2.string.substitute(this.i18n.overlayDefine,{layername:this.inputFeatures.name}));}if(this.overlayFeatures){this.overlayFeatures=_2.filter(this.overlayFeatures,function(_e){if(this.inputFeatures!==_e&&(this.inputFeatures.geometryType==="esriGeometryPolygon"||this.inputFeatures.geometryType==="esriGeometryPoint"||this.inputFeatures.geometryType==="esriGeometryPolyline")){return true;}},this);console.log("Before",this.overlayFeatures);this.overlayFeatures.sort(_2.hitch(this,this._sortbyGeometryType));console.log("After",this.overlayFeatures);this._selectedIndex=1;_2.forEach(this.overlayFeatures,function(_f,_10){this._overlayFeaturesSelect.addOption({value:_10+1,label:_f.name});},this);this._handleLayerChange(1);}if(this.overlayType){if(this.overlayType==="intersect"){this._intersectBtn.set("checked",true);this._handleIntersectBtnClick();}else{if(this.overlayType==="union"){this._unionBtn.set("checked",true);this._handleUnionBtnClick();}else{if(this.overlayType==="erase"){this._eraseBtn.set("checked",true);this._handleEraseBtnClick();}}}}if(this.outputLayerName){this._outputLayerInput.set("value",this.outputLayerName);}},_loadConnections:function(){this._connect(this,"onExecute",_2.hitch(this,"_onClose",false));this._connect(this._closeBtn,"onclick",_2.hitch(this,"_onClose",false));},_handleLayerChange:function(_11){var _12,_13,_14;_12=this.overlayFeatures[_11-1];_13=false;_14=(this.inputFeatures.geometryType!=="esriGeometryPolygon"||_12.geometryType!=="esriGeometryPolygon");if(_12){this._unionBtn.set("disabled",_14);this._unionBtn.set("iconClass",_14?"unionLayersDisabledIcon":"unionLayersIcon");if(this.inputFeatures.geometryType==="esriGeometryPolygon"){_13=(this.inputFeatures.geometryType==="esriGeometryPolygon"&&_12.geometryType!=="esriGeometryPolygon");}else{if(this.inputFeatures.geometryType==="esriGeometryPolyline"){_13=(this.inputFeatures.geometryType==="esriGeometryPolyline"&&_12.geometryType==="esriGeometryPoint");}else{if(this.inputFeatures.geometryType==="esriGeometryPolyline"){_13=true;}}}this._eraseBtn.set("disabled",_13);this._eraseBtn.set("iconClass",_13?"eraseLayersDisabledIcon":"eraseLayersIcon");if(this.get("overlayType")==="union"&&(this.inputFeatures.geometryType!=="esriGeometryPolygon"||_12.geometryType!=="esriGeometryPolygon")){this._showMessages(this.i18n.overlayLayerPolyMsg);this._intersectBtn.set("checked",true);this._handleIntersectBtnCtrClick();}else{if(this.get("overlayType")==="erase"&&(this.inputFeatures.geometryType==="esriGeometryPolyline"&&_12.geometryType==="esriGeometryPoint")){this._showMessages(this.i18n.notSupportedEraseOverlayMsg);this._intersectBtn.set("checked",true);this._handleIntersectBtnCtrClick();}else{if(this.get("overlayType")==="erase"&&(this.inputFeatures.geometryType==="esriGeometryPolygon"&&_12.geometryType!=="esriGeometryPolygon")){this._showMessages(this.i18n.notSupportedEraseOverlayMsg);this._intersectBtn.set("checked",true);this._handleIntersectBtnCtrClick();}}}}},_showMessages:function(msg){_2.attr(this._bodyNode,"innerHTML",msg);_2.fadeIn({node:this._errorMessagePane,easing:_2.fx.easing.quadIn,onEnd:_2.hitch(this,function(){_2.style(this._errorMessagePane,{display:""});})}).play();window.setTimeout(_2.hitch(this,this._handleCloseMsg),3000);},_handleCloseMsg:function(e){if(e){e.preventDefault();}_2.fadeOut({node:this._errorMessagePane,easing:_2.fx.easing.quadOut,onEnd:_2.hitch(this,function(){_2.style(this._errorMessagePane,{display:"none"});})}).play();},_handleUnionBtnCtrClick:function(){this._unionBtnCtr.set("checked",true);this._unionBtn.set("checked",true);this._handleUnionBtnClick();},_handleIntersectBtnCtrClick:function(){this._intersectBtnCtr.set("checked",true);this._intersectBtn.set("checked",true);this._handleIntersectBtnClick();},_handleEraseBtnCtrClick:function(){this._eraseBtnCtr.set("checked",true);this._eraseBtn.set("checked",true);this._handleEraseBtnClick();},_handleUnionBtnClick:function(_15){var _16=this.overlayFeatures[this._overlayFeaturesSelect.get("value")-1].name;this._outputLayerInput.set("value",_2.string.substitute(this.i18n.unionOutputLyrName,{layername:this.inputFeatures.name,overlayname:_16}));this._unionBtn.focus();this.set("OverlayType","union");},_handleEraseBtnClick:function(_17){var _18=this.overlayFeatures[this._overlayFeaturesSelect.get("value")-1].name;this._eraseBtn.focus();this._outputLayerInput.set("value",_2.string.substitute(this.i18n.eraseOutputLyrName,{layername:this.inputFeatures.name,overlayname:_18}));this.set("OverlayType","erase");},_handleIntersectBtnClick:function(_19){var _1a=this.overlayFeatures[this._overlayFeaturesSelect.get("value")-1].name;this._intersectBtn.focus();this._outputLayerInput.set("value",_2.string.substitute(this.i18n.intersectOutputLyrName,{layername:this.inputFeatures.name,overlayname:_1a}));this.set("OverlayType","intersect");},_setAnalysisGpServerAttr:function(url){this.analysisGpServer=url;this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);},_setInputFeaturesAttr:function(_1b){this.inputFeatures=_1b;},_setOverlayFeaturesAttr:function(_1c){this.overlayFeatures=_1c;},_setOverlayTypeAttr:function(_1d){this.overlayType=_1d;},_getOverlayTypeAttr:function(){return this.overlayType;},_setDisableRunAnalysisAttr:function(_1e){this._saveBtn.set("disabled",_1e);},_connect:function(_1f,evt,_20){this._pbConnects.push(_2.connect(_1f,evt,_20));},onSave:function(){},onClose:function(){}});});