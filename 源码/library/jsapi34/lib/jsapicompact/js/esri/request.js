/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/request",["dojo/_base/array","dojo/_base/config","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/url","dojo/_base/xhr","dojo/io/script","dojo/io/iframe","dojo/dom-construct","dojo/io-query","esri/kernel","esri/config","esri/sniff","esri/lang","esri/urlUtils","esri/deferredUtils"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){var _11;function _12(req,_13,_14,_15){var _16=false,_17=false;if(_e.isDefined(_13)){if(_4.isObject(_13)){_16=!!_13.useProxy;_17=!!_13.usePost;}else{_16=!!_13;}}req=_4.mixin({},req);if(req._ssl){req.url=req.url.replace(/^http:/i,"https:");}var _18=req.content,_19=req.url,_1a=_14&&req.form,_1b=_c.defaults.io;req.load=function(_1c){var err;if(_1c){if(_1c.error){err=_4.mixin(new Error(),_1c.error);err.log=_2.isDebug;}else{if(_1c.status==="error"){err=_4.mixin(new Error(),_1c);err.log=_2.isDebug;}}}return err||_1c;};req.error=function(_1d,io){if(io&&io.xhr){io.xhr.abort();}if(!(_1d instanceof Error)){_1d=_4.mixin(new Error(),_1d);}_1d.log=_2.isDebug;_1b.errorHandler(_1d,io);return _1d;};if(req._token){req.content=req.content||{};req.content.token=req._token;}var len=0;if(_18&&_19){len=_a.objectToQuery(_18).length+_19.length+1;}req.timeout=_e.isDefined(req.timeout)?req.timeout:_1b.timeout;req.handleAs=req.handleAs||"json";try{var _1e,_1f,_20=_f.canUseXhr(req.url)&&!(/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(req.url)),_21=(_f.hasSameOrigin(req.url,window.location.href)||_20),_22=(_17||_14||len>_1b.postLength)?true:false,_23=(!_21&&req.handleAs.indexOf("json")!==-1&&req.callbackParamName&&!_14)?true:false,_24=(!!_f.getProxyRule(req.url)||_1b.alwaysUseProxy||_16||((!_23||_22)&&!_21))?true:false;if(_14&&!_d("esri-file-upload")&&!_24&&_20){_24=true;}if(_24){_1e=_f.getProxyUrl(_19);_1f=_1e.path;if(_1e._xo){_20=true;}if(!_22&&(_1f.length+1+len)>_1b.postLength){_22=true;}req.url=_1f+"?"+_19;if(_22){req.content=_4.mixin(_1e.query||{},_18);}else{var _25=_a.objectToQuery(_4.mixin(_1e.query||{},_18));if(_25){req.url+=("?"+_25);}req.content=null;}}if(_23&&!_22){if(!_e.isDefined(req.isAsync)&&_d("ff")<4){req.isAsync=true;}return _7.get(_11?_11(req):req);}else{var _26=req.headers;if(_20&&(!_26||!_26.hasOwnProperty("X-Requested-With"))){_26=req.headers=(_26||{});_26["X-Requested-With"]=null;}if(_14){var _27=req.callbackParamName||"callback.html",_28=req.callbackElementName||"textarea",_29,_2a,_2b,i,il=_1a.elements?_1a.elements.length:0,el;_18=req.content;if(_18){for(_29 in _18){_2b=_18[_29];if(_e.isDefined(_2b)){_2a=null;for(i=0;i<il;i++){el=_1a.elements[i];if(el.name===_29){_2a=el;break;}}if(_2a){_2a.value=_2b;}else{if(_15){_1a.append(_29,_2b);}else{_1a.appendChild(_9.create("input",{type:"hidden",name:_29,value:_2b}));}}}}}if(_d("esri-file-upload")){_1.forEach(_1a.elements,function(el){if(el.name===_27){_1a.removeChild(el);}});req.contentType=false;req.postData=_15?_1a:new FormData(_1a);delete req.form;}else{_1a.enctype="multipart/form-data";if(_d("ie")<9){_1a.encoding="multipart/form-data";}_1a.method="post";if(!_1.some(_1a.elements,function(el){return el.name===_27;})){_1a.appendChild(_9.create("input",{type:"hidden",name:_27,value:_28}));}if(_19.toLowerCase().indexOf("addattachment")!==-1||_19.toLowerCase().indexOf("updateattachment")!==-1){req.url=_19+((_19.indexOf("?")===-1)?"?":"&")+_27+"="+_28;if(_24){req.url=_1f+"?"+req.url;}}delete req.content;}}req=_11?_11(req):req;if(_22){if(_14&&!_d("esri-file-upload")){return _8.send(req);}else{return _6.post(req);}}else{return _6.get(req);}}}catch(e){var dfd=new _3();dfd.errback(req.error(e));return dfd;}};function _2c(url){var _2d=_c.defaults.io,_2e=_2d._processedCorsServers,_2f=new _5(url),_30=-1;_2f=(_2f.host+(_2f.port?(":"+_2f.port):"")).toLowerCase();_30=_f.canUseXhr(url,true);if(_30>-1){_2d.corsEnabledServers.splice(_30,1);}_2e[_2f]=1;return _30;};function _31(url){var _32=_c.defaults.io,_33=_32._processedCorsServers;if(!_32.corsDetection){return;}try{var _34=new _5(url);_34=(_34.host+(_34.port?(":"+_34.port):"")).toLowerCase();if(_d("esri-cors")&&(url&&url.toLowerCase().indexOf("/rest/services")!==-1)&&(!_f.hasSameOrigin(url,window.location.href)&&!_f.canUseXhr(url))&&!_33[_34]){_33[_34]=-1;_6.get({url:url.substring(0,url.toLowerCase().indexOf("/rest/")+"/rest/".length)+"info",content:{f:"json"},failOk:true,handleAs:"json",headers:{"X-Requested-With":null}}).then(function(_35){if(_35){_33[_34]=2;if(!_f.canUseXhr(url)){_32.corsEnabledServers.push(_34);}}else{_33[_34]=1;}},function(_36){_33[_34]=1;});}}catch(e){console.log("esri._detectCors: an unknown error occurred while detecting CORS support");}};function _37(_38){_11=_38;};function _39(req,_3a){var dfd,_3b=req.form,_3c=_3a&&_3a.disableIdentityLookup,_3d=_3a&&_3a._preLookup,_3e=_3b&&_3b.append,_3f=_3b&&(_3b.elements?_1.some(_3b.elements,function(el){return el.type==="file";}):_3e),_40=(req.url.toLowerCase().indexOf("token=")!==-1||(req.content&&req.content.token)||(_3f&&_1.some(_3b.elements,function(el){return el.name==="token";})))?1:0;_31(req.url);if(req._usrDfd){dfd=req._usrDfd;}else{dfd=new _3(_10._dfdCanceller);dfd.addBoth(function(_41){if(_41&&(!_d("ie")||!_41.nodeType)){_41._ssl=req._ssl;}});var ld=req.load,_42=req.error;if(ld){dfd.addCallback(function(_43){var _44=dfd._pendingDfd,_45=_44&&_44.ioArgs,_46=_45&&_45.args;return ld.call(_46,_43,_45);});}if(_42){dfd.addErrback(function(_47){var _48=dfd._pendingDfd,_49=_48&&_48.ioArgs,_4a=_49&&_49.args;return _42.call(_4a,_47,_49);});}}if(_b.id&&!_40&&!req._token&&!_b.id._isPublic(req.url)&&(!_3c||_3d)){var _4b=_b.id.findCredential(req.url);if(_4b){req._token=_4b.token;req._ssl=_4b.ssl;}}dfd._pendingDfd=_12(req,_3a,_3f,_3e);if(!dfd._pendingDfd){dfd.ioArgs=dfd._pendingDfd&&dfd._pendingDfd.ioArgs;var err=new Error("Deferred object is missing");err.log=_2.isDebug;req._usrDfd=null;dfd.errback(err);dfd._pendingDfd=null;return dfd;}dfd._pendingDfd.addCallback(function(_4c){dfd.ioArgs=dfd._pendingDfd&&dfd._pendingDfd.ioArgs;req._usrDfd=null;dfd.callback(_4c);dfd._pendingDfd=null;}).addErrback(function(_4d){if(_4d&&_4d.code==403&&_4d.message&&_4d.message.toLowerCase().indexOf("ssl")>-1&&_4d.message.toLowerCase().indexOf("permission")===-1){if(!req._ssl){req._ssl=req._sslFromServer=true;req._usrDfd=dfd;_39(req,_3a);return;}}else{if(_4d&&_4d.status==415){var _4e=_2c(req.url);if(!req._err415){req._err415=1;req._usrDfd=dfd;_39(req,_3a);return;}}else{if(_b.id&&_1.indexOf(_b.id._errorCodes,_4d.code)!==-1&&!_b.id._isPublic(req.url)&&!_3c){dfd._pendingDfd=_b.id.getCredential(req.url,{token:req._token,error:_4d});dfd._pendingDfd.addCallback(function(_4f){req._token=_4f.token;req._usrDfd=dfd;req._ssl=req._sslFromServer||_4f.ssl;_39(req,_3a);}).addErrback(function(_50){req._usrDfd=null;dfd.errback(_50);dfd._pendingDfd=null;});return;}}}dfd.ioArgs=dfd._pendingDfd&&dfd._pendingDfd.ioArgs;req._usrDfd=null;dfd.errback(_4d);dfd._pendingDfd=null;});return dfd;};_39._request=_12;_39._disableCors=_2c;_39._detectCors=_31;_39.setRequestPreCallback=_37;if(_d("extend-esri")){_b.request=_39;_b._request=_12;_b._disableCors=_2c;_b._detectCors=_31;_b.setRequestPreCallback=_37;}return _39;});