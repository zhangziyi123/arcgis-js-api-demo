/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/layers/ArcGISImageServiceLayer",["dojo/_base/declare","dojo/_base/lang","dojo/_base/json","dojo/has","dojo/io-query","esri/kernel","esri/config","esri/lang","esri/request","esri/urlUtils","esri/geometry/Extent","esri/layers/DynamicMapServiceLayer","esri/layers/TimeInfo","esri/layers/Field"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){var _f=_1(_c,{declaredClass:"esri.layers.ArcGISImageServiceLayer",constructor:function(url,_10){this._url=_a.urlToObject(url);var _11=_10&&_10.imageServiceParameters;this.format=_11&&_11.format;this.interpolation=_11?_11.interpolation:null;this.compressionQuality=_11?_11.compressionQuality:null;this.bandIds=_11?_11.bandIds:null;this.mosaicRule=_11?_11.mosaicRule:null;this.renderingRule=_11?_11.renderingRule:null;this._params=_2.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},_11?_11.toJson():{});this._initLayer=_2.hitch(this,this._initLayer);this.useMapImage=(_10&&_10.useMapImage)||false;this._loadCallback=_10&&_10.loadCallback;var _12=_10&&_10.resourceInfo;if(_12){this._initLayer(_12);}else{_9({url:this._url.path,content:_2.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});}},disableClientCaching:false,_initLayer:function(_13,io){this._findCredential();var ssl=(this.credential&&this.credential.ssl)||(_13&&_13._ssl);if(ssl){this._useSSL();}var _14=this.minScale,_15=this.maxScale;_2.mixin(this,_13);this.minScale=_14;this.maxScale=_15;this.initialExtent=(this.fullExtent=this.extent=(new _b(_13.extent)));this.spatialReference=this.initialExtent.spatialReference;this.pixelSizeX=parseFloat(this.pixelSizeX);this.pixelSizeY=parseFloat(this.pixelSizeY);var i,il,_16=this.minValues,_17=this.maxValues,_18=this.meanValues,_19=this.stdvValues,bs=(this.bands=[]);for(i=0,il=this.bandCount;i<il;i++){bs[i]={min:_16[i],max:_17[i],mean:_18[i],stddev:_19[i]};}var _1a=this.timeInfo;this.timeInfo=(_1a&&_1a.timeExtent)?new _d(_1a):null;var _1b=this.fields=[];var _1c=_13.fields;if(_1c){for(i=0;i<_1c.length;i++){_1b.push(new _e(_1c[i]));}}this.version=_13.currentVersion;if(!this.version){var ver;if("fields" in _13||"objectIdField" in _13||"timeInfo" in _13){ver=10;}else{ver=9.3;}this.version=ver;}if(_8.isDefined(_13.minScale)&&!this._hasMin){this.setMinScale(_13.minScale);}if(_8.isDefined(_13.maxScale)&&!this._hasMax){this.setMaxScale(_13.maxScale);}this.loaded=true;this.onLoad(this);var _1d=this._loadCallback;if(_1d){delete this._loadCallback;_1d(this);}},getImageUrl:function(_1e,_1f,_20,_21){var sr=_1e.spatialReference.wkid||_3.toJson(_1e.spatialReference.toJson());delete this._params._ts;var _22=this._url.path+"/exportImage?";_2.mixin(this._params,{bbox:_1e.xmin+","+_1e.ymin+","+_1e.xmax+","+_1e.ymax,imageSR:sr,bboxSR:sr,size:_1f+","+_20},this.disableClientCaching?{_ts:new Date().getTime()}:{});var _23=(this._params.token=this._getToken()),_24=_a.addProxy(_22+_5.objectToQuery(_2.mixin(this._params,{f:"image"})));if((_24.length>_7.defaults.io.postLength)||this.useMapImage){this._jsonRequest=_9({url:_22,content:_2.mixin(this._params,{f:"json"}),callbackParamName:"callback",load:function(_25,io){var _26=_25.href;if(_23){_26+=(_26.indexOf("?")===-1?("?token="+_23):("&token="+_23));}_21(_a.addProxy(_26));},error:this._errorHandler});}else{_21(_24);}},setInterpolation:function(_27,_28){this.interpolation=(this._params.interpolation=_27);if(!_28){this.refresh(true);}},setCompressionQuality:function(_29,_2a){this.compressionQuality=(this._params.compressionQuality=_29);if(!_2a){this.refresh(true);}},setBandIds:function(ids,_2b){this.bandIds=ids;this._params.bandIds=ids.join(",");if(!_2b){this.refresh(true);}},setDefaultBandIds:function(_2c){this.bandIds=(this._params.bandIds=null);if(!_2c){this.refresh(true);}},setDisableClientCaching:function(_2d){this.disableClientCaching=_2d;},setMosaicRule:function(_2e,_2f){this.mosaicRule=_2e;this._params.mosaicRule=_3.toJson(_2e.toJson());if(!_2f){this.refresh(true);}},setRenderingRule:function(_30,_31){this.renderingRule=_30;this._params.renderingRule=_3.toJson(_30.toJson());if(!_31){this.refresh(true);}},setImageFormat:function(_32,_33){this.format=(this._params.format=_32);if(!_33){this.refresh(true);}},refresh:function(_34){if(_34){this.inherited(arguments);}else{var dc=this.disableClientCaching;this.disableClientCaching=true;this.inherited(arguments);this.disableClientCaching=dc;}},exportMapImage:function(_35,_36){var m=_7.defaults.map,p=_2.mixin({size:m.width+","+m.height},this._params,_35?_35.toJson(this.normalization):{},{f:"json"});delete p._ts;this._exportMapImage(this._url.path+"/exportImage",p,_36);}});if(_4("extend-esri")){_2.setObject("layers.ArcGISImageServiceLayer",_f,_6);}return _f;});