/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/layers/TiledMapServiceLayer",["dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojo/dom-class","dojo/dom-geometry","dojo/dom-style","dojox/collections/ArrayList","dojox/gfx/matrix","esri/kernel","esri/config","esri/sniff","esri/domUtils","esri/tileUtils","esri/geometry/Point","esri/geometry/Rect","esri/layers/layer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12){var _13=_c.defaults.map.zoomDuration;var _14=_1(_12,{declaredClass:"esri.layers.TiledMapServiceLayer",constructor:function(url,_15){_2.connect(this,"onLoad",this,"_initTiledLayer");this._displayLevels=_15?_15.displayLevels:null;var dh=_3.hitch;this._addImage=dh(this,this._addImage);this._tileLoadHandler=dh(this,this._tileLoadHandler);this._tileErrorHandler=dh(this,this._tileErrorHandler);this._tilePopPop=dh(this,this._tilePopPop);this._cleanUpRemovedImages=dh(this,this._cleanUpRemovedImages);this._fireOnUpdateEvent=dh(this,this._fireOnUpdateEvent);this._transitionEnd=dh(this,this._transitionEnd);},opacity:1,isPNG32:false,_initTiledLayer:function(){var ti=this.tileInfo,_16=ti.lods;this._tileW=ti.width;this._tileH=ti.height;var _17=(this.scales=[]),dl=this._displayLevels,_18=(this.declaredClass==="esri.layers.WMTSLayer"&&ti.dpi!=96),_19=-Infinity,_1a=Infinity,fe=this.fullExtent,ul=new _10(fe.xmin,fe.ymax),lr=new _10(fe.xmax,fe.ymin),_1b=_f.getContainingTileCoords,_1c,lod,i,len=_16.length;for(i=0;i<len;i++){lod=_16[i];if(_18){lod.scale=lod.scale*96/ti.dpi;}_1c=_1b(ti,ul,lod);lod.startTileRow=_1c.row<0?0:_1c.row;lod.startTileCol=_1c.col<0?0:_1c.col;_1c=_1b(ti,lr,lod);lod.endTileRow=_1c.row;lod.endTileCol=_1c.col;if(!dl||_4.indexOf(dl,lod.level)!==-1){_17[i]=lod.scale;_19=(lod.scale>_19)?lod.scale:_19;_1a=(lod.scale<_1a)?lod.scale:_1a;}}if(_18){ti.dpi=96;}if(_19!==-Infinity&&!this._hasMin){this.setMinScale(_19);}if(_1a!==Infinity&&!this._hasMax){this.setMaxScale(_1a);}this._patchIE=_d("ie")>=6&&_d("ie")<7&&(this.isPNG32||ti.format==="Mixed");},_isMapAtVisibleScale:function(){var _1d=this.inherited(arguments);if(_1d){var i,map=this._map,_1e=this.scales,_1f=map.getScale(),_20=false,_21=(map.width>map.height)?map.width:map.height;for(i=0;i<_1e.length;i++){if((Math.abs(_1e[i]-_1f)/_1e[i])<(1/_21)){_20=true;break;}}_1d=_20;}return _1d;},_setMap:function(map,_22,_23,lod){this.inherited(arguments);this._map=map;var d=(this._div=_5.create("div",null,_22)),_24=map.__visibleDelta,dc=_2.connect,_25=_b._css.names,css={position:"absolute",width:map.width+"px",height:map.height+"px",overflow:"visible"};if(map.navigationMode==="css-transforms"){css[_25.transform]=_b._css.translate(-_24.x,-_24.y);_8.set(d,css);delete css[_25.transform];css[_25.transition]=_25.transformName+" "+_13+"ms ease";_8.set((this._active=_5.create("div",null,d)),css);this._active._remove=0;this._passives=[];}else{css.left=-_24.x+"px";css.top=-_24.y+"px";_8.set(d,css);}this._onResizeHandler_connect=dc(map,"onResize",this,"_onResizeHandler");this._opacityChangeHandler_connect=dc(this,"onOpacityChange",this,"_opacityChangeHandler");var _26=this.tileInfo,sr=_26.spatialReference,_27=sr._getInfo();this._wrap=map.wrapAround180&&sr._isWrappable()&&Math.abs(_27.origin[0]-_26.origin.x)<=_27.dx;if(this._wrap){_f._addFrameInfo(_26,_27);}this.evaluateSuspension();if(this.suspended&&!map.loaded){var _28=_2.connect(map,"onLoad",this,function(){_2.disconnect(_28);_28=null;this.evaluateSuspension();});}return d;},_unsetMap:function(map,_29){if(!this.suspended){this._suspendImpl();}_5.destroy(this._div);this._map=this._div=null;var dd=_2.disconnect;dd(this._onResizeHandler_connect);dd(this._opacityChangeHandler_connect);this.inherited(arguments);},onSuspend:function(){this.inherited(arguments);this._suspendImpl();},_suspendImpl:function(){_e.hide(this._div);clearTimeout(this._wakeTimer);this._wakeTimer=null;this._disableDrawConnectors();var _2a=this._tiles,_2b=this._tileIds,_2c=this._loadingList,img,i,id,_2d=_2.disconnect,_2e=_5.destroy;if(_2c&&_2c.count>0){_2c.forEach(function(_2f){img=_2a[_2f];if(img){_2d(img._onload_connect);_2d(img._onerror_connect);_2d(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;}});_2c.clear();this._fireUpdateEnd();}this._removeList.clear();for(i=_2b.length-1;i>=0;i--){id=_2b[i];img=id&&_2a[id];if(img){_2e(img);}}if(this._map.navigationMode==="css-transforms"){var _30=this._active,_31=this._passives,_32;this._noDom=0;for(i=_31.length-1;i>=0;i--){_32=_31[i];if(_32._endHandle){_2d(_32._endHandle);}_32._matrix=_32._multiply=_32._endHandle=null;_32._marked=_32._remove=0;_31.splice(i,1);_2e(_32);}_30._matrix=_30._multiply=null;_30._marked=_30._remove=0;}this._tileIds=this._tiles=this._tileBounds=this._ct=this._loadingList=this._removeList=this._standby=null;},onResume:function(){this.inherited(arguments);this._tileIds=[];this._tiles=[];this._tileBounds=[];this._ct=null;this._removeList=new _9();this._loadingList=new _9();_e.show(this._div);this._enableDrawConnectors();this._wakeTimer=this._wakeTimer||setTimeout(_3.hitch(this,function(){if(!this.suspended){this._onExtentChangeHandler(this._map.extent,null,true,this._map.__LOD);}}),0);},_enableDrawConnectors:function(){var map=this._map,_33=_2.connect;if(map.navigationMode==="css-transforms"){this._onScaleHandler_connect=_33(map,"onScale",this,this._onScaleHandler);if(_d("esri-touch")||_d("esri-pointer")){this._standby=[];var _34=this,_35=function(){_34._noDom=1;};this._onPanStartHandler_connect=_33(map,"onPanStart",_35);this._onZoomStartHandler_connect=_33(map,"onZoomStart",_35);}}else{this._onZoomHandler_connect=_33(map,"onZoom",this,"_onZoomHandler");}this._onPanHandler_connect=_33(map,"onPan",this,"_onPanHandler");this._onExtentChangeHandler_connect=_33(map,"onExtentChange",this,"_onExtentChangeHandler");},_disableDrawConnectors:function(){var _36=_2.disconnect;_36(this._onPanHandler_connect);_36(this._onZoomHandler_connect);_36(this._onScaleHandler_connect);_36(this._onExtentChangeHandler_connect);_36(this._onPanStartHandler_connect);_36(this._onZoomStartHandler_connect);this._onPanHandler_connect=this._onZoomHandler_connect=this._onScaleHandler_connect=this._onExtentChangeHandler_connect=this._onPanStartHandler_connect=this._onZoomStartHandler_connect=null;},_onResizeHandler:function(_37,_38,_39){var css={width:_38+"px",height:_39+"px"},ds=_8.set,i;ds(this._div,css);if(this._map.navigationMode==="css-transforms"){if(this._active){ds(this._active,css);}for(i=this._passives.length-1;i>=0;i--){ds(this._passives[i],css);}}},_onExtentChangeHandler:function(_3a,_3b,_3c,lod){var map=this._map,i,_3d=this._standby,img,_3e;clearTimeout(this._wakeTimer);this._wakeTimer=null;if(map._isPanningOrZooming()){return;}if(map.navigationMode==="css-transforms"){if(_3c){for(i=this._passives.length-1;i>=0;i--){_3e=this._passives[i];_8.set(_3e,_b._css.names.transition,"none");if(_3e._marked){this._passives.splice(i,1);if(_3e.parentNode){_3e.parentNode.removeChild(_3e);}_5.destroy(_3e);}else{if(_3e.childNodes.length>0){_3e._multiply=_3e._multiply?_a.multiply(_3e._matrix,_3e._multiply):_3e._matrix;}}}}this._noDom=0;if(_3d&&_3d.length){for(i=_3d.length-1;i>=0;i--){img=_3d[i];_8.set(img,"visibility","visible");this._tilePopPop(img);_3d.splice(i,1);}}}this._fireUpdateStart();this._rrIndex=0;var ct=_f.getCandidateTileInfo(map,this.tileInfo,_3a),mv=map.__visibleDelta,id;if(!this._ct||ct.lod.level!==this._ct.lod.level||_3c){var _3f=(ct&&this._ct&&ct.lod.level!==this._ct.lod.level);this._ct=ct;var _40=this._tiles,_41=this._tileIds,_42=this._tileBounds,_43=this._removeList,_44,il=_41.length;this._cleanUpRemovedImages();for(i=0;i<il;i++){id=_41[i];_44=_40[id];_42[id]=_41[i]=null;if((map.navigationMode==="css-transforms")&&_3f&&_44.parentNode&&map.fadeOnZoom){_44._fadeOut=_3f;_44.parentNode._remove++;}_43.add(_44);}if(_3c){this._tileIds=[];this._tiles=[];this._tileBounds=[];}}var mx=mv.x,my=mv.y;if(map.navigationMode==="css-transforms"){var css={};css[_b._css.names.transform]=_b._css.translate(mx,my);_8.set(this._div,css);}else{_8.set(this._div,{left:mx+"px",top:my+"px"});}this.__coords_dx=mx;this.__coords_dy=my;this._updateImages(new _11(0,0,mv.width,mv.height));if(this._loadingList.count===0){this.onUpdate();this._fireUpdateEnd();}else{this._fireOnUpdate=true;}var _45,_46,_47=this._tileW,_48=this._tileH;mv=new _11(-mv.x,-mv.y,mv.width,mv.height);for(i=this._tileIds.length-1;i>=0;i--){id=this._tileIds[i];if(id){img=this._tiles[id];_45=_7.getMarginBox(img);_46=new _11(_45.l,_45.t,_47,_48);if(map.navigationMode==="css-transforms"){_46.x=img._left;_46.y=img._top;}if(mv.intersects(_46)){this._tileBounds[id]=_46;}else{if(this._loadingList.contains(id)){this._tilePopPop(img);}_5.destroy(img);this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}else{this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}},_onPanHandler:function(_49,_4a){var map=this._map,mv=map.__visibleDelta.offset(_4a.x,_4a.y);this.__coords_dx=this.__coords_dy=0;if(map.navigationMode==="css-transforms"){var css={};css[_b._css.names.transform]=_b._css.translate(mv.x,mv.y);_8.set(this._div,css);if(!_d("esri-touch")&&!_d("esri-pointer")){this._updateImages({x:-mv.x,y:-mv.y,width:mv.width,height:mv.height});}}else{_8.set(this._div,{left:mv.x+"px",top:mv.y+"px"});this._updateImages({x:-mv.x,y:-mv.y,width:mv.width,height:mv.height});}if(this._loadingList.count>0){this._fireUpdateStart();this._fireOnUpdate=true;}},_onScaleHandler:function(mtx,_4b){var i,css={},_4c=_b._css.names,map=this._map;for(i=this._passives.length-1;i>=0;i--){var _4d=this._passives[i];if(_4d.childNodes.length===0){this._passives.splice(i,1);_5.destroy(_4d);}else{if(_4d.style[_4c.transition]==="none"){_8.set(_4d,_4c.transition,_4c.transformName+" "+_13+"ms ease");}_8.set(_4d,_4c.transition,_4b?"none":(_4c.transformName+" "+_13+"ms ease"));_4d._matrix=mtx;css[_4c.transform]=_b._css.matrix(_4d._multiply?_a.multiply(mtx,_4d._multiply):mtx);_8.set(_4d,css);}}if(this._active&&this._active.childNodes.length===0){return;}_8.set(this._active,_4c.transition,_4b?"none":(_4c.transformName+" "+_13+"ms ease"));this._active._matrix=mtx;css[_4c.transform]=_b._css.matrix(this._active._matrix);_8.set(this._active,css);this._passives.push(this._active);css={position:"absolute",width:map.width+"px",height:map.height+"px",overflow:"visible"};css[_4c.transition]=_4c.transformName+" "+_13+"ms ease";_8.set((this._active=_5.create("div",null,this._div)),css);this._active._remove=0;if(map.fadeOnZoom){_5.place(this._active,this._div,"first");}},_onZoomHandler:function(_4e,_4f,_50){var _51=_7.getMarginBox(this._div);_50=_50.offset(-_51.l,-_51.t);var _52,_53=this._tileW*_4f,_54=this._tileH*_4f,_55=this._tileBounds,_56=this._tiles,es=_8.set;var _57=_d("ie");if(_57&&_57<8){_4.forEach(this._tileIds,function(id){_52=_55[id];es(_56[id],{left:(_52.x-((_53-_52.width)*(_50.x-_52.x)/_52.width))+"px",top:(_52.y-((_54-_52.height)*(_50.y-_52.y)/_52.height))+"px",zoom:_4f});});}else{_4.forEach(this._tileIds,function(id){_52=_55[id];es(_56[id],{left:(_52.x-((_53-_52.width)*(_50.x-_52.x)/_52.width))+"px",top:(_52.y-((_54-_52.height)*(_50.y-_52.y)/_52.height))+"px",width:_53+"px",height:_54+"px"});});}},_updateImages:function(_58){if(!this._ct){return;}var id,_59=this._tileW,_5a=this._tileH,_5b=this._ct,lod=_5b.lod,_5c=_5b.tile,off=_5c.offsets,_5d=_5c.coords,cr=_5d.row,cc=_5d.col,_5e=lod.level,_5f=this.opacity,_60=this._tileIds,_61=this._loadingList,_62=this._addImage,mId=this._map.id,tId=this.id,rx=_58.x,ry=_58.y,str=lod.startTileRow,etr=lod.endTileRow,stc=lod.startTileCol,etc=lod.endTileCol,_63=_4.indexOf,r,c,mvx=-_58.x,mvy=-_58.y,_64=off.x-this.__coords_dx,_65=off.y-this.__coords_dy,vx=((_59-_64)+mvx),vy=((_5a-_65)+mvy),_66=Math.ceil,_67=(vx>0)?(vx%_59):((_59-(Math.abs(vx)%_59))),_68=(vy>0)?(vy%_5a):((_5a-(Math.abs(vy)%_5a))),_69=(rx>0)?Math.floor((rx+_64)/_59):_66((rx-(_59-_64))/_59),_6a=(ry>0)?Math.floor((ry+_65)/_5a):_66((ry-(_5a-_65))/_5a),_6b=_69+_66((_58.width-_67)/_59),_6c=_6a+_66((_58.height-_68)/_5a),_6d,_6e,_6f,_70,col,row;if(this._wrap){_6d=lod._frameInfo;_6e=_6d[0];_6f=_6d[1];_70=_6d[2];}for(col=_69;col<=_6b;col++){for(row=_6a;row<=_6c;row++){r=cr+row;c=cc+col;if(this._wrap){if(c<_6f){c=c%_6e;c=c<_6f?c+_6e:c;}else{if(c>_70){c=c%_6e;}}}if(r>=str&&r<=etr&&c>=stc&&c<=etc){id=mId+"_"+tId+"_tile_"+_5e+"_"+row+"_"+col;if(_63(_60,id)===-1){_61.add(id);_60.push(id);_62(_5e,row,r,col,c,id,_59,_5a,_5f,_5c,off);}}}}},_cleanUpRemovedImages:function(){var _71=this._removeList,dd=_5.destroy,i,_72=_b._css.names;_71.forEach(function(img){if(!img._fadeOut){img.style.filter="";img.style.zoom=1;dd(img);}});if(this._map.navigationMode==="css-transforms"){for(i=this._passives.length-1;i>=0;i--){var _73=this._passives[i];if(_73.childNodes.length===0){this._passives.splice(i,1);dd(_73);}else{if(this._map.fadeOnZoom&&!_73._marked&&(_73._remove===_73.childNodes.length)){_8.set(_73,_72.transition,"opacity 0.65s");_8.set(_73,"opacity",0);_73._marked=1;if(_d("ie")>=10){_73.addEventListener(_72.endEvent,this._transitionEnd,false);}else{_73._endHandle=_2.connect(_73,_72.endEvent,this._transitionEnd);}}}}}_71.clear();},_transitionEnd:function(evt){var _74=evt.target,idx;if(evt.propertyName!=="opacity"){return;}if(_d("ie")>=10){_74.removeEventListener(_b._css.names.endEvent,this._transitionEnd,false);}else{_2.disconnect(_74._endHandle);_74._endHandle=null;}idx=_4.indexOf(this._passives,_74);if(idx>-1){this._passives.splice(idx,1);}if(_74.parentNode){_74.parentNode.removeChild(_74);}_5.destroy(_74);},_addImage:function(_75,row,r,col,c,id,_76,_77,_78,_79,_7a){if(this._patchIE){var div=(this._tiles[id]=_5.create("div"));div.id=id;_6.add(div,"layerTile");_8.set(div,{left:((_76*col)-_7a.x)+"px",top:((_77*row)-_7a.y)+"px",width:_76+"px",height:_77+"px",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+this.getTileUrl(_75,r,c)+"', sizingMethod='scale')"});if(_78<1){_8.set(div,"opacity",_78);}var _7b=div.appendChild(_5.create("div"));_8.set(_7b,{opacity:0,width:_76+"px",height:_77+"px"});this._div.appendChild(div);div=null;this._loadingList.remove(id);this._fireOnUpdateEvent();}else{var img=(this._tiles[id]=_5.create("img")),dc=_2.connect;img.id=id;_6.add(img,"layerTile");var _7c=(_76*col)-_7a.x,top=(_77*row)-_7a.y,map=this._map,_7d=_b._css.names,css={width:_76+"px",height:_77+"px",visibility:"hidden"};if(map.navigationMode==="css-transforms"){css[_7d.transform]=_b._css.translate(_7c,top);_8.set(img,css);img._left=_7c;img._top=top;}else{css.left=_7c+"px";css.top=top+"px";_8.set(img,css);}if(_78<1){_8.set(img,"opacity",_78);}img._onload_connect=dc(img,"onload",this,"_tileLoadHandler");img._onerror_connect=dc(img,"onerror",this,"_tileErrorHandler");img._onabort_connect=dc(img,"onabort",this,"_tileErrorHandler");var url=this.getTileUrl(_75,r,c,img);if(url){img.src=url;}if(map.navigationMode==="css-transforms"){this._active.appendChild(img);}else{this._div.appendChild(img);}img=null;}},getTileUrl:function(_7e,row,col){},refresh:function(){if(!this.suspended){this._onExtentChangeHandler(this._map.extent,null,true,this._map.__LOD);}},_tilePopPop:function(img){var dd=_2.disconnect;dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;this._loadingList.remove(img.id);this._fireOnUpdateEvent();},_tileLoadHandler:function(evt){var img=evt.currentTarget;if(this._noDom){this._standby.push(img);return;}_8.set(img,"visibility","visible");this._tilePopPop(img);},_tileErrorHandler:function(evt){var img=evt.currentTarget;this.onError(new Error("Unable to load tile: "+img.src));_8.set(img,"visibility","hidden");this._tilePopPop(img);},_fireOnUpdateEvent:function(){if(this._loadingList.count===0){this._cleanUpRemovedImages();if(this._fireOnUpdate){this._fireOnUpdate=false;this.onUpdate();this._fireUpdateEnd();}}},setOpacity:function(o){if(this.opacity!=o){this.onOpacityChange(this.opacity=o);}},onOpacityChange:function(){},_opacityChangeHandler:function(_7f){var djs=_8.set,i,j,_80;if(this._map.navigationMode==="css-transforms"){if(this._active){_80=this._active.childNodes;for(i=_80.length-1;i>=0;i--){djs(_80[i],"opacity",_7f);}}for(i=this._passives.length-1;i>=0;i--){_80=this._passives[i].childNodes;for(j=_80.length-1;j>=0;j--){djs(_80[j],"opacity",_7f);}}return;}_80=this._div.childNodes;for(i=_80.length-1;i>=0;i--){djs(_80[i],"opacity",_7f);}}});if(_d("extend-esri")){_3.setObject("layers.TiledMapServiceLayer",_14,_b);}return _14;});