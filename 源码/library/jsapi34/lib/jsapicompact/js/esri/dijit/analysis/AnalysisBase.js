/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/analysis/AnalysisBase",["dijit","dojo","dojox","dojo/require!esri/tasks/gp,esri/utils,esri/dijit/analysis/utils,esri/IdentityManager"],function(_1,_2,_3){_2.provide("esri.dijit.analysis.AnalysisBase");_2.require("esri.tasks.gp");_2.require("esri.utils");_2.require("esri.dijit.analysis.utils");_2.require("esri.IdentityManager");_2.declare("esri.dijit.analysis.AnalysisBase",null,{analysisGpServer:null,isOutputLayerItemUpdated:false,toolName:null,jobParams:null,itemParams:null,gp:null,resultParameter:null,_jobInfo:null,_popupInfo:null,_toolServiceUrl:null,constructor:function(){this.isOutputLayerItemUpdated=false;},execute:function(_4){this.jobParams=_4.jobParams;this.itemParams=_4.itemParams;this._checkUser();},_checkUser:function(){esri.id.getCredential(this._toolServiceUrl).then(_2.hitch(this,function(_5){var _6=_5.userId;var _7=esri.id.findServerInfo(this._toolServiceUrl);var _8=_7.owningSystemUrl;if(_6){var _9=_8+"/sharing/community/users/"+_6;esri.request({url:_9,"content":{token:_5.token,f:"json"}}).then(_2.hitch(this,this._handleUserProfileResponse),function(_a){this.onJobFailed({message:"error getting user response",jobParams:this.jobParams});});}}),function(_b){});},_handleUserProfileResponse:function(_c){if(!_c.accountId){this.onJobFailed({message:this.i18n.orgUsrMsg,jobParams:this.jobParams});return;}if(_c.role==="account_admin"||_c.role==="account_publisher"){this._checkServiceName(_c.accountId);}else{this.onJobFailed({message:this.i18n.pubRoleMsg,jobParams:this.jobParams});return;}},_checkServiceName:function(_d){var _e=esri.id.findServerInfo(this._toolServiceUrl);var _f=_e.owningSystemUrl;var _10=esri.id.findCredential(this._toolServiceUrl);var url=_f+"/sharing/portals/"+_d+"/isServiceNameAvailable";var _11=_2.fromJson(this.jobParams.OutputName);var _12={name:_11.serviceProperties["name"],type:"Feature Service",token:_10.token,f:"json"};esri.request({"url":url,"content":_12}).then(_2.hitch(this,function(_13){if(_13.available){this._createService();this.onExecute(this.jobParams);}else{this.onJobFailed({message:this.i18n.servNameExists,type:"warning",jobParams:this.jobParams});}}),_2.hitch(this,function(_14){this.onJobFailed({message:"error getting service name checked",jobParams:this.jobParams});}));},_createService:function(){esri.id.getCredential(this._toolServiceUrl).then(_2.hitch(this,function(_15){var _16=_15.userId;var _17=esri.id.findServerInfo(this._toolServiceUrl);var _18=_17.owningSystemUrl;var _19=_2.fromJson(this.jobParams.OutputName);if(_16){var url=_18+"/sharing/content/users/"+_16+"/createService";var _1a={"createParameters":_2.toJson({"currentVersion":10.2,"serviceDescription":"","hasVersionedData":false,"supportsDisconnectedEditing":false,"hasStaticData":true,"maxRecordCount":2000,"supportedQueryFormats":"JSON","capabilities":"Query","description":"","copyrightText":"","allowGeometryUpdates":false,"units":"esriMeters","syncEnabled":false,"editorTrackingInfo":{"enableEditorTracking":false,"enableOwnershipAccessControl":false,"allowOthersToUpdate":true,"allowOthersToDelete":true},"xssPreventionInfo":{"xssPreventionEnabled":true,"xssPreventionRule":"InputOnly","xssInputRule":"rejectInvalid"},"tables":[],"name":_19.serviceProperties["name"]}),"outputType":"featureService",f:"json"};esri.request({"url":url,"content":_1a},{"usePost":true}).then(_2.hitch(this,this._submitGpJob),_2.hitch(this,this._handleCreateServiceError));}}),function(_1b){});},_handleCreateServiceError:function(_1c){this.onJobFailed(_1c);},_submitGpJob:function(_1d){this.currentGpItemId=_1d.itemId;var _1e=_2.fromJson(this.jobParams.OutputName);_1e.itemProperties={itemId:_1d.itemId};this.jobParams.OutputName=_2.toJson(_1e);this.gp.setUpdateDelay(3000);this.gp.submitJob(this.jobParams,_2.hitch(this,this._gpJobComplete),_2.hitch(this,this._gpJobStatus),_2.hitch(this,this._gpJobFailed));this.onJobSubmit(this.jobParams);},_updateItem:function(){var _1f=esri.id.findServerInfo(this._toolServiceUrl);portalUrl=_1f.owningSystemUrl;var _20=esri.id.findCredential(this._toolServiceUrl);var _21=_20.userId;if(_21){var url=portalUrl+"/sharing/content/users/"+_21+"/items/"+this.currentGpItemId+"/update";this.itemParams.tags=this.itemParams.tags;this.itemParams.typeKeywords="jobUrl:"+this._toolServiceUrl+"/jobs/"+this._jobInfo.jobId;var _22=_2.mixin({f:"json"},this.itemParams);var _23={};var _24;var _25={};for(_24 in this.jobParams){if(typeof this.jobParams[_24]==="string"&&(this.jobParams[_24].search(/[\{\}\[\]]/g)!==-1)){_25[_24]=_2.fromJson(this.jobParams[_24]);}else{_25[_24]=this.jobParams[_24];}}_23.analysisInfo={toolName:this.toolName,jobParams:_25};if(this._popupInfo){_23.layers=[{"id":0,"popupInfo":this._popupInfo}];}_22.text=_2.toJson(_23);esri.request({"url":url,"content":_22},{"usePost":true}).then(_2.hitch(this,this._handleItemUpdate),_2.hitch(this,this._handleUpdateItemError));}},_handleItemUpdate:function(_26){this.isOutputLayerItemUpdated=true;},_handleItemDataUpdate:function(_27){},_handleUpdateItemError:function(_28){this.isOutputLayerItemUpdated=true;},_handleErrorResponse:function(msg){this.onJobFailed(msg);},_gpJobStatus:function(_29){_29.jobParams=this.jobParams;this.onJobStatus(_29);this._jobInfo=_29;if(!this.isOutputLayerItemUpdated){this._updateItem();}var _2a="";switch(_29.jobStatus){case "esriJobSubmitted":_2a="Submitted...";break;case "esriJobExecuting":_2a="Executing...";break;case "esriJobSucceeded":break;}},_gpJobComplete:function(_2b){if(_2b.jobStatus!=="esriJobFailed"){_2b.jobParams=this.jobParams;this.onJobSuccess(_2b);this.gp.getResultData(_2b.jobId,this.resultParameter).then(_2.hitch(this,function(_2c){if(!_2c.value.url){esri.id.getCredential(this._toolServiceUrl).then(_2.hitch(this,function(_2d){var _2e=_2d.userId;var _2f=esri.id.findServerInfo(this._toolServiceUrl);var _30=_2f.owningSystemUrl;if(_2e){var url=_30+"/sharing/content/users/"+_2e+"/items/"+this.currentGpItemId+"/delete";esri.request({"url":url,"content":{f:"json"}},{"usePost":true}).then(_2.hitch(this,this._handleItemDelete),_2.hitch(this,this._handleDeleteItemError));}}),function(_31){});this.onJobFailed({message:this.i18n.emptyResultInfoMsg,type:"warning",jobParams:this.jobParams});}else{_2c.outputLayerName=_2.fromJson(this.jobParams.OutputName).serviceProperties.name;_2c.value["itemId"]=this.currentGpItemId;_2c.analysisInfo={toolName:this.toolName,jobParams:this.jobParams};if(_2c.value.layerInfo&&_2c.value.layerInfo.popupInfo){this._popupInfo=_2c.value.layerInfo.popupInfo;}this._updateItem();this.onJobResult(_2c);}}));}},_gpJobFailed:function(_32){var _33=_2.clone(_32);_33.jobParams=this.jobParams;this.onJobFailed(_32);},cancel:function(_34){this.gp.cancelJob(_34.jobId).then(_2.hitch(this,function(_35){if(_35.jobStatus==="esriJobCancelled"){esri.id.getCredential(this._toolServiceUrl).then(_2.hitch(this,function(_36){var _37=_36.userId;var _38=esri.id.findServerInfo(this._toolServiceUrl);var _39=_38.owningSystemUrl;if(_37){var url=_39+"/sharing/content/users/"+_37+"/items/"+this.currentGpItemId+"/delete";esri.request({"url":url,"content":{f:"json"}},{"usePost":true}).then(_2.hitch(this,this._handleItemDelete),_2.hitch(this,this._handleDeleteItemError));}}),function(_3a){});}}),function(_3b){});},_handleItemDelete:function(_3c){this.onJobCancel(_3c);},_handleDeleteItemError:function(_3d){this.onJobFailed(_3d);},_setToolServiceUrlAttr:function(_3e){this._toolServiceUrl=_3e;this.gp=new esri.tasks.Geoprocessor(this._toolServiceUrl);},onExecute:function(_3f){},onJobSubmit:function(_40){},onJobStatus:function(_41){},onJobSuccess:function(_42){},onJobResult:function(_43){},onJobFailed:function(_44){},onJobComplete:function(_45){},onJobCancel:function(_46){},onSave:function(){},onClose:function(){}});});